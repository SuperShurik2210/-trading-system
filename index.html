<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KATE | 勝て</title>
  <style>
    :root {
      --bg-primary: #09090B;
      --bg-surface: #13111C;
      --bg-input: #1E1A2E;
      --border: #27272A;
      --text-primary: #FFFFFF;
      --text-secondary: #A1A1AA;
      --text-tertiary: #71717A;
      --accent-primary: #8B5CF6;
      --accent-secondary: #A78BFA;
      --accent-success: #22C55E;
      --accent-danger: #EF4444;
      --accent-warning: #F59E0B;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container { max-width: 1536px; margin: 0 auto; padding: 32px 40px; }

    @media (max-width: 768px) {
      .container { padding: 16px 20px; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .page-header { display: flex; justify-content: space-between; align-items: center; }
    .reload-wrap {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .reload-btn {
      width: 48px;
      height: 48px;
      background: #111113;
      border: 1px solid #2A2A2E;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      padding: 12px;
    }
    .reload-btn:hover {
      border-color: var(--accent-success);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    .reload-bar {
      height: 5px;
      border-radius: 3px;
      background: var(--accent-success);
      animation: bar-grow 1.5s ease-in-out infinite;
    }
    .reload-bar:nth-child(1) {
      width: 22px;
      opacity: 1;
      animation-delay: 0s;
    }
    .reload-bar:nth-child(2) {
      width: 17px;
      opacity: 0.7;
      animation-delay: 0.15s;
    }
    .reload-bar:nth-child(3) {
      width: 12px;
      opacity: 0.4;
      animation-delay: 0.3s;
    }
    @keyframes bar-grow {
      0%, 100% {
        transform: scaleX(1);
      }
      50% {
        transform: scaleX(1.2);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
      }
    }
    .reload-btn:active {
      transform: scale(0.95);
    }
    .reload-label {
      position: absolute;
      bottom: -20px;
      font-size: 10px;
      font-weight: 600;
      color: var(--accent-success);
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.2s;
    }
    .reload-wrap:hover .reload-label {
      opacity: 1;
      transform: translateY(0);
    }

    /* Save All Button */
    .save-all-btn {
      width: 40px;
      height: 40px;
      background: #111113;
      border: 1px solid #22C55E;
      border-radius: 10px;
      color: #22C55E;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .save-all-btn:hover {
      background: rgba(34, 197, 94, 0.15);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);
    }
    .save-all-btn:active {
      transform: scale(0.95);
    }
    .save-all-btn svg {
      flex-shrink: 0;
    }
    .save-all-btn span {
      display: none;
    }

    /* Version History Button */
    .version-btn {
      width: 40px;
      height: 40px;
      background: #1a1a22;
      border: 1px solid #27272A;
      border-radius: 10px;
      color: #A1A1AA;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .version-btn:hover {
      border-color: #3B82F6;
      color: #3B82F6;
      background: rgba(59, 130, 246, 0.1);
    }

    /* Toast Notification */
    .save-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 1px solid #22C55E;
      border-radius: 16px;
      padding: 20px 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 20px rgba(34, 197, 94, 0.2);
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 360px;
    }
    .save-toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    .save-toast-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .save-toast-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #22C55E, #16A34A);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .save-toast-title {
      font-size: 16px;
      font-weight: 700;
      color: #22C55E;
    }
    .save-toast-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .save-toast-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: #A1A1AA;
    }
    .save-toast-item-icon {
      color: #22C55E;
      font-size: 14px;
    }
    .save-toast-item-text {
      flex: 1;
    }
    .save-toast-item-status {
      color: #22C55E;
      font-weight: 600;
    }
    .save-toast-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #71717A;
      font-size: 18px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .save-toast-close:hover {
      color: #fff;
    }

    /* Version History Panel */
    .version-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(180deg, #0f0f14, #0a0a0f);
      border-left: 1px solid #27272A;
      z-index: 10001;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .version-panel.open {
      right: 0;
    }
    .version-panel-header {
      padding: 20px;
      border-bottom: 1px solid #27272A;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .version-panel-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .version-panel-close {
      background: none;
      border: none;
      color: #71717A;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s;
    }
    .version-panel-close:hover {
      color: #fff;
    }
    .version-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .version-item {
      padding: 16px;
      background: #1a1a22;
      border: 1px solid #27272A;
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .version-item:hover {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }
    .version-item-date {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
    }
    .version-item-info {
      font-size: 12px;
      color: #71717A;
      display: flex;
      gap: 12px;
    }
    .version-item-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .version-empty {
      text-align: center;
      padding: 40px 20px;
      color: #71717A;
    }
    .version-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .version-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .version-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .version-panel-footer {
      padding: 16px;
      border-top: 1px solid #27272A;
    }
    .version-download-btn,
    .version-import-btn {
      flex: 1;
      padding: 12px;
      background: #1a1a22;
      border: 1px solid #27272A;
      border-radius: 10px;
      color: #A1A1AA;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .version-download-btn:hover {
      border-color: #22C55E;
      color: #22C55E;
      background: rgba(34, 197, 94, 0.1);
    }
    .version-import-btn:hover {
      border-color: #3B82F6;
      color: #3B82F6;
      background: rgba(59, 130, 246, 0.1);
    }

    /* Logout Button */
    .logout-btn {
      width: 40px;
      height: 40px;
      background: #111113;
      border: 1px solid #2A2A2E;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logout-btn:hover {
      border-color: #EF4444;
      background: rgba(239, 68, 68, 0.1);
    }
    .logout-icon {
      font-size: 18px;
      color: #71717A;
      transition: color 0.2s;
    }
    .logout-btn:hover .logout-icon {
      color: #EF4444;
    }

    /* Custom Modal with Animations */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
      animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal-overlay.closing {
      animation: modalFadeOut 0.2s ease forwards;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes modalFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .modal-box {
      background: linear-gradient(180deg, #141418 0%, #0D0D10 100%);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 20px;
      padding: 28px;
      max-width: 420px;
      width: 90%;
      position: relative;
      overflow: hidden;
      box-shadow:
        0 0 0 1px rgba(139, 92, 246, 0.1),
        0 25px 80px rgba(0, 0, 0, 0.6),
        0 0 60px rgba(139, 92, 246, 0.15);
    }
    .modal-overlay.active .modal-box {
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal-overlay.closing .modal-box {
      animation: modalSlideOut 0.2s ease forwards;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    @keyframes modalSlideOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
    }
    /* Shimmer effect on modal */
    .modal-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent,
        rgba(139, 92, 246, 0.05),
        transparent);
      animation: modalShimmer 2s ease-in-out;
    }
    @keyframes modalShimmer {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }
    /* Glow border animation */
    .modal-box::after {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      border-radius: 21px;
      background: linear-gradient(135deg,
        rgba(139, 92, 246, 0.4),
        transparent 40%,
        transparent 60%,
        rgba(139, 92, 246, 0.2));
      z-index: -1;
      opacity: 0;
      animation: glowPulse 2s ease-in-out infinite;
      animation-delay: 0.5s;
    }
    @keyframes glowPulse {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .modal-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-bottom: 20px;
      position: relative;
      animation: iconBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
    }
    @keyframes iconBounce {
      from {
        opacity: 0;
        transform: scale(0.5) rotate(-10deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }
    .modal-icon::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), transparent);
      z-index: -1;
      opacity: 0;
      animation: iconGlow 1.5s ease-in-out infinite;
      animation-delay: 0.7s;
    }
    @keyframes iconGlow {
      0%, 100% { opacity: 0; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.05); }
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #FFFFFF;
      margin-bottom: 8px;
      animation: textFadeIn 0.4s ease 0.15s both;
    }
    .modal-message {
      font-size: 14px;
      color: #8B8B90;
      line-height: 1.6;
      margin-bottom: 24px;
      animation: textFadeIn 0.4s ease 0.2s both;
    }
    @keyframes textFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-input {
      width: 100%;
      padding: 14px 18px;
      background: rgba(20, 20, 24, 0.8);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      color: #FFFFFF;
      font-size: 15px;
      outline: none;
      margin-bottom: 24px;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      animation: inputSlideIn 0.4s ease 0.25s both;
    }
    @keyframes inputSlideIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-input::placeholder {
      color: #5A5A5D;
    }
    .modal-input:focus {
      border-color: rgba(139, 92, 246, 0.6);
      background: rgba(139, 92, 246, 0.05);
      box-shadow:
        0 0 0 3px rgba(139, 92, 246, 0.15),
        0 0 20px rgba(139, 92, 246, 0.1);
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      animation: buttonsSlideIn 0.4s ease 0.3s both;
    }
    @keyframes buttonsSlideIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      border: none;
      position: relative;
      overflow: hidden;
    }
    .modal-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    .modal-btn:active::before {
      width: 200px;
      height: 200px;
    }
    .modal-btn-cancel {
      background: rgba(30, 30, 35, 0.8);
      color: #ADADB0;
      border: 1px solid rgba(60, 60, 70, 0.5);
    }
    .modal-btn-cancel:hover {
      background: rgba(50, 50, 60, 0.8);
      color: #FFFFFF;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-btn-confirm {
      background: linear-gradient(135deg, #EF4444, #DC2626);
      color: #FFFFFF;
    }
    .modal-btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow:
        0 5px 25px rgba(239, 68, 68, 0.4),
        0 0 40px rgba(239, 68, 68, 0.2);
    }
    .modal-btn-confirm.success {
      background: linear-gradient(135deg, #22C55E, #16A34A);
    }
    .modal-btn-confirm.success:hover {
      box-shadow:
        0 5px 25px rgba(34, 197, 94, 0.4),
        0 0 40px rgba(34, 197, 94, 0.2);
    }
    .modal-btn-confirm.primary {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    }
    .modal-btn-confirm.primary:hover {
      box-shadow:
        0 5px 25px rgba(139, 92, 246, 0.4),
        0 0 40px rgba(139, 92, 246, 0.2);
    }
    .title-section { display: flex; align-items: center; gap: 16px; }

    /* KATE Logo - Header */
    .kate-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 18px;
    }
    .kate-logo .kate {
      color: #22C55E;
      opacity: 0.5;
      animation: headerKate 10s ease-in-out infinite;
    }
    .kate-logo .divider {
      color: #27272A;
      font-weight: 300;
    }
    .kate-logo .maketa {
      color: #EF4444;
      opacity: 0.5;
      animation: headerMaketa 10s ease-in-out infinite;
    }
    /* Sequence: 2x MAKETA, 1x KATE, 2x MAKETA, 2x KATE, 3x KATE */
    @keyframes headerMaketa {
      0%, 100% { opacity: 0.5; text-shadow: none; }
      /* 1st MAKETA */
      2%, 6% { opacity: 1; text-shadow: 0 0 15px #EF4444; }
      7%, 8% { opacity: 0.5; text-shadow: none; }
      /* 2nd MAKETA */
      9%, 13% { opacity: 1; text-shadow: 0 0 15px #EF4444; }
      14%, 28% { opacity: 0.5; text-shadow: none; }
      /* 3rd MAKETA */
      29%, 33% { opacity: 1; text-shadow: 0 0 15px #EF4444; }
      34%, 35% { opacity: 0.5; text-shadow: none; }
      /* 4th MAKETA */
      36%, 40% { opacity: 1; text-shadow: 0 0 15px #EF4444; }
      41% { opacity: 0.5; text-shadow: none; }
    }
    @keyframes headerKate {
      0%, 100% { opacity: 0.5; text-shadow: none; }
      /* 1st KATE */
      18%, 26% { opacity: 1; text-shadow: 0 0 15px #22C55E; }
      27%, 44% { opacity: 0.5; text-shadow: none; }
      /* 2nd KATE */
      48%, 52% { opacity: 1; text-shadow: 0 0 15px #22C55E; }
      53%, 54% { opacity: 0.5; text-shadow: none; }
      /* 3rd KATE */
      55%, 59% { opacity: 1; text-shadow: 0 0 15px #22C55E; }
      60%, 61% { opacity: 0.5; text-shadow: none; }
      /* 4th KATE */
      62%, 66% { opacity: 1; text-shadow: 0 0 15px #22C55E; }
      67%, 68% { opacity: 0.5; text-shadow: none; }
      /* 5th KATE */
      69%, 73% { opacity: 1; text-shadow: 0 0 15px #22C55E; }
      74%, 75% { opacity: 0.5; text-shadow: none; }
      /* 6th KATE */
      76%, 85% { opacity: 1; text-shadow: 0 0 20px #22C55E, 0 0 40px #22C55E; }
    }
    .kate-logo .exclaim {
      opacity: 0;
      transform: scale(0.5);
      display: inline-block;
    }
    .kate-logo .kate .exclaim {
      animation: headerKateEx 10s ease-in-out infinite;
    }
    .kate-logo .maketa .exclaim {
      animation: headerMaketaEx 10s ease-in-out infinite;
    }
    @keyframes headerMaketaEx {
      0%, 1%, 7%, 8%, 13%, 28%, 33%, 35%, 40%, 100% { opacity: 0; transform: scale(0.5); }
      3%, 6% { opacity: 1; transform: scale(1.1); }
      10%, 12% { opacity: 1; transform: scale(1.1); }
      30%, 32% { opacity: 1; transform: scale(1.1); }
      37%, 39% { opacity: 1; transform: scale(1.1); }
    }
    @keyframes headerKateEx {
      0%, 17%, 26%, 47%, 52%, 54%, 59%, 61%, 66%, 68%, 73%, 75%, 85%, 100% { opacity: 0; transform: scale(0.5); }
      20%, 25% { opacity: 1; transform: scale(1.1); }
      49%, 51% { opacity: 1; transform: scale(1.1); }
      56%, 58% { opacity: 1; transform: scale(1.1); }
      63%, 65% { opacity: 1; transform: scale(1.1); }
      70%, 72% { opacity: 1; transform: scale(1.1); }
      78%, 84% { opacity: 1; transform: scale(1.2); }
    }
    .kate-logo-center {
      font-size: clamp(14px, 3vw, 24px);
      gap: 8px;
    }
    @media (max-width: 600px) {
      .kate-logo-center {
        font-size: 12px;
        gap: 4px;
      }
    }

    /* Trade Result Badges */
    .trade-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 12px;
    }
    .trade-badge.kate-badge {
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
      animation: kateBadgeGlow 2s ease-in-out infinite;
    }
    .trade-badge.maketa-badge {
      background: rgba(239, 68, 68, 0.15);
      color: #EF4444;
      animation: maketaBadgeGlow 2s ease-in-out infinite;
    }
    @keyframes kateBadgeGlow {
      0%, 100% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); }
      50% { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
    }
    @keyframes maketaBadgeGlow {
      0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
      50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
    }

    .logo {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, #8B5CF6, #6D28D9);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px;
      display: none;
    }
    h1 { font-size: 28px; font-weight: 700; outline: none; border-radius: 6px; padding: 4px 8px; margin: -4px -8px; transition: background 0.2s; }
    h1:hover { background: rgba(139, 92, 246, 0.1); }
    h1:focus { background: rgba(139, 92, 246, 0.15); outline: 1px solid var(--accent-primary); }
    .logo { cursor: text; transition: transform 0.2s, box-shadow 0.2s; outline: none; }
    .logo:hover { transform: scale(1.05); }
    .logo:focus { box-shadow: 0 0 0 2px var(--accent-primary); }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.25), transparent);
      margin: 24px 0;
    }

    .section { margin-bottom: 32px; }
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .section-icon { font-size: 16px; }
    .section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); letter-spacing: 1.5px; }

    .card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .card-title { font-size: 13px; font-weight: 600; color: var(--accent-secondary); letter-spacing: 1px; margin-bottom: 16px; }

    /* Editable elements */
    .editable {
      cursor: text;
      border-radius: 4px;
      transition: all 0.2s;
      padding: 2px 4px;
      margin: -2px -4px;
    }
    .editable:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .editable:focus {
      background: rgba(139, 92, 246, 0.15);
      outline: 1px solid var(--accent-primary);
    }

    /* Setups */
    .setups-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .setup-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      display: flex; flex-direction: column; gap: 10px;
      position: relative;
    }
    .setup-header { display: flex; align-items: center; gap: 10px; }
    .setup-icon {
      width: 44px; height: 44px; border-radius: 12px;
      display: flex; align-items: flex-end; justify-content: center;
      gap: 3px;
      padding-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .setup-icon:hover { transform: scale(1.05); }
    .setup-icon-bar {
      width: 8px;
      border-radius: 3px;
    }
    /* Profit - green bars growing up */
    .setup-icon.profit {
      background: rgba(34, 197, 94, 0.15);
    }
    .setup-icon.profit:hover {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    .setup-icon.profit .setup-icon-bar {
      background: var(--accent-success);
      animation: icon-profit 1.5s ease-in-out infinite;
    }
    .setup-icon.profit .setup-icon-bar:nth-child(1) { animation-delay: 0s; }
    .setup-icon.profit .setup-icon-bar:nth-child(2) { animation-delay: 0.15s; }
    .setup-icon.profit .setup-icon-bar:nth-child(3) { animation-delay: 0.3s; }
    @keyframes icon-profit {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(1.15); box-shadow: 0 0 6px rgba(34, 197, 94, 0.6); }
    }
    /* Loss - red bars going down */
    .setup-icon.loss {
      background: rgba(239, 68, 68, 0.15);
    }
    .setup-icon.loss:hover {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }
    .setup-icon.loss .setup-icon-bar {
      background: var(--accent-danger);
      animation: icon-loss 1.5s ease-in-out infinite;
    }
    .setup-icon.loss .setup-icon-bar:nth-child(1) { animation-delay: 0s; }
    .setup-icon.loss .setup-icon-bar:nth-child(2) { animation-delay: 0.15s; }
    .setup-icon.loss .setup-icon-bar:nth-child(3) { animation-delay: 0.3s; }
    @keyframes icon-loss {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.85); box-shadow: 0 0 6px rgba(239, 68, 68, 0.6); }
    }
    /* Neutral - gray static bars */
    .setup-icon.neutral {
      background: rgba(113, 113, 122, 0.15);
    }
    .setup-icon.neutral .setup-icon-bar {
      background: var(--text-tertiary);
      opacity: 0.4;
    }
    .setup-name {
      font-size: 14px; font-weight: 600; flex: 1;
      background: none; border: none; color: var(--text-primary);
      outline: none; padding: 2px 4px; margin: -2px -4px;
      border-radius: 4px;
    }
    .setup-name:hover { background: rgba(139, 92, 246, 0.1); }
    .setup-name:focus { background: rgba(139, 92, 246, 0.15); outline: 1px solid var(--accent-primary); }
    .setup-desc {
      font-size: 11px; color: var(--text-secondary); line-height: 1.5;
      background: none; border: none; width: 100%; resize: none;
      outline: none; padding: 2px 4px; margin: -2px -4px;
      border-radius: 4px; min-height: 36px;
    }
    .setup-desc:hover { background: rgba(139, 92, 246, 0.1); }
    .setup-desc:focus { background: rgba(139, 92, 246, 0.15); outline: 1px solid var(--accent-primary); color: var(--text-primary); }
    .setup-stats {
      display: flex;
      gap: 10px;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 1px solid var(--border);
    }
    .setup-stat {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .setup-stat-value {
      font-size: 12px;
      font-weight: 600;
    }
    .setup-stat-value.positive { color: var(--accent-success); }
    .setup-stat-value.negative { color: var(--accent-danger); }
    .setup-stat-value.neutral { color: var(--text-tertiary); }
    .setup-stat-label {
      font-size: 9px;
      color: var(--text-tertiary);
      text-transform: uppercase;
    }
    .setup-wins-losses {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 12px;
      font-weight: 600;
    }
    .wins-count { color: var(--accent-success); }
    .losses-count { color: var(--accent-danger); }
    .wins-losses-sep { color: var(--text-tertiary); font-weight: 400; }
    /* Setup P&L Indicator */
    .setup-pnl-indicator {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      margin-left: auto;
    }
    .setup-pnl-bar {
      height: 4px;
      border-radius: 2px;
    }
    /* Profit bars - green, growing */
    .setup-pnl-indicator.profit .setup-pnl-bar {
      background: var(--accent-success);
      animation: profit-pulse 1.5s ease-in-out infinite;
    }
    .setup-pnl-indicator.profit .setup-pnl-bar:nth-child(1) {
      width: 18px;
      opacity: 1;
      animation-delay: 0s;
    }
    .setup-pnl-indicator.profit .setup-pnl-bar:nth-child(2) {
      width: 14px;
      opacity: 0.7;
      animation-delay: 0.1s;
    }
    .setup-pnl-indicator.profit .setup-pnl-bar:nth-child(3) {
      width: 10px;
      opacity: 0.4;
      animation-delay: 0.2s;
    }
    @keyframes profit-pulse {
      0%, 100% { transform: scaleX(1); }
      50% { transform: scaleX(1.15); box-shadow: 0 0 6px rgba(34, 197, 94, 0.5); }
    }
    /* Loss bars - red, shrinking */
    .setup-pnl-indicator.loss .setup-pnl-bar {
      background: var(--accent-danger);
      animation: loss-pulse 1.5s ease-in-out infinite;
    }
    .setup-pnl-indicator.loss .setup-pnl-bar:nth-child(1) {
      width: 10px;
      opacity: 0.4;
      animation-delay: 0.2s;
    }
    .setup-pnl-indicator.loss .setup-pnl-bar:nth-child(2) {
      width: 14px;
      opacity: 0.7;
      animation-delay: 0.1s;
    }
    .setup-pnl-indicator.loss .setup-pnl-bar:nth-child(3) {
      width: 18px;
      opacity: 1;
      animation-delay: 0s;
    }
    @keyframes loss-pulse {
      0%, 100% { transform: scaleX(1); }
      50% { transform: scaleX(0.85); box-shadow: 0 0 6px rgba(239, 68, 68, 0.5); }
    }
    /* Neutral - no trades */
    .setup-pnl-indicator.neutral .setup-pnl-bar {
      background: var(--text-tertiary);
      opacity: 0.3;
    }
    .setup-pnl-indicator.neutral .setup-pnl-bar:nth-child(1) { width: 14px; }
    .setup-pnl-indicator.neutral .setup-pnl-bar:nth-child(2) { width: 14px; }
    .setup-pnl-indicator.neutral .setup-pnl-bar:nth-child(3) { width: 14px; }
    .setup-delete {
      position: absolute; top: 6px; right: 6px;
      color: var(--text-tertiary); cursor: pointer;
      opacity: 0; transition: opacity 0.2s;
      font-size: 12px; padding: 2px;
    }
    .setup-card:hover .setup-delete { opacity: 1; }
    .setup-delete:hover { color: var(--accent-danger); }
    .setup-toggle-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 12px;
      transition: all 0.2s;
    }
    .setup-toggle-card:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(139, 92, 246, 0.05);
    }
    .add-setup-card {
      background: var(--bg-surface);
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 14px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-tertiary);
      font-size: 12px;
      transition: all 0.2s;
    }
    .add-setup-card:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    /* Color picker */
    .color-picker {
      position: absolute; top: 50px; left: 14px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      display: none;
      gap: 6px;
      flex-wrap: wrap;
      width: 140px;
      z-index: 100;
    }
    .color-picker.active { display: flex; }
    .color-option {
      width: 20px; height: 20px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .color-option:hover { transform: scale(1.15); }

    /* Learning */
    .learning-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .learning-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .learning-card:not(.expanded) {
      cursor: grab;
    }
    .learning-card:not(.expanded):active {
      cursor: grabbing;
    }
    .learning-card.dragging {
      opacity: 0.5;
      border: 2px dashed #3B82F6;
    }
    .learning-card.drag-over {
      border: 2px solid #3B82F6;
      background: rgba(59, 130, 246, 0.1);
    }
    .learning-card:hover {
      border-color: #3B82F6;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
    }
    .learning-card.expanded {
      grid-column: 1 / -1;
      cursor: default;
    }
    .learning-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .learning-num {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      flex-shrink: 0;
      position: relative;
      transition: all 0.4s ease;
      /* Цвет от жёлтого (0%) к зелёному (100%) */
      --progress: 0;
      /* hue: 45 (жёлтый) → 142 (зелёный) */
      --hue: calc(45 + (var(--progress) * 0.97));
      --saturation: calc(80% + (var(--progress) * 0.1%));
      --lightness: calc(45% - (var(--progress) * 0.05%));
      background: linear-gradient(135deg,
        hsl(var(--hue), var(--saturation), var(--lightness)),
        hsl(calc(var(--hue) + 8), var(--saturation), calc(var(--lightness) + 8%))
      );
      color: #000;
      box-shadow:
        0 2px 8px hsla(var(--hue), var(--saturation), 40%, 0.4),
        0 0 calc(var(--progress) * 0.25px) hsla(var(--hue), 100%, 50%, calc(var(--progress) * 0.008));
    }
    .learning-num::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.35) 0%, transparent 50%);
      opacity: calc(0.4 + var(--progress) * 0.006);
    }
    /* Анимация пульсации при высоком прогрессе */
    @keyframes num-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    .learning-num.high-progress {
      animation: num-pulse 2s ease-in-out infinite;
    }
    /* Анимация свечения при максимальном прогрессе — зелёный */
    @keyframes num-glow-green {
      0%, 100% { box-shadow: 0 0 15px #22C55E80, 0 0 30px #22C55E40; }
      50% { box-shadow: 0 0 25px #22C55EA0, 0 0 50px #22C55E60; }
    }
    .learning-num.max-progress {
      animation: num-glow-green 1.5s ease-in-out infinite, num-pulse 2s ease-in-out infinite;
      background: linear-gradient(135deg, #22C55E, #4ADE80);
      color: #000;
    }
    .learning-title {
      font-size: 14px;
      font-weight: 600;
      flex: 1;
      background: none;
      border: none;
      color: var(--text-primary);
      outline: none;
    }
    .learning-title:focus {
      background: var(--bg-input);
      padding: 4px 8px;
      margin: -4px -8px;
      border-radius: 4px;
    }
    .learning-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 14px;
      color: var(--text-tertiary);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .learning-card:hover .learning-delete { opacity: 1; }
    .learning-delete:hover { color: var(--accent-danger); }
    .learning-desc {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .learning-card.expanded .learning-desc {
      display: none;
    }
    .learning-content {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .learning-card.expanded .learning-content {
      display: block;
    }
    .learning-fields {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .learning-row {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: rgba(39, 39, 42, 0.3);
    }
    .learning-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .learning-row-num {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .learning-row-delete {
      background: none;
      border: 1px solid transparent;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .learning-row-delete:hover {
      color: #EF4444;
      border-color: #EF4444;
      background: rgba(239, 68, 68, 0.1);
    }
    .learning-row-fields {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      align-items: start; /* Каждая карточка имеет свою высоту */
    }
    @media (max-width: 1200px) {
      .learning-row-fields { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .learning-row-fields { grid-template-columns: 1fr; }
    }
    .learning-field {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--bg-input);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .learning-field:hover {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.03);
    }
    .learning-field-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .learning-field-num {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #F59E0B, #D97706);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #000;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
    }
    .learning-field-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .learning-field-icon {
      font-size: 16px;
    }
    .learning-field-textarea {
      width: 100%;
      min-height: 80px;
      height: auto; /* Разрешить авто-высоту */
      flex: 1 0 auto; /* Может расти, но не сжиматься меньше min-height */
      padding: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: #E4E4E7;
      font-size: 14px;
      line-height: 1.7;
      resize: none;
      outline: none;
      transition: border-color 0.2s, background 0.2s; /* Убрал height из transition */
      overflow: hidden;
    }
    .learning-field-textarea::placeholder {
      color: var(--text-tertiary);
    }
    .learning-field-textarea:hover {
      border-color: rgba(59, 130, 246, 0.3);
    }
    .learning-field-textarea:focus {
      border-color: #3B82F6;
      color: #FAFAFA;
      background: rgba(59, 130, 246, 0.03);
    }
    .learning-field-title-input {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      background: none;
      border: none;
      outline: none;
      flex: 1;
      min-width: 0;
    }
    .learning-field-title-input:focus {
      background: var(--bg-surface);
      padding: 2px 6px;
      margin: -2px -6px;
      border-radius: 4px;
    }
    .learning-field-delete {
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      margin-left: auto;
    }
    .learning-field:hover .learning-field-delete { opacity: 1; }
    .learning-field-delete:hover { color: var(--accent-danger); }

    /* Learning Image Field */
    .learning-field-image {
      min-height: auto;
    }
    .learning-image-slider {
      position: relative;
      margin-bottom: 12px;
    }
    .learning-image-preview {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-primary);
    }
    .learning-image-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .learning-image-preview img:hover {
      transform: scale(1.02);
    }
    .learning-image-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .learning-image-preview:hover .learning-image-delete {
      opacity: 1;
    }
    .learning-image-counter {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .learning-image-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s;
    }
    .learning-image-slider:hover .learning-image-nav {
      opacity: 1;
    }
    .learning-image-nav:hover {
      background: rgba(0,0,0,0.8);
    }
    .learning-image-nav.prev { left: 8px; }
    .learning-image-nav.next { right: 8px; }
    .learning-image-dots {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }
    .learning-image-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .learning-image-dot.active {
      background: var(--accent-primary);
      transform: scale(1.2);
    }
    .learning-image-dot:hover {
      background: var(--text-tertiary);
    }
    .learning-image-upload {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: var(--bg-surface);
      border: 2px dashed var(--border);
      border-radius: 8px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .learning-image-upload:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(139, 92, 246, 0.05);
    }
    .learning-image-upload.drag-over {
      border-color: #22C55E;
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
      transform: scale(1.02);
    }
    .learning-image-upload-icon {
      font-size: 20px;
    }

    /* Files/Методички styles */
    .learning-field-files {
      min-height: auto;
    }
    .learning-files-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .learning-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-surface);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .learning-file-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .learning-file-name {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .learning-file-name:hover {
      color: var(--accent-primary);
      text-decoration: underline;
    }
    .learning-file-size {
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }
    .learning-file-delete {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .learning-file-delete:hover {
      color: #EF4444;
      background: rgba(239, 68, 68, 0.1);
    }
    .learning-file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 16px;
      background: var(--bg-surface);
      border: 2px dashed var(--border);
      border-radius: 8px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .learning-file-upload:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(139, 92, 246, 0.05);
    }
    .learning-file-upload.drag-over {
      border-color: #22C55E;
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
      transform: scale(1.02);
    }
    .learning-file-upload-icon {
      font-size: 24px;
    }
    .learning-file-upload-text {
      font-size: 13px;
    }
    .learning-file-upload-hint {
      font-size: 11px;
      opacity: 0.6;
    }

    .learning-add-field {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 24px 16px;
      background: var(--bg-input);
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      min-height: 120px;
    }
    .learning-add-field:hover {
      border-color: #3B82F6;
      color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }
    .learning-add-field span:first-child {
      font-size: 24px;
      font-weight: 300;
    }
    .learning-collapse {
      margin-top: 16px;
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .learning-image-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .learning-image-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .learning-image-upload {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 24px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .learning-image-upload:hover {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }
    .learning-image-upload.drag-over {
      border-color: #22C55E;
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
      transform: scale(1.02);
    }
    .learning-image-upload-icon {
      font-size: 32px;
      opacity: 0.6;
    }
    .learning-image-upload-text {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .learning-image-preview {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .learning-image-preview img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      display: block;
      background: var(--bg-input);
      cursor: pointer;
    }
    .learning-image-delete {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .learning-image-preview:hover .learning-image-delete {
      opacity: 1;
    }
    /* Files/методички styles for mobile */
    .learning-field-files {
      min-height: auto;
    }
    .learning-files-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .learning-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-surface);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .learning-file-icon {
      font-size: 18px;
    }
    .learning-file-name {
      flex: 1;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .learning-file-size {
      font-size: 10px;
      color: var(--text-tertiary);
    }
    .learning-file-delete {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 4px;
    }
    .learning-file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 20px 16px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .learning-file-upload:hover {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }
    .learning-file-upload.drag-over {
      border-color: #22C55E;
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
      transform: scale(1.02);
    }
    .learning-file-upload-icon {
      font-size: 28px;
      opacity: 0.6;
    }
    .learning-file-upload-text {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .learning-file-upload-hint {
      font-size: 11px;
      color: var(--text-tertiary);
    }
    /* Progress bar mini (in collapsed card) */
    .learning-progress-mini {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .learning-card.expanded .learning-progress-mini {
      display: none;
    }
    .learning-progress-mini-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
    }
    .learning-progress-mini-fill {
      height: 100%;
      background: linear-gradient(90deg, #22C55E, #4ADE80, #22C55E);
      background-size: 200% 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
      animation: pulse-green-mini 2s ease-in-out infinite;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
    }
    .learning-progress-mini-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.6) 50%,
        transparent 100%);
      animation: wave-mini 1.2s ease-in-out infinite;
    }
    @keyframes wave-mini {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    @keyframes pulse-green-mini {
      0%, 100% { background-position: 0% 50%; box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
      50% { background-position: 100% 50%; box-shadow: 0 0 15px rgba(34, 197, 94, 0.9); }
    }
    .learning-progress-mini-value {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-success);
      min-width: 32px;
      text-align: right;
    }
    /* Progress bar section (in expanded card) */
    .learning-progress-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .learning-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .learning-progress-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .learning-progress-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-success);
    }
    .learning-progress-bar {
      height: 12px;
      background: var(--bg-input);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .learning-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22C55E, #4ADE80, #22C55E);
      background-size: 200% 100%;
      border-radius: 6px;
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
      position: relative;
      overflow: hidden;
      animation: pulse-green 2s ease-in-out infinite;
    }
    .learning-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.7) 50%,
        transparent 100%);
      animation: wave 1.2s ease-in-out infinite;
    }
    @keyframes wave {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    @keyframes pulse-green {
      0%, 100% { background-position: 0% 50%; box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
      50% { background-position: 100% 50%; box-shadow: 0 0 25px rgba(34, 197, 94, 1); }
    }
    .learning-progress-slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    .learning-progress-slider::-webkit-slider-runnable-track {
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
    }
    .learning-progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #22C55E, #16A34A);
      border-radius: 50%;
      margin-top: -6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
      transition: transform 0.2s;
    }
    .learning-progress-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    .learning-collapse-btn {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 12px;
      padding: 4px 12px;
    }
    .learning-collapse-btn:hover { color: var(--text-secondary); }
    .add-learning-card {
      background: var(--bg-surface);
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 24px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .add-learning-card:hover {
      border-color: #3B82F6;
      color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }

    /* Strategy */
    .strategy-container {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
    }
    .strategy-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .strategy-header-icon {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .strategy-header-text h3 {
      font-size: 16px; font-weight: 600; margin-bottom: 2px;
    }
    .strategy-header-text span {
      font-size: 12px; color: var(--text-tertiary);
    }
    .strategy-flow {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .strategy-step {
      display: flex;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      transition: background 0.2s;
    }
    .strategy-step:last-child { border-bottom: none; }
    .strategy-step:hover { background: rgba(245, 158, 11, 0.02); margin: 0 -28px; padding: 16px 28px; }
    .strategy-num {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent-warning), #D97706);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; color: #000;
      flex-shrink: 0;
    }
    .strategy-step-content { flex: 1; min-width: 0; }
    .strategy-step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .strategy-step-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    .strategy-step-icon svg {
      width: 20px;
      height: 20px;
    }
    .strategy-step-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .strategy-input {
      width: 100%;
      min-height: 44px;
      height: auto;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 8px;
      color: #E4E4E7;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
      overflow: hidden;
    }
    .strategy-input::placeholder { color: var(--text-tertiary); }
    .strategy-input:hover { border-color: var(--border); }
    .strategy-input:focus {
      border-color: var(--accent-warning);
      background: rgba(245, 158, 11, 0.05);
      color: #FAFAFA;
    }

    /* Strategy Checklist Items */
    .strategy-checklist {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .strategy-checklist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(34, 197, 94, 0.08);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .strategy-checklist-item .check-icon {
      color: var(--accent-success);
      font-size: 12px;
    }
    .strategy-checklist-item input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      outline: none;
    }
    .strategy-checklist-item input:focus {
      color: var(--text-primary);
    }
    .strategy-checklist-item .delete-item {
      color: var(--text-tertiary);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
    }
    .strategy-checklist-item:hover .delete-item {
      opacity: 1;
    }
    .strategy-checklist-item .delete-item:hover {
      color: var(--accent-danger);
    }
    .strategy-add-checklist {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: none;
      border: 1px dashed var(--border);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 4px;
    }
    .strategy-add-checklist:hover {
      border-color: var(--accent-success);
      color: var(--accent-success);
      background: rgba(34, 197, 94, 0.05);
    }

    /* Strategy Layout with Image */
    .strategy-layout {
      display: flex;
      gap: 32px;
    }
    .strategy-fields {
      flex: 0 0 55%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .strategy-image-panel {
      flex: 1;
    }
    .strategy-right-column {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    /* Strategy Videos Inline - внутри панели картинок */
    .strategy-videos-inline {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .strategy-videos-inline .strategy-videos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .strategy-videos-inline .strategy-videos-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .strategy-videos-inline .strategy-videos-add {
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px dashed rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      color: var(--accent-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .strategy-videos-inline .strategy-videos-add:hover {
      background: rgba(139, 92, 246, 0.2);
      border-style: solid;
    }
    .strategy-videos-inline .strategy-videos-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-tertiary);
      font-size: 12px;
    }
    .strategy-videos-inline .strategy-videos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .strategy-videos-inline .strategy-video-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-input);
      border-radius: 8px;
      transition: all 0.2s;
    }
    .strategy-videos-inline .strategy-video-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .strategy-videos-inline .strategy-video-icon {
      font-size: 14px;
      color: var(--accent-success);
    }
    .strategy-videos-inline .strategy-video-info {
      flex: 1;
      min-width: 0;
    }
    .strategy-videos-inline .strategy-video-name {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .strategy-videos-inline .strategy-video-url {
      font-size: 10px;
      color: var(--text-tertiary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .strategy-videos-inline .strategy-video-actions {
      display: flex;
      gap: 6px;
    }
    .strategy-videos-inline .strategy-video-btn {
      padding: 5px 10px;
      background: rgba(139, 92, 246, 0.15);
      border: none;
      border-radius: 5px;
      color: var(--accent-primary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .strategy-videos-inline .strategy-video-btn:hover {
      background: rgba(139, 92, 246, 0.3);
    }
    .strategy-videos-inline .strategy-video-btn.delete {
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent-danger);
    }
    .strategy-videos-inline .strategy-video-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    /* Video Card with Embed */
    .strategy-video-card {
      background: var(--bg-input);
      border-radius: 10px;
      overflow: hidden;
    }
    .strategy-video-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .strategy-video-card-header .strategy-video-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .strategy-video-embed {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
    }
    .strategy-video-embed iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 0 0 10px 10px;
    }
    .strategy-image-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .strategy-image-upload {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 300px;
    }
    .strategy-image-upload:hover {
      border-color: var(--accent-warning);
      background: rgba(245, 158, 11, 0.05);
    }
    .strategy-image-upload.dragover {
      border-color: var(--accent-warning);
      background: rgba(245, 158, 11, 0.1);
    }
    .strategy-image-upload-icon {
      font-size: 48px;
      opacity: 0.6;
    }
    .strategy-image-upload-text {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
    }
    .strategy-image-preview {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .strategy-image-preview img {
      width: 100%;
      height: auto;
      min-height: 350px;
      max-height: 600px;
      object-fit: contain;
      display: block;
      cursor: pointer;
      background: #0a0a0a;
    }
    .strategy-image-delete {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background: rgba(239, 68, 68, 0.9);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .strategy-image-preview:hover .strategy-image-delete {
      opacity: 1;
    }
    /* Image Slider styles */
    .strategy-image-slider {
      position: relative;
    }
    .strategy-image-slider-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      z-index: 10;
    }
    .strategy-image-slider:hover .strategy-image-slider-nav {
      opacity: 1;
    }
    .strategy-image-slider-nav:hover {
      background: rgba(139, 92, 246, 0.8);
    }
    .strategy-image-slider-nav.prev { left: 10px; }
    .strategy-image-slider-nav.next { right: 10px; }
    .strategy-image-slider-counter {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      z-index: 10;
    }
    .strategy-image-slider-dots {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
    }
    .strategy-image-slider-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .strategy-image-slider-dot.active {
      background: var(--accent-primary);
      transform: scale(1.2);
    }
    .strategy-image-slider-dot:hover {
      background: var(--accent-secondary);
    }
    .strategy-add-more {
      margin-top: 12px;
      padding: 10px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .strategy-add-more:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(139, 92, 246, 0.05);
    }
    .strategy-add-more.dragover {
      border-color: var(--accent-success);
      color: var(--accent-success);
      background: rgba(34, 197, 94, 0.1);
      border-style: solid;
    }
    @media (max-width: 1000px) {
      .strategy-layout {
        flex-direction: column;
      }
      .strategy-image-panel {
        width: 100%;
      }
    }

    /* Image Modal */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    .image-modal.active {
      display: flex;
    }
    .image-modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .image-modal-close:hover {
      background: var(--accent-danger);
      border-color: var(--accent-danger);
    }

    /* Strategy Slider */
    .strategy-slider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .strategy-nav-btn {
      width: 36px; height: 36px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }
    .strategy-nav-btn:hover:not(:disabled) {
      background: var(--accent-warning);
      border-color: var(--accent-warning);
      color: #000;
    }
    .strategy-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .strategy-tabs {
      display: flex;
      gap: 8px;
      flex: 1;
      overflow-x: auto;
      padding: 4px 0;
    }
    .strategy-tabs::-webkit-scrollbar { height: 4px; }
    .strategy-tabs::-webkit-scrollbar-track { background: transparent; }
    .strategy-tabs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .strategy-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .strategy-tab:hover {
      border-color: var(--border);
    }
    .strategy-tab.active {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
      border-color: var(--accent-warning);
    }
    .strategy-tab-icon {
      width: 28px; height: 28px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      font-weight: 700;
      transition: all 0.3s ease;
      position: relative;
    }
    /* Цвета по профиту: красный -> жёлтый -> зелёный */
    .strategy-tab-icon.profit-negative {
      background: linear-gradient(135deg, #EF4444, #DC2626) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    .strategy-tab-icon.profit-neutral {
      background: linear-gradient(135deg, #F59E0B, #D97706) !important;
      color: #000 !important;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
    }
    .strategy-tab-icon.profit-positive {
      background: linear-gradient(135deg, #22C55E, #16A34A) !important;
      color: #000 !important;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
    }
    /* Пульсация для профитных */
    @keyframes tab-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .strategy-tab-icon.profit-positive {
      animation: tab-pulse 2s ease-in-out infinite;
    }
    .strategy-tab.active .strategy-tab-icon {
      transform: scale(1.15);
    }
    .strategy-tab.active .strategy-tab-icon.profit-positive {
      animation: none;
      transform: scale(1.15);
    }
    .strategy-tab-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .strategy-tab.active .strategy-tab-name {
      color: var(--text-primary);
    }
    .strategy-current-setup {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .strategy-current-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .strategy-current-info h4 {
      font-size: 15px; font-weight: 600; margin-bottom: 2px;
    }
    .strategy-current-info span {
      font-size: 11px; color: var(--text-tertiary);
    }

    /* Drop zone */
    .drop-zone {
      border: 1px dashed rgba(59, 130, 246, 0.4);
      background: rgba(59, 130, 246, 0.03);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: #3B82F6; background: rgba(59, 130, 246, 0.08); }
    .drop-icon { font-size: 20px; }
    .drop-text { color: var(--text-secondary); font-size: 13px; }
    .drop-hint { font-size: 11px; color: var(--text-tertiary); margin-left: auto; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
    .stat-card { background: var(--bg-input); border-radius: 8px; padding: 16px; display: flex; flex-direction: column; gap: 4px; }
    .stat-label { font-size: 11px; color: var(--text-tertiary); }
    .stat-value { font-size: 20px; font-weight: 700; }
    .stat-value.success { color: var(--accent-success); }
    .stat-value.danger { color: var(--accent-danger); }
    .stat-value.accent { color: var(--accent-primary); }

    .strat-badges { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .strat-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .strat-badge:hover { border-color: var(--border); }
    .strat-badge.active {
      border-color: currentColor;
      color: var(--text-primary);
    }
    .strat-dot { width: 8px; height: 8px; border-radius: 50%; }
    .strat-clear {
      padding: 6px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .strat-clear:hover {
      background: var(--bg-surface);
      color: var(--text-secondary);
    }
    .strat-toggle {
      padding: 6px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .strat-toggle:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: #fff;
    }

    /* Trades Cards */
    .trades-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 600px;
      overflow-y: auto;
      padding-right: 8px;
    }
    .trades-list::-webkit-scrollbar { width: 6px; }
    .trades-list::-webkit-scrollbar-track { background: transparent; }
    .trades-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .trade-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }
    .trade-card:hover { border-color: rgba(139, 92, 246, 0.3); }
    .trade-card.loss {
      background: rgba(239, 68, 68, 0.03);
      border-color: rgba(239, 68, 68, 0.2);
    }
    .trade-card.loss:hover { border-color: rgba(239, 68, 68, 0.4); }
    .trade-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .trade-pair {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .trade-date {
      font-size: 11px;
      color: var(--text-tertiary);
    }
    .trade-pnl {
      margin-left: auto;
      font-size: 16px;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 6px;
    }
    .trade-pnl.positive {
      color: var(--accent-success);
      background: rgba(34, 197, 94, 0.1);
    }
    .trade-pnl.negative {
      color: var(--accent-danger);
      background: rgba(239, 68, 68, 0.1);
    }
    .trade-setup-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .trade-setup-label {
      font-size: 11px;
      color: var(--text-tertiary);
      width: 60px;
    }
    .trade-setup-select {
      flex: 1;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-secondary);
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }
    .trade-setup-select:focus { border-color: var(--accent-primary); }
    .trade-setup-reset {
      width: 32px;
      height: 32px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .trade-setup-reset:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--accent-danger);
      color: var(--accent-danger);
    }
    .trade-notes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .trade-note-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .trade-note-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .trade-note-label span { font-size: 14px; }
    .trade-note-input {
      width: 100%;
      min-height: 60px;
      padding: 10px 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.5;
      resize: none;
      outline: none;
      transition: all 0.2s;
    }
    .trade-note-input::placeholder { color: var(--text-tertiary); }
    .trade-note-input:hover { border-color: rgba(139, 92, 246, 0.3); }
    .trade-note-input:focus {
      border-color: var(--accent-primary);
      color: var(--text-primary);
      background: rgba(139, 92, 246, 0.03);
    }
    .trade-card.loss .trade-note-input:focus {
      border-color: var(--accent-danger);
      background: rgba(239, 68, 68, 0.03);
    }
    .empty-trades {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }
    .empty-trades-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-trades-text { font-size: 14px; }
    .setup-select { background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 11px; padding: 4px 8px; outline: none; cursor: pointer; }
    .setup-select:focus { border-color: var(--accent-primary); }
    .clear-trades { background: var(--accent-danger); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 12px; }
    .clear-trades:hover { opacity: 0.9; }

    /* Trade Video Link */
    .trade-video-field {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .trade-video-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .trade-video-icon {
      font-size: 14px;
      opacity: 0.6;
    }
    .trade-video-input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-secondary);
      font-size: 12px;
      outline: none;
      transition: all 0.2s;
    }
    .trade-video-input:focus {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }
    .trade-video-input::placeholder {
      color: var(--text-tertiary);
    }
    .trade-video-btn {
      padding: 8px 12px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      color: var(--accent-primary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .trade-video-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: var(--accent-primary);
    }
    .trade-video-btn.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    /* Strategy Videos Section */
    .strategy-videos {
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .strategy-videos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .strategy-videos-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-secondary);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .strategy-videos-add {
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px dashed rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      color: var(--accent-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .strategy-videos-add:hover {
      background: rgba(139, 92, 246, 0.2);
      border-style: solid;
    }
    .strategy-videos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .strategy-video-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-input);
      border-radius: 8px;
      transition: all 0.2s;
    }
    .strategy-video-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .strategy-video-icon {
      font-size: 16px;
    }
    .strategy-video-info {
      flex: 1;
      min-width: 0;
    }
    .strategy-video-name {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .strategy-video-url {
      font-size: 11px;
      color: var(--text-tertiary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .strategy-video-actions {
      display: flex;
      gap: 6px;
    }
    .strategy-video-btn {
      padding: 6px 10px;
      background: rgba(139, 92, 246, 0.15);
      border: none;
      border-radius: 5px;
      color: var(--accent-primary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .strategy-video-btn:hover {
      background: rgba(139, 92, 246, 0.3);
    }
    .strategy-video-btn.delete {
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent-danger);
    }
    .strategy-video-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    .strategy-videos-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-tertiary);
      font-size: 12px;
    }

    /* Trade Checklist - Compact Grouped */
    .trade-checklist {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .trade-checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .trade-checklist-label {
      font-size: 10px;
      color: var(--text-tertiary);
    }
    .trade-checklist-score {
      font-size: 10px;
      font-weight: 600;
      color: var(--accent-success);
    }
    .trade-checklist-groups {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .checklist-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: 6px;
      background: rgba(255,255,255,0.02);
    }
    .checklist-group[data-field="coin_selection"] { background: rgba(59, 130, 246, 0.05); }
    .checklist-group[data-field="chart_pattern"] { background: rgba(139, 92, 246, 0.05); }
    .checklist-group[data-field="entry_point"] { background: rgba(245, 158, 11, 0.05); }
    .checklist-group[data-field="risk_management"] { background: rgba(34, 197, 94, 0.05); }
    .checklist-group-header {
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 85px;
      flex-shrink: 0;
    }
    .checklist-group-icon {
      display: flex;
      align-items: center;
      width: 16px;
      height: 16px;
    }
    .checklist-group-icon svg {
      width: 14px;
      height: 14px;
    }
    .checklist-group-title {
      font-size: 10px;
      font-weight: 600;
    }
    .checklist-group[data-field="coin_selection"] .checklist-group-title { color: #3B82F6; }
    .checklist-group[data-field="chart_pattern"] .checklist-group-title { color: #8B5CF6; }
    .checklist-group[data-field="entry_point"] .checklist-group-title { color: #F59E0B; }
    .checklist-group[data-field="risk_management"] .checklist-group-title { color: #22C55E; }
    .checklist-group-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .checklist-chip {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: rgba(34, 197, 94, 0.12);
      color: #22C55E;
    }
    .checklist-chip.unchecked {
      background: rgba(113, 113, 122, 0.1);
      color: #71717A;
    }
    .checklist-chip:hover {
      transform: scale(1.03);
      filter: brightness(1.1);
    }
    .checklist-chip .chip-icon {
      font-size: 9px;
    }

    /* Checklist Stats Panel */
    .checklist-stats-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .checklist-stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .checklist-stats-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .checklist-stats-avg {
      padding: 4px 12px;
      background: rgba(34, 197, 94, 0.15);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-success);
    }
    .checklist-stats-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .checklist-stat-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .checklist-stat-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .checklist-stat-name {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .checklist-stat-name svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .checklist-stat-pct {
      font-size: 12px;
      font-weight: 600;
    }
    .checklist-stat-pct.high { color: var(--accent-success); }
    .checklist-stat-pct.medium { color: var(--accent-warning); }
    .checklist-stat-pct.low { color: var(--accent-danger); }
    .checklist-stat-bar {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .checklist-stat-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .checklist-stat-fill.high { background: var(--accent-success); }
    .checklist-stat-fill.medium { background: var(--accent-warning); }
    .checklist-stat-fill.low { background: var(--accent-danger); }
    .checklist-insight {
      margin-top: 16px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.08);
      border-radius: 8px;
    }
    .checklist-insight-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .checklist-insight-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-danger);
    }
    .checklist-insight-text {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Rules */
    .rules-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .rules-card { border-radius: 12px; padding: 24px; }
    .rules-card.do { background: rgba(34, 197, 94, 0.06); border: 1px solid rgba(34, 197, 94, 0.25); }
    .rules-card.dont { background: rgba(239, 68, 68, 0.06); border: 1px solid rgba(239, 68, 68, 0.25); }
    .rules-header { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
    .rules-card.do .rules-header { color: var(--accent-success); }
    .rules-card.dont .rules-header { color: var(--accent-danger); }
    .rules-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .rule-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .rule-item input { background: none; border: none; color: var(--text-secondary); flex: 1; outline: none; font-size: 13px; padding: 4px; border-radius: 4px; }
    .rule-item input:hover { background: rgba(255,255,255,0.05); }
    .rule-item input:focus { color: var(--text-primary); background: rgba(255,255,255,0.1); }
    .rule-delete { color: var(--text-tertiary); cursor: pointer; opacity: 0; transition: opacity 0.2s; padding: 4px; }
    .rule-item:hover .rule-delete { opacity: 1; }
    .rule-delete:hover { color: var(--accent-danger); }
    .add-btn { margin-top: 12px; background: none; border: 1px dashed var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text-tertiary); cursor: pointer; width: 100%; font-size: 12px; transition: all 0.2s; }
    .add-btn:hover { border-color: var(--text-secondary); color: var(--text-secondary); }

    /* Mental */
    .mental-subtitle { font-size: 13px; font-weight: 600; color: var(--accent-secondary); letter-spacing: 1px; margin-bottom: 16px; }
    .mental-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .mental-col { padding: 16px; border-radius: 8px; }
    .mental-col.wrong { background: rgba(239, 68, 68, 0.06); }
    .mental-col.right { background: rgba(34, 197, 94, 0.06); }
    .mental-title { font-size: 12px; font-weight: 600; margin-bottom: 12px; }
    .mental-col.wrong .mental-title { color: var(--accent-danger); }
    .mental-col.right .mental-title { color: var(--accent-success); }
    .mental-text {
      font-size: 12px; color: var(--text-secondary); line-height: 1.6;
      width: 100%; min-height: 100px; resize: none;
      background: none; border: none; outline: none;
      padding: 8px; margin: -8px; border-radius: 4px;
    }
    .mental-text:hover { background: rgba(255,255,255,0.03); }
    .mental-text:focus { color: var(--text-primary); background: rgba(255,255,255,0.05); }

    /* Profit */
    .profit-card { border-color: rgba(34, 197, 94, 0.25); }
    .profit-desc { font-size: 12px; color: var(--text-tertiary); margin-bottom: 20px; }

    /* Deposit Input */
    .deposit-section {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.02));
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .deposit-icon {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, #22C55E, #16A34A);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px;
    }
    .deposit-info { flex: 1; }
    .deposit-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }
    .deposit-input-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .deposit-input {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 28px;
      font-weight: 700;
      width: 120px;
      outline: none;
      -moz-appearance: textfield;
    }
    .deposit-input::-webkit-outer-spin-button,
    .deposit-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .deposit-input::placeholder { color: var(--text-tertiary); }
    .deposit-currency {
      font-size: 20px;
      color: var(--text-tertiary);
      font-weight: 600;
    }
    .deposit-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .deposit-status.safe {
      background: rgba(34, 197, 94, 0.15);
      color: #22C55E;
    }
    .deposit-status.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #F59E0B;
    }
    .deposit-status.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #EF4444;
    }

    /* Progress Bars */
    .profit-bars {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .profit-bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .profit-bar-label {
      width: 55px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .profit-bar-track {
      flex: 1;
      height: 10px;
      background: var(--bg-input);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .profit-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: linear-gradient(90deg, #22C55E, #16A34A);
      position: relative;
      transition: width 0.5s ease;
    }
    .profit-bar-fill.reached {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .profit-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255,255,255,0.4) 50%,
        transparent 100%
      );
      animation: wave 2s ease-in-out infinite;
    }
    @keyframes wave {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(34, 197, 94, 0.5), 0 0 10px rgba(34, 197, 94, 0.3);
      }
      50% {
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.8), 0 0 25px rgba(34, 197, 94, 0.5);
      }
    }
    .profit-bar-lock {
      width: 70px;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-success);
      text-align: right;
    }
    .profit-bar-row.reached .profit-bar-label {
      color: var(--accent-success);
    }
    .profit-bar-row.reached .profit-bar-lock {
      animation: pulse-text 2s ease-in-out infinite;
    }
    @keyframes pulse-text {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .profit-bar-check {
      color: var(--accent-success);
      font-size: 16px;
      animation: pop-in 0.3s ease;
    }
    @keyframes pop-in {
      0% { transform: scale(0); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .profit-bar-row.locked {
      opacity: 0.5;
    }
    .profit-bar-row.locked .profit-bar-fill {
      background: linear-gradient(90deg, #71717A, #52525B);
    }
    .profit-bar-row.locked .profit-bar-fill::after {
      display: none;
    }
    .profit-bar-label, .profit-bar-lock {
      cursor: pointer;
      transition: color 0.2s;
    }
    .profit-bar-label:hover, .profit-bar-lock:hover {
      color: var(--accent-primary);
    }
    .profit-bar-delete {
      color: var(--text-tertiary);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 14px;
      padding: 0 4px;
    }
    .profit-bar-row:hover .profit-bar-delete {
      opacity: 1;
    }
    .profit-bar-delete:hover {
      color: var(--accent-danger);
    }

    .profit-add-card {
      background: var(--bg-surface);
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 12px;
      transition: all 0.2s;
      text-align: center;
    }
    .profit-add-card:hover {
      border-color: var(--accent-success);
      color: var(--accent-success);
    }

    /* Tips */
    .tips-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .tips-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .tip-item { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .tip-item::before { content: '•'; color: var(--text-tertiary); }
    .tip-item input { background: none; border: none; color: var(--text-secondary); flex: 1; outline: none; font-size: 13px; padding: 2px 4px; border-radius: 4px; }
    .tip-item input:hover { background: rgba(255,255,255,0.05); }
    .tip-item input:focus { color: var(--text-primary); background: rgba(255,255,255,0.1); }
    .tip-delete { color: var(--text-tertiary); cursor: pointer; opacity: 0; font-size: 12px; padding: 2px; }
    .tip-item:hover .tip-delete { opacity: 1; }
    .correction-text {
      font-size: 13px; color: var(--text-secondary); line-height: 1.7;
      width: 100%; min-height: 150px; resize: none;
      background: none; border: none; outline: none;
      padding: 8px; margin: -8px; border-radius: 4px;
    }
    .correction-text:hover { background: rgba(255,255,255,0.03); }
    .correction-text:focus { color: var(--text-primary); background: rgba(255,255,255,0.05); }

    /* Footer */
    .footer { display: flex; justify-content: space-between; align-items: center; padding-top: 24px; margin-top: 32px; border-top: 1px solid var(--border); }
    .footer-quote { font-size: 13px; color: var(--text-tertiary); font-style: italic; }
    .footer-version { font-size: 12px; color: var(--text-tertiary); }

    /* ============ RESPONSIVE: Tablets (1200px) ============ */
    @media (max-width: 1200px) {
      .setups-grid, .learning-grid, .stats-row, .rm-grid { grid-template-columns: repeat(2, 1fr); }
      .strategy-layout { flex-direction: column; }
      .strategy-fields { flex: 1; }
      .strategy-image-panel { width: 100%; min-width: auto; }
    }

    /* ============ RESPONSIVE: Tablets Portrait (1024px) ============ */
    @media (max-width: 1024px) {
      .container { padding: 24px 24px; }
      h1 { font-size: 22px; }
      .strategy-tabs { gap: 8px; }
      .strategy-tab { padding: 8px 12px; }
      .strategy-tab-name { font-size: 12px; }
    }

    /* ============ ANIMATED BREAKOUT CHART ============ */
    .breakout-chart {
      position: relative;
      width: 360px;
      height: 90px;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      padding: 10px 16px;
      background: rgba(10, 10, 12, 0.8);
      border-radius: 10px;
      border: 1px solid rgba(34, 197, 94, 0.15);
      overflow: hidden;
    }
    .breakout-chart::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.03) 0%, transparent 100%);
      pointer-events: none;
    }

    /* Level lines */
    .chart-level {
      position: absolute;
      height: 1px;
      background: rgba(245, 158, 11, 0.4);
      left: 12px;
      right: 12px;
      opacity: 0;
    }
    .chart-level-1 { top: 18px; animation: levelAppear 0.3s ease forwards 2.8s; }
    .chart-level-2 { top: 26px; animation: levelAppear 0.3s ease forwards 1.8s; }
    .chart-level-3 { top: 34px; animation: levelAppear 0.3s ease forwards 0.9s; }

    @keyframes levelAppear {
      from { opacity: 0; transform: scaleX(0); }
      to { opacity: 1; transform: scaleX(1); }
    }

    /* Candle base styles */
    .chart-candle {
      position: relative;
      width: 5px;
      border-radius: 1px;
      opacity: 0;
      transform: scaleY(0);
      transform-origin: bottom;
    }
    .chart-candle.green { background: var(--accent-success); }
    .chart-candle.red { background: var(--accent-danger); }

    /* Candle wick */
    .chart-candle::before {
      content: '';
      position: absolute;
      width: 1px;
      left: 50%;
      transform: translateX(-50%);
      background: inherit;
    }
    .chart-candle.green::before { top: -5px; height: 10px; }
    .chart-candle.red::before { top: -4px; height: 8px; }

    /* Breakout candle special */
    .chart-candle.breakout {
      width: 8px;
      background: var(--accent-success);
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.6), 0 0 30px rgba(34, 197, 94, 0.3);
    }
    .chart-candle.breakout::before {
      top: -10px;
      height: 15px;
    }
    .chart-candle.breakout::after {
      content: '';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 30px;
      background: radial-gradient(circle, rgba(34, 197, 94, 0.4) 0%, transparent 70%);
      border-radius: 50%;
      animation: glowPulse 1s ease-in-out infinite;
    }

    @keyframes glowPulse {
      0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
      50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
    }

    /* Candle appear animation */
    @keyframes candleAppear {
      0% { opacity: 0; transform: scaleY(0); }
      60% { opacity: 1; transform: scaleY(1.1); }
      100% { opacity: 1; transform: scaleY(1); }
    }

    /* Breakout candle special animation */
    @keyframes breakoutAppear {
      0% { opacity: 0; transform: scaleY(0); }
      50% { opacity: 1; transform: scaleY(1.15); }
      70% { transform: scaleY(0.95); }
      100% { opacity: 1; transform: scaleY(1); }
    }

    /* Individual candle animations with delays */
    .chart-candle:nth-child(4) { animation: candleAppear 0.15s ease forwards 0.1s; }
    .chart-candle:nth-child(5) { animation: candleAppear 0.15s ease forwards 0.18s; }
    .chart-candle:nth-child(6) { animation: candleAppear 0.15s ease forwards 0.26s; }
    .chart-candle:nth-child(7) { animation: candleAppear 0.15s ease forwards 0.34s; }
    .chart-candle:nth-child(8) { animation: candleAppear 0.15s ease forwards 0.42s; }
    .chart-candle:nth-child(9) { animation: candleAppear 0.15s ease forwards 0.5s; }
    .chart-candle:nth-child(10) { animation: candleAppear 0.15s ease forwards 0.58s; }
    .chart-candle:nth-child(11) { animation: candleAppear 0.15s ease forwards 0.66s; }
    .chart-candle:nth-child(12) { animation: candleAppear 0.15s ease forwards 0.74s; }
    .chart-candle:nth-child(13) { animation: candleAppear 0.15s ease forwards 0.82s; }
    .chart-candle:nth-child(14) { animation: candleAppear 0.15s ease forwards 0.9s; }
    .chart-candle:nth-child(15) { animation: candleAppear 0.15s ease forwards 0.98s; }
    .chart-candle:nth-child(16) { animation: candleAppear 0.15s ease forwards 1.06s; }
    .chart-candle:nth-child(17) { animation: candleAppear 0.15s ease forwards 1.14s; }
    .chart-candle:nth-child(18) { animation: candleAppear 0.15s ease forwards 1.22s; }
    .chart-candle:nth-child(19) { animation: candleAppear 0.15s ease forwards 1.3s; }
    .chart-candle:nth-child(20) { animation: candleAppear 0.15s ease forwards 1.38s; }
    .chart-candle:nth-child(21) { animation: candleAppear 0.15s ease forwards 1.46s; }
    .chart-candle:nth-child(22) { animation: candleAppear 0.15s ease forwards 1.54s; }
    .chart-candle:nth-child(23) { animation: candleAppear 0.15s ease forwards 1.62s; }
    .chart-candle:nth-child(24) { animation: candleAppear 0.15s ease forwards 1.7s; }
    .chart-candle:nth-child(25) { animation: candleAppear 0.15s ease forwards 1.78s; }
    .chart-candle:nth-child(26) { animation: candleAppear 0.15s ease forwards 1.86s; }
    .chart-candle:nth-child(27) { animation: candleAppear 0.15s ease forwards 1.94s; }
    .chart-candle:nth-child(28) { animation: candleAppear 0.15s ease forwards 2.02s; }
    .chart-candle:nth-child(29) { animation: candleAppear 0.15s ease forwards 2.1s; }
    .chart-candle:nth-child(30) { animation: candleAppear 0.15s ease forwards 2.18s; }
    .chart-candle:nth-child(31) { animation: candleAppear 0.15s ease forwards 2.26s; }
    .chart-candle:nth-child(32) { animation: candleAppear 0.15s ease forwards 2.34s; }
    .chart-candle:nth-child(33) { animation: candleAppear 0.15s ease forwards 2.42s; }
    .chart-candle:nth-child(34) { animation: candleAppear 0.15s ease forwards 2.5s; }
    .chart-candle:nth-child(35) { animation: candleAppear 0.15s ease forwards 2.58s; }
    .chart-candle:nth-child(36) { animation: candleAppear 0.15s ease forwards 2.66s; }
    .chart-candle:nth-child(37) { animation: candleAppear 0.15s ease forwards 2.74s; }
    .chart-candle:nth-child(38) { animation: candleAppear 0.15s ease forwards 2.82s; }
    .chart-candle:nth-child(39) { animation: breakoutAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards 2.9s; }
    .chart-candle:nth-child(40) { animation: candleAppear 0.15s ease forwards 3.3s; }
    .chart-candle:nth-child(41) { animation: candleAppear 0.15s ease forwards 3.38s; }
    .chart-candle:nth-child(42) { animation: candleAppear 0.15s ease forwards 3.46s; }

    /* ============ RESPONSIVE: Mobile (768px) ============ */
    @media (max-width: 768px) {
      .container { padding: 16px 16px; }

      /* Header */
      .page-header { flex-direction: column; gap: 12px; align-items: center; }
      .title-section { display: none; }
      h1 { font-size: 20px; }
      .logo { width: 40px; height: 40px; font-size: 14px; }
      .kate-logo-center { order: 1; }
      .reload-wrap { width: 100%; justify-content: center; order: 2; }
      #sync-status span:last-child { display: none; }
      .breakout-chart { display: none; }

      /* Grids */
      .setups-grid, .learning-grid, .stats-row, .rm-grid, .rules-grid, .mental-grid, .profit-grid, .tips-grid {
        grid-template-columns: 1fr;
      }

      /* Section titles */
      .section-title { font-size: 12px; letter-spacing: 1px; }
      .section-header { margin-bottom: 12px; }

      /* Setup cards */
      .setup-card { padding: 16px; }
      .setup-title { font-size: 14px; }
      .setup-desc { font-size: 12px; }

      /* Learning cards */
      .learning-card { padding: 16px; }
      .learning-title { font-size: 14px; }
      .learning-row-fields { grid-template-columns: 1fr; gap: 12px; }
      .learning-field { padding: 12px; }

      /* Strategy */
      .strategy-container { padding: 0; }
      .strategy-slider { overflow-x: auto; padding-bottom: 8px; }
      .strategy-tabs { flex-wrap: nowrap; }
      .strategy-tab { flex-shrink: 0; padding: 8px 12px; }
      .strategy-tab-icon { width: 24px; height: 24px; font-size: 12px; }
      .strategy-tab-name { font-size: 11px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .strategy-current-setup { padding: 12px; flex-wrap: wrap; }
      .strategy-step { padding: 12px; }
      .strategy-num { width: 28px; height: 28px; font-size: 12px; }
      .strategy-input { font-size: 14px; min-height: 50px; }
      .strategy-image-panel { margin-top: 16px; }

      /* Stats */
      .stat-card { padding: 12px; }
      .stat-value { font-size: 18px; }
      .stat-label { font-size: 10px; }

      /* RM Grid */
      .rm-card { padding: 16px; }
      .rm-value { font-size: 20px; }

      /* Rules */
      .rules-card { padding: 16px; }
      .rule-item { font-size: 12px; }

      /* Tables - horizontal scroll */
      .table-container { overflow-x: auto; }
      .table-header, .table-row { min-width: 600px; }

      /* Trades */
      .trades-controls { flex-direction: column; gap: 12px; }
      .trades-filter { width: 100%; justify-content: flex-start; overflow-x: auto; }

      /* Footer */
      .footer { flex-direction: column; gap: 8px; text-align: center; }
      .footer-quote { font-size: 11px; }

      /* Modals */
      .modal-box { width: 90%; margin: 20px; padding: 20px; }

      /* Auth */
      .auth-box { padding: 32px 24px; }
      .auth-logo { width: 72px; height: 72px; }
      .auth-title { font-size: 20px; }
    }

    /* ============ RESPONSIVE: Small Mobile (480px) ============ */
    @media (max-width: 480px) {
      .container { padding: 12px 12px; }
      h1 { font-size: 18px; }
      .logo { width: 36px; height: 36px; font-size: 12px; border-radius: 8px; }

      /* Learning */
      .learning-num { width: 32px; height: 32px; font-size: 14px; }
      .learning-header { gap: 8px; }
      .learning-progress-section { padding: 12px; }

      /* Strategy tabs - scrollable chips */
      .strategy-tab { padding: 6px 10px; border-radius: 16px; }
      .strategy-tab-icon { width: 22px; height: 22px; font-size: 11px; border-radius: 6px; }
      .strategy-tab-name { font-size: 10px; max-width: 60px; }
      .strategy-nav-btn { width: 28px; height: 28px; font-size: 14px; }

      /* Cards smaller */
      .setup-card, .learning-card, .rm-card, .rules-card { border-radius: 10px; }
      .setup-icon { width: 36px; height: 36px; font-size: 14px; }

      /* Buttons */
      .add-btn, .add-rule-btn { padding: 10px 12px; font-size: 12px; }

      /* Image slider */
      .strategy-image-slider-nav { width: 32px; height: 32px; font-size: 16px; }
      .strategy-image-slider-counter { font-size: 10px; padding: 3px 8px; }
      .strategy-add-more { padding: 12px; font-size: 11px; }

      /* Profit levels */
      .profit-row { padding: 6px 10px; font-size: 12px; }

      /* Tips */
      .tip-item { font-size: 12px; }

      /* Auth */
      .auth-box { padding: 24px 20px; border-radius: 20px; }
      .auth-logo { width: 64px; height: 64px; border-radius: 16px; }
      .auth-title { font-size: 18px; }
      .auth-btn { padding: 14px 20px; font-size: 14px; }
      .pin-input { width: 48px; height: 56px; font-size: 22px; }
    }

    /* ============ Touch-friendly improvements ============ */
    @media (hover: none) and (pointer: coarse) {
      /* Larger touch targets */
      .setup-edit, .learning-delete, .rule-delete, .tip-delete {
        opacity: 1;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .strategy-image-slider-nav { opacity: 1; }
      .strategy-image-delete { opacity: 1; width: 36px; height: 36px; }

      /* Remove hover effects */
      .setup-card:hover, .learning-card:hover, .learning-field:hover {
        transform: none;
      }
    }

    /* ============ Landscape phone ============ */
    @media (max-height: 500px) and (orientation: landscape) {
      .container { padding: 12px 24px; }
      .section { margin-bottom: 16px; }
      .modal-box { max-height: 90vh; overflow-y: auto; }
    }

    /* ============ Auth Modal ============ */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: #000000;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 20px;
    }
    .auth-box {
      background: #000000;
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 24px;
      padding: 48px 40px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      animation: slideUp 0.4s ease;
      -webkit-animation: slideUp 0.4s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      overflow-y: auto;
      align-items: center;
      gap: 28px;
    }
    .auth-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(13, 31, 13, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
    }
    .auth-badge-dot {
      width: 8px;
      height: 8px;
      background: #22C55E;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .auth-badge-text {
      font-size: 10px;
      font-weight: 600;
      color: #22C55E;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
    }
    .auth-logo {
      width: 96px;
      height: 96px;
      background: #111113;
      border: 2px solid #1E1E23;
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      position: relative;
      overflow: hidden;
    }
    .auth-logo::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0%;
      background: linear-gradient(to top, rgba(34, 197, 94, 0.15), transparent);
      animation: fillUp 2s ease-in-out infinite;
    }
    @keyframes fillUp {
      0% { height: 0%; }
      50% { height: 100%; }
      100% { height: 0%; }
    }
    .auth-logo-bars {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      z-index: 1;
    }
    .auth-logo-bar {
      height: 4px;
      background: #22C55E;
      border-radius: 2px;
      animation: barPulse 2s ease-in-out infinite;
    }
    .auth-logo-bar:nth-child(1) {
      width: 40px;
      animation-delay: 0.4s;
    }
    .auth-logo-bar:nth-child(2) {
      width: 28px;
      opacity: 0.7;
      animation-delay: 0.2s;
    }
    .auth-logo-bar:nth-child(3) {
      width: 16px;
      opacity: 0.4;
      animation-delay: 0s;
    }
    @keyframes barPulse {
      0%, 100% {
        transform: scaleX(1);
        box-shadow: none;
      }
      50% {
        transform: scaleX(1.1);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
      }
    }
    .auth-logo-text {
      font-size: 10px;
      font-weight: 700;
      color: #22C55E;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 2px;
      margin-top: 6px;
      z-index: 1;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
    }
    .auth-title-block {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .auth-title {
      font-size: 24px;
      font-weight: 700;
      color: #FFFFFF;
    }
    .auth-subtitle {
      font-size: 13px;
      color: #52525B;
    }
    .auth-question {
      font-size: 18px;
      font-weight: 500;
      color: #A1A1AA;
    }
    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }
    .auth-btn {
      width: 100%;
      padding: 16px 24px;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .auth-btn-primary {
      background: #22C55E;
      color: #000000;
    }
    .auth-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
    }
    .auth-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .auth-btn-guest {
      background: transparent;
      color: #52525B;
      font-weight: 500;
      font-size: 14px;
    }
    .auth-btn-guest:hover {
      color: #A1A1AA;
    }
    .auth-btn-back {
      background: none;
      border: none;
      color: #52525B;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
      padding: 8px 16px;
      transition: color 0.2s;
    }
    .auth-btn-back:hover {
      color: #A1A1AA;
    }
    /* PIN Step */
    .pin-inputs {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .pin-input {
      width: 56px;
      height: 64px;
      background: #111113;
      border: 2px solid #1E1E23;
      border-radius: 12px;
      font-size: 28px;
      font-weight: 700;
      color: #FFFFFF;
      text-align: center;
      outline: none;
      transition: all 0.2s;
    }
    .pin-input:focus {
      border-color: #22C55E;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }
    .pin-input.error {
      border-color: #EF4444;
      animation: shake 0.4s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    .auth-error {
      color: #EF4444;
      font-size: 13px;
      min-height: 20px;
    }

    /* ============ Guest Mode Restrictions ============ */
    body.guest-mode .editable,
    body.guest-mode [contenteditable="true"],
    body.guest-mode input:not(.pin-input),
    body.guest-mode textarea,
    body.guest-mode select {
      pointer-events: none !important;
      cursor: default !important;
    }
    /* Hide all add/delete/edit buttons */
    body.guest-mode .add-btn,
    body.guest-mode .add-setup-card,
    body.guest-mode .add-learning-card,
    body.guest-mode .add-rule-btn,
    body.guest-mode .setup-delete,
    body.guest-mode .learning-delete,
    body.guest-mode .learning-field-delete,
    body.guest-mode .learning-add-field,
    body.guest-mode .rule-delete,
    body.guest-mode .tip-delete,
    body.guest-mode .strategy-add-more,
    body.guest-mode .strategy-image-delete,
    body.guest-mode .profit-delete,
    body.guest-mode .profit-add-card,
    body.guest-mode .drop-zone,
    body.guest-mode .learning-add-row,
    body.guest-mode .clear-trades,
    body.guest-mode .trade-setup-reset,
    body.guest-mode .color-picker,
    body.guest-mode .strategy-image-upload,
    body.guest-mode .strategy-add-image {
      display: none !important;
    }
    /* Disable text selection */
    body.guest-mode {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    body.guest-mode *:not(.pin-input) {
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
    }
    /* Make inputs look non-editable */
    body.guest-mode input:not(.pin-input),
    body.guest-mode textarea {
      opacity: 0.8;
    }
    /* Hide setup color picker on hover */
    body.guest-mode .setup-icon {
      pointer-events: none;
    }

    /* Guest mode badge */
    .guest-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 16px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    .guest-badge-icon {
      font-size: 18px;
    }
    .guest-badge-text {
      font-size: 12px;
      color: #52525B;
      font-family: 'JetBrains Mono', monospace;
    }
    .guest-badge-exit {
      background: #22C55E;
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .guest-badge-exit:hover {
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4);
      transform: translateY(-1px);
    }

    /* ============ Landing Page ============ */
    .landing-page {
      position: fixed;
      inset: 0;
      background: #09090B;
      z-index: 10001;
      overflow-x: hidden;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }
    .landing-page.hidden {
      display: none;
    }

    /* Hero Section */
    .landing-hero {
      min-height: 70vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 40px;
      gap: 24px;
      background: radial-gradient(ellipse at center top, #1a0a2e 0%, #09090B 60%);
    }
    .landing-logo {
      display: flex;
      align-items: center;
      gap: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: clamp(32px, 6vw, 64px);
      flex-wrap: wrap;
      justify-content: center;
    }
    .landing-logo .kate {
      color: #22C55E;
      animation: landingKatePulse 4s ease-in-out infinite;
    }
    .landing-logo .divider {
      color: #27272A;
      font-weight: 300;
    }
    .landing-logo .maketa {
      color: #EF4444;
      animation: landingMaketaPulse 4s ease-in-out infinite;
      animation-delay: 2s;
    }
    @keyframes landingKatePulse {
      0%, 40%, 100% { opacity: 0.6; text-shadow: none; }
      20% { opacity: 1; text-shadow: 0 0 30px #22C55E, 0 0 60px #22C55E; }
    }
    @keyframes landingMaketaPulse {
      0%, 40%, 100% { opacity: 0.6; text-shadow: none; }
      20% { opacity: 1; text-shadow: 0 0 30px #EF4444, 0 0 60px #EF4444; }
    }
    .landing-tagline {
      color: #A1A1AA;
      font-size: clamp(18px, 3vw, 24px);
      text-align: center;
    }
    .landing-desc {
      color: #71717A;
      font-size: clamp(14px, 2vw, 18px);
      text-align: center;
      max-width: 600px;
    }
    .landing-cta {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
      color: #FFFFFF;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 600;
      padding: 14px 40px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
    }
    .landing-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.5);
    }

    /* Philosophy Section */
    .landing-section {
      padding: 48px 40px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .landing-section-label {
      color: #71717A;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 3px;
      text-align: center;
      margin-bottom: 12px;
    }
    .landing-section-title {
      color: #FFFFFF;
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 600;
      text-align: center;
      margin-bottom: 32px;
    }

    /* Philosophy Cards */
    .landing-philo-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .landing-philo-card {
      padding: 28px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .landing-philo-card.kate {
      background: #0a1f0a;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .landing-philo-card.maketa {
      background: #1f0a0a;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .landing-philo-kanji {
      font-size: 42px;
      font-weight: 700;
    }
    .landing-philo-card.kate .landing-philo-kanji { color: #22C55E; }
    .landing-philo-card.maketa .landing-philo-kanji { color: #EF4444; }
    .landing-philo-latin {
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 3px;
    }
    .landing-philo-card.kate .landing-philo-latin { color: #22C55E; }
    .landing-philo-card.maketa .landing-philo-latin { color: #EF4444; }
    .landing-philo-meaning {
      font-size: 16px;
    }
    .landing-philo-card.kate .landing-philo-meaning { color: #4ADE80; }
    .landing-philo-card.maketa .landing-philo-meaning { color: #F87171; }
    .landing-philo-desc {
      color: #A1A1AA;
      font-size: 15px;
      line-height: 1.6;
    }

    /* Features Section */
    .landing-features {
      background: #0d0d10;
      padding: 48px 40px;
    }
    .landing-features-inner {
      max-width: 1200px;
      margin: 0 auto;
    }
    .landing-features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .landing-feature-card {
      background: #13111C;
      padding: 24px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .landing-feature-icon {
      width: 32px;
      height: 32px;
    }
    .landing-feature-title {
      color: #FFFFFF;
      font-size: 20px;
      font-weight: 600;
    }
    .landing-feature-desc {
      color: #A1A1AA;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Audience Section */
    .landing-audience-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .landing-audience-card {
      background: #13111C;
      padding: 24px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
    }
    .landing-audience-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .landing-audience-icon.purple { background: rgba(139, 92, 246, 0.12); }
    .landing-audience-icon.green { background: rgba(34, 197, 94, 0.12); }
    .landing-audience-icon.orange { background: rgba(245, 158, 11, 0.12); }
    .landing-audience-icon.red { background: rgba(239, 68, 68, 0.12); }
    .landing-audience-title {
      color: #FFFFFF;
      font-size: 18px;
      font-weight: 600;
    }
    .landing-audience-desc {
      color: #A1A1AA;
      font-size: 14px;
    }

    /* CTA Footer */
    .landing-footer {
      padding: 48px 40px;
      text-align: center;
      background: radial-gradient(ellipse at center bottom, #1a0a2e 0%, #09090B 60%);
    }
    .landing-footer-title {
      color: #FFFFFF;
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 600;
      margin-bottom: 12px;
    }
    .landing-footer-desc {
      color: #71717A;
      font-size: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .landing-hero { padding: 40px 20px; min-height: 60vh; }
      .landing-section { padding: 32px 20px; }
      .landing-features { padding: 32px 20px; }
      .landing-footer { padding: 32px 20px; }
      .landing-philo-card { padding: 20px; }
      .landing-feature-card { padding: 20px; }
      .landing-audience-card { padding: 20px; }
      .landing-logo { font-size: clamp(20px, 5vw, 40px); gap: 8px; }
      .landing-philo-kanji { font-size: 32px; }
      .landing-philo-latin { font-size: 18px; }
    }
    @media (max-width: 480px) {
      .landing-hero { padding: 32px 16px; min-height: 50vh; gap: 16px; }
      .landing-section { padding: 24px 16px; }
      .landing-features { padding: 24px 16px; }
      .landing-footer { padding: 24px 16px; }
      .landing-logo { font-size: 18px; gap: 6px; }
      .landing-tagline { font-size: 16px; }
      .landing-desc { font-size: 14px; }
      .landing-cta { padding: 12px 32px; font-size: 14px; }
      .landing-section-title { font-size: 20px; margin-bottom: 24px; }
      .landing-philo-kanji { font-size: 28px; }
      .landing-philo-latin { font-size: 16px; }
      .landing-feature-title { font-size: 16px; }
      .landing-feature-desc { font-size: 13px; }
      .landing-audience-title { font-size: 16px; }
      .landing-audience-desc { font-size: 13px; }
      .landing-footer-title { font-size: 20px; }
      .landing-footer-desc { font-size: 14px; }
    }

  </style>
</head>
<body>
  <!-- Landing Page - DISABLED, using Firebase Auth now -->
  <div class="landing-page" id="landing-page" style="display:none">
    <!-- Hero -->
    <section class="landing-hero">
      <div class="landing-logo">
        <span class="kate" onclick="playKateVoice()" style="cursor:pointer">勝て KATE</span>
        <span class="divider">|</span>
        <span class="maketa" onclick="playMaketaVoice()" style="cursor:pointer">負けた MAKETA</span>
      </div>
      <p class="landing-tagline">Персональная торговая система для скальперов</p>
      <p class="landing-desc">Веди дневник сделок. Анализируй стратегии. Контролируй эмоции.</p>
      <button class="landing-cta" onclick="startLogin()">Войти</button>
    </section>

    <!-- Features -->
    <section class="landing-features">
      <div class="landing-features-inner">
        <p class="landing-section-label">ВОЗМОЖНОСТИ</p>
        <h2 class="landing-section-title">Всё для системной торговли</h2>

        <div class="landing-features-grid">
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            <h3 class="landing-feature-title">Обучение</h3>
            <p class="landing-feature-desc">База знаний с видео, заметками и трекером прогресса. Структурируй своё обучение трейдингу.</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <h3 class="landing-feature-title">Торговая стратегия</h3>
            <p class="landing-feature-desc">Опиши свою ТС: отбор монет, точка входа, стопы, тейки. Чек-листы для каждого этапа.</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <h3 class="landing-feature-title">Сетапы</h3>
            <p class="landing-feature-desc">Библиотека стратегий с автостатистикой: P&L, Win Rate, соотношение W/L по каждому сетапу.</p>
          </div>
        </div>

        <div class="landing-features-grid">
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#EC4899" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            <h3 class="landing-feature-title">Ментальная часть</h3>
            <p class="landing-feature-desc">Работа с психологией: записывай негативные мысли и переформулируй их в конструктивные установки.</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
            <h3 class="landing-feature-title">Журнал сделок</h3>
            <p class="landing-feature-desc">Импорт из CSV. Привязка к сетапам. Заметки по каждой сделке. Автобейджи KATE!/MAKETA!</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <h3 class="landing-feature-title">Планки по профиту</h3>
            <p class="landing-feature-desc">Устанавливай дневные цели. Визуальный прогресс до каждой планки. Контроль жадности.</p>
          </div>
        </div>

        <div class="landing-features-grid">
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#A1A1AA" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            <h3 class="landing-feature-title">Заметки рынка</h3>
            <p class="landing-feature-desc">Фиксируй особенности текущего рынка, паттерны и аномалии для быстрой адаптации.</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <h3 class="landing-feature-title">Корректировка ТС</h3>
            <p class="landing-feature-desc">Записывай выводы и улучшения. Итерируй над стратегией на основе реальных данных.</p>
          </div>
          <div class="landing-feature-card">
            <svg class="landing-feature-icon" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
            <h3 class="landing-feature-title">Облачная синхронизация</h3>
            <p class="landing-feature-desc">Firebase Realtime Database. Данные доступны с любого устройства. Автосохранение.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Audience -->
    <section class="landing-section">
      <p class="landing-section-label">ДЛЯ КОГО</p>
      <h2 class="landing-section-title">Кому подойдёт KATE?</h2>
      <div class="landing-audience-grid">
        <div class="landing-audience-card">
          <div class="landing-audience-icon purple">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </div>
          <h3 class="landing-audience-title">Скальперы</h3>
          <p class="landing-audience-desc">Быстрые сделки требуют чёткой системы и контроля эмоций</p>
        </div>
        <div class="landing-audience-card">
          <div class="landing-audience-icon green">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
          </div>
          <h3 class="landing-audience-title">Дейтрейдеры</h3>
          <p class="landing-audience-desc">Анализ сделок за день помогает находить рабочие паттерны</p>
        </div>
        <div class="landing-audience-card">
          <div class="landing-audience-icon orange">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          </div>
          <h3 class="landing-audience-title">Начинающие</h3>
          <p class="landing-audience-desc">Строй торговую систему с нуля по чёткой структуре</p>
        </div>
        <div class="landing-audience-card">
          <div class="landing-audience-icon red">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <h3 class="landing-audience-title">Работающие над дисциплиной</h3>
          <p class="landing-audience-desc">Контроль эмоций и следование правилам — ключ к прибыли</p>
        </div>
      </div>
    </section>

    <!-- Philosophy -->
    <section class="landing-section">
      <p class="landing-section-label">ФИЛОСОФИЯ</p>
      <div class="landing-philo-cards">
        <div class="landing-philo-card kate">
          <span class="landing-philo-kanji">勝て</span>
          <span class="landing-philo-latin">KATE</span>
          <span class="landing-philo-meaning">"Победа!" — повелительная форма</span>
          <p class="landing-philo-desc">Отмечай победы. Празднуй успешные сделки. Укрепляй уверенность в своей стратегии.</p>
        </div>
        <div class="landing-philo-card maketa">
          <span class="landing-philo-kanji">負けた</span>
          <span class="landing-philo-latin">MAKETA</span>
          <span class="landing-philo-meaning">"Проиграл" — прошедшее время</span>
          <p class="landing-philo-desc">Признавай поражения. Анализируй ошибки. Становись сильнее после каждой потери.</p>
        </div>
      </div>
    </section>

    <!-- Footer CTA -->
    <section class="landing-footer">
      <h2 class="landing-footer-title">Готов торговать системно?</h2>
      <p class="landing-footer-desc">Начни вести дневник сделок уже сегодня</p>
      <button class="landing-cta" onclick="startLogin()">Войти</button>
    </section>
  </div>

  <!-- Auth Modal (hidden by default, shown by JS) -->
  <div class="auth-overlay" id="auth-overlay" style="display:none">
    <div class="auth-box">
      <!-- Badge -->
      <div class="auth-badge">
        <div class="auth-badge-dot"></div>
        <span class="auth-badge-text">SECURE ACCESS</span>
      </div>

      <!-- Logo with bars -->
      <div class="auth-logo">
        <div class="auth-logo-bars">
          <div class="auth-logo-bar"></div>
          <div class="auth-logo-bar"></div>
          <div class="auth-logo-bar"></div>
        </div>
        <span class="auth-logo-text">PROFIT</span>
      </div>

      <!-- Title -->
      <div class="auth-title-block">
        <div class="auth-title">Торговая Система</div>
        <div class="auth-subtitle">Личный торговый журнал</div>
      </div>

      <!-- Step 1: Question -->
      <div id="auth-step-question" style="width: 100%;">
        <div class="auth-question">Ты Alex Koval?</div>

        <div class="auth-buttons" style="margin-top: 24px;">
          <button class="auth-btn auth-btn-primary" onclick="answerYes()">
            Да, войти
          </button>
          <button class="auth-btn auth-btn-guest" onclick="answerNo()">
            Войти как гость
          </button>
        </div>
      </div>

      <!-- Step 2: PIN -->
      <div id="auth-step-pin" style="display: none; width: 100%;">
        <div class="auth-subtitle" style="margin-bottom: 24px;">Введи пароль</div>

        <div class="pin-inputs">
          <input type="tel" class="pin-input" maxlength="1" data-pin="0" inputmode="numeric" pattern="[0-9]*">
          <input type="tel" class="pin-input" maxlength="1" data-pin="1" inputmode="numeric" pattern="[0-9]*">
          <input type="tel" class="pin-input" maxlength="1" data-pin="2" inputmode="numeric" pattern="[0-9]*">
          <input type="tel" class="pin-input" maxlength="1" data-pin="3" inputmode="numeric" pattern="[0-9]*">
        </div>

        <div class="auth-error" id="auth-error"></div>

        <div class="auth-buttons" style="margin-top: 24px;">
          <button class="auth-btn auth-btn-primary" id="auth-submit" disabled onclick="submitPin()">
            Войти
          </button>
        </div>

        <button class="auth-btn-back" onclick="goBackToQuestion()">
          ← Назад
        </button>
      </div>
    </div>
  </div>

  <!-- Guest Mode Badge -->
  <div class="guest-badge" id="guest-badge" style="display: none;">
    <span class="guest-badge-icon">👁</span>
    <span class="guest-badge-text">Режим просмотра</span>
    <button class="guest-badge-exit" onclick="exitGuestMode()">Войти</button>
  </div>

  <div id="main-container" class="container" style="display:none">
    <header class="page-header">
      <div class="title-section">
        <!-- Left side empty for balance -->
      </div>

      <!-- Center Logo -->
      <div class="kate-logo kate-logo-center">
        <span class="kate" onclick="playKateVoice()" style="cursor:pointer" title="Нажми чтобы услышать">勝て KATE<span class="exclaim">!</span></span>
        <span class="divider">|</span>
        <span class="maketa" onclick="playMaketaVoice()" style="cursor:pointer" title="Нажми чтобы услышать">負けた MAKETA<span class="exclaim">!</span></span>
      </div>
      <audio id="kate-audio" preload="none" src="kate-voice.mp3"></audio>
      <audio id="maketa-audio" preload="none" src="maketa-voice.mp3"></audio>

      <div class="reload-wrap header-right" style="display:flex;align-items:center;gap:16px;">
        <!-- User menu будет добавлен динамически через JS -->
        <div id="sync-status" style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--accent-success);">
          <span style="width:8px;height:8px;background:var(--accent-success);border-radius:50%;animation:pulse 2s infinite;"></span>
          <span>Синхронизировано</span>
        </div>
        <!-- КНОПКА ПОЛНОГО СОХРАНЕНИЯ -->
        <button class="save-all-btn" onclick="saveEverything()" title="Сохранить всё + скачать бэкап">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          <span>Сохранить</span>
        </button>
        <!-- КНОПКА ИСТОРИИ ВЕРСИЙ -->
        <button class="version-btn" onclick="openVersionPanel()" title="История версий">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </button>
        <button class="logout-btn" id="logout-btn" onclick="logout()" title="Выйти" style="display:none;">
          <span class="logout-icon">⏻</span>
        </button>
        <button class="reload-btn" onclick="location.reload()" title="Перезагрузить">
          <div class="reload-bar"></div>
          <div class="reload-bar"></div>
          <div class="reload-bar"></div>
        </button>
        <span class="reload-label">profit</span>
      </div>
    </header>

    <div class="divider"></div>

    <!-- Обучение -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: #3B82F6">◆</span>
        <span class="section-title">ОБУЧЕНИЕ</span>
      </div>
      <div class="learning-grid" id="learning-grid"></div>
    </section>

    <!-- Торговая стратегия -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: var(--accent-warning)">◆</span>
        <span class="section-title">ТОРГОВАЯ СТРАТЕГИЯ</span>
      </div>
      <div class="strategy-container">
        <!-- Табы сетапов -->
        <div class="strategy-slider">
          <button class="strategy-nav-btn" onclick="prevStrategy()" id="strategy-prev">‹</button>
          <div class="strategy-tabs" id="strategy-tabs"></div>
          <button class="strategy-nav-btn" onclick="nextStrategy()" id="strategy-next">›</button>
        </div>
        <!-- Текущий сетап -->
        <div class="strategy-current-setup" id="strategy-current"></div>

        <!-- Поля стратегии -->
        <div class="strategy-flow" id="strategy-flow"></div>
      </div>
    </section>

    <!-- Сетапы -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: var(--accent-primary)">◆</span>
        <span class="section-title">МОИ СЕТАПЫ</span>
      </div>
      <div class="setups-grid" id="setups-grid"></div>
    </section>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" onclick="closeImageModal()">
      <button class="image-modal-close" onclick="closeImageModal()">✕</button>
      <img id="modal-image" src="" alt="Preview">
    </div>

    <!-- Custom Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
      <div class="modal-box">
        <div class="modal-icon" id="modal-icon">⚠️</div>
        <div class="modal-title" id="modal-title">Подтверждение</div>
        <div class="modal-message" id="modal-message">Вы уверены?</div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeConfirm(false)">Отменить</button>
          <button class="modal-btn modal-btn-confirm" id="modal-confirm-btn" onclick="closeConfirm(true)">Удалить</button>
        </div>
      </div>
    </div>

    <!-- Custom Input Modal -->
    <div class="modal-overlay" id="input-modal">
      <div class="modal-box">
        <div class="modal-icon" id="input-modal-icon">☑️</div>
        <div class="modal-title" id="input-modal-title">Новый пункт</div>
        <div class="modal-message" id="input-modal-message">Введите текст:</div>
        <input type="text" class="modal-input" id="input-modal-field" placeholder="Введите пункт чек-листа...">
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeInputModal(null)">Отменить</button>
          <button class="modal-btn modal-btn-confirm success" id="input-modal-btn" onclick="submitInputModal()">Добавить</button>
        </div>
      </div>
    </div>

    <!-- Установки -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: var(--accent-warning)">◆</span>
        <span class="section-title">УСТАНОВКИ НА СДЕЛКИ</span>
      </div>
      <div class="rules-grid">
        <div class="rules-card do">
          <div class="rules-header">✓ ДЕЛАЙ</div>
          <ul class="rules-list" id="rules-do"></ul>
          <button class="add-btn" onclick="addRule('do')">+ Добавить правило</button>
        </div>
        <div class="rules-card dont">
          <div class="rules-header">✗ НЕ ДЕЛАЙ</div>
          <ul class="rules-list" id="rules-dont"></ul>
          <button class="add-btn" onclick="addRule('dont')">+ Добавить правило</button>
        </div>
      </div>
    </section>

    <!-- Ментальная часть -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: var(--accent-primary)">◆</span>
        <span class="section-title">МЕНТАЛЬНАЯ ЧАСТЬ</span>
      </div>
      <div class="card">
        <div class="mental-subtitle">МЫСЛЬ → ЭМОЦИЯ → ДЕЙСТВИЕ → РЕЗУЛЬТАТ</div>
        <div class="mental-grid">
          <div class="mental-col wrong">
            <div class="mental-title">Автоматическая мысль</div>
            <textarea class="mental-text" id="mental-wrong" placeholder="Опиши негативную автоматическую мысль..."></textarea>
          </div>
          <div class="mental-col right">
            <div class="mental-title">Правильная мысль</div>
            <textarea class="mental-text" id="mental-right" placeholder="Опиши правильную мысль..."></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- Журнал сделок -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: #3B82F6">◆</span>
        <span class="section-title">ЖУРНАЛ СДЕЛОК</span>
      </div>
      <div class="card">
        <div class="drop-zone" id="drop-zone">
          <span class="drop-icon">📄</span>
          <span class="drop-text">Загрузить CSV</span>
          <span class="drop-hint">перетащи или нажми</span>
          <input type="file" id="csv-input" accept=".csv" hidden>
        </div>
        <div class="stats-row">
          <div class="stat-card"><span class="stat-label">Всего сделок</span><span class="stat-value" id="stat-total">—</span></div>
          <div class="stat-card"><span class="stat-label">Win Rate</span><span class="stat-value success" id="stat-winrate">—%</span></div>
          <div class="stat-card"><span class="stat-label">Общий P&L</span><span class="stat-value" id="stat-pnl">—$</span></div>
          <div class="stat-card"><span class="stat-label">Лучшая стратегия</span><span class="stat-value accent" id="stat-best">—</span></div>
        </div>
        <div class="strat-badges" id="strat-badges"></div>
        <div id="checklist-stats"></div>
        <div class="trades-list" id="trades-list"></div>
        <button class="clear-trades" onclick="clearTrades()" style="margin-top: 16px">🗑 Очистить все сделки</button>
      </div>
    </section>

    <!-- Планки -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon" style="color: var(--accent-success)">◆</span>
        <span class="section-title">ПЛАНКИ ПО ПРОФИТУ</span>
      </div>
      <div class="card profit-card">
        <div class="profit-desc">Достиг профита → фиксируй планку (80%). Упал ниже планки → стоп торговли на день.</div>

        <!-- Deposit Input -->
        <div class="deposit-section">
          <div class="deposit-icon">💰</div>
          <div class="deposit-info">
            <div class="deposit-label">Текущий профит за день</div>
            <div class="deposit-input-wrap">
              <input type="number" class="deposit-input" id="current-deposit" placeholder="0" oninput="updateProfitBars()">
              <span class="deposit-currency">$</span>
            </div>
          </div>
          <div class="deposit-status safe" id="deposit-status">Торгуй</div>
        </div>

        <!-- Progress Bars -->
        <div class="profit-bars" id="profit-levels"></div>
        <button class="add-btn profit-add-card" onclick="addProfitLevel()">+ Добавить планку</button>
      </div>
    </section>

    <!-- Фишки + Корректировки -->
    <section class="section">
      <div class="tips-grid">
        <div class="card">
          <div class="card-title">ФИШКИ ТЕКУЩЕГО РЫНКА</div>
          <ul class="tips-list" id="market-tips"></ul>
          <button class="add-btn" onclick="addTip()">+ Добавить фишку</button>
        </div>
        <div class="card">
          <div class="card-title">КОРРЕКТИРОВКА ТС</div>
          <textarea class="correction-text" id="correction-text" placeholder="Напиши свои корректировки..."></textarea>
        </div>
      </div>
    </section>

    <footer class="footer">
      <span class="footer-quote">Нужна 1 чёткая сделка по ТС. Потом пауза. И ещё одна. Шаг = сделка.</span>
      <span class="footer-version">v4.0 • Multi-User System</span>
    </footer>
  </div>

  <!-- KATE Splash Screen (hidden by default, shown by JS) -->
  <div id="loading-overlay" class="splash-screen" style="display:none">
    <div class="splash-logo">
      <span class="splash-kate" onclick="playKateVoice()" style="cursor:pointer">勝て KATE<span class="splash-exclaim">!</span></span>
      <span class="splash-divider">|</span>
      <span class="splash-maketa" onclick="playMaketaVoice()" style="cursor:pointer">負けた MAKETA<span class="splash-exclaim">!</span></span>
    </div>
    <div class="splash-tagline">Trade with clarity</div>
  </div>
  <style>
    .splash-screen {
      position: fixed;
      inset: 0;
      background: #09090B;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      gap: 24px;
      overflow: hidden;
      /* Animation triggered via JS in startLogin() */
    }
    .splash-logo {
      display: flex;
      align-items: center;
      gap: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: clamp(24px, 6vw, 48px);
      flex-wrap: wrap;
      justify-content: center;
      padding: 0 20px;
      text-align: center;
    }
    .splash-kate {
      color: #22C55E;
      opacity: 0.3;
      animation: splashKate 3s ease-in-out forwards;
    }
    .splash-maketa {
      color: #EF4444;
      opacity: 0.3;
      animation: splashMaketa 3s ease-in-out forwards;
    }
    .splash-divider {
      color: #27272A;
      font-weight: 300;
    }
    .splash-exclaim {
      display: inline-block;
      opacity: 0;
      transform: scale(0.5);
    }
    .splash-kate .splash-exclaim {
      animation: splashKateEx 3s ease-in-out forwards;
    }
    .splash-maketa .splash-exclaim {
      animation: splashMaketaEx 3s ease-in-out forwards;
    }
    .splash-tagline {
      color: #71717A;
      font-size: 16px;
      letter-spacing: 3px;
      text-transform: uppercase;
      opacity: 0;
      animation: splashFadeIn 0.4s ease-out 2.2s forwards;
    }
    /* Простая последовательность: MAKETA, KATE, MAKETA, KATE — по 0.6s каждый */
    @keyframes splashMaketa {
      0%, 100% { opacity: 0.3; text-shadow: none; }
      /* 1st MAKETA: 0-0.6s (0-20%) */
      5%, 18% { opacity: 1; text-shadow: 0 0 30px #EF4444, 0 0 60px #EF4444; }
      20%, 45% { opacity: 0.3; text-shadow: none; }
      /* 2nd MAKETA: 1.2-1.8s (40-60%) */
      47%, 60% { opacity: 1; text-shadow: 0 0 30px #EF4444, 0 0 60px #EF4444; }
      62% { opacity: 0.3; text-shadow: none; }
    }
    @keyframes splashKate {
      0%, 100% { opacity: 0.3; text-shadow: none; }
      /* 1st KATE: 0.6-1.2s (20-40%) */
      22%, 38% { opacity: 1; text-shadow: 0 0 30px #22C55E, 0 0 60px #22C55E; }
      40%, 65% { opacity: 0.3; text-shadow: none; }
      /* 2nd KATE: 1.8-2.4s (60-80%) + hold */
      68%, 90% { opacity: 1; text-shadow: 0 0 40px #22C55E, 0 0 80px #22C55E; }
    }
    @keyframes splashMaketaEx {
      0%, 4%, 19%, 46%, 61%, 100% { opacity: 0; transform: scale(0.5); }
      8%, 16% { opacity: 1; transform: scale(1.15); }
      50%, 58% { opacity: 1; transform: scale(1.15); }
    }
    @keyframes splashKateEx {
      0%, 21%, 39%, 67%, 100% { opacity: 0; transform: scale(0.5); }
      26%, 36% { opacity: 1; transform: scale(1.15); }
      72%, 90% { opacity: 1; transform: scale(1.2); }
    }
    @keyframes splashFadeIn {
      to { opacity: 1; }
    }
    @keyframes splashFadeOut {
      to { opacity: 0; pointer-events: none; }
    }
  </style>

  <!-- ============ AUTH SCREENS ============ -->
  <div id="auth-container" class="auth-container" style="display:none">

    <!-- LOGIN SCREEN -->
    <div id="auth-login" class="auth-screen">
      <div class="auth-content">
        <div class="auth-logo">
          <span class="auth-kate">勝て KATE</span>
          <span class="auth-divider">|</span>
          <span class="auth-maketa">負けた MAKETA</span>
        </div>
        <div class="auth-subtitle">TRADING SYSTEM</div>

        <div class="auth-form">
          <label class="auth-label">EMAIL</label>
          <input type="email" id="login-email" class="auth-input" placeholder="your@email.com" autocomplete="email">

          <label class="auth-label">PASSWORD</label>
          <input type="password" id="login-password" class="auth-input" placeholder="••••••••" autocomplete="current-password">

          <div class="auth-link-row">
            <a href="#" onclick="showAuthScreen('recovery')" class="auth-link">Forgot password?</a>
          </div>

          <button class="auth-btn auth-btn-primary" onclick="loginWithEmail()">LOGIN</button>

          <div class="auth-divider-line">
            <span>OR</span>
          </div>

          <button class="auth-btn auth-btn-google" onclick="loginWithGoogle()">
            <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continue with Google
          </button>

          <div class="auth-footer-link">
            Don't have an account? <a href="#" onclick="showAuthScreen('register')">Register</a>
          </div>
        </div>

        <div class="auth-creator-note">
          <div>Created by Alex Koval</div>
          <div>Version 4.0 • Multi-User</div>
        </div>
      </div>
    </div>

    <!-- REGISTER SCREEN -->
    <div id="auth-register" class="auth-screen" style="display:none">
      <div class="auth-content">
        <div class="auth-logo">
          <span class="auth-kate">勝て KATE</span>
          <span class="auth-divider">|</span>
          <span class="auth-maketa">負けた MAKETA</span>
        </div>
        <div class="auth-subtitle">CREATE ACCOUNT</div>

        <div class="auth-form">
          <label class="auth-label">FULL NAME</label>
          <input type="text" id="register-name" class="auth-input" placeholder="Your Name" autocomplete="name">

          <label class="auth-label">EMAIL</label>
          <input type="email" id="register-email" class="auth-input" placeholder="your@email.com" autocomplete="email">

          <label class="auth-label">PASSWORD</label>
          <input type="password" id="register-password" class="auth-input" placeholder="Minimum 8 characters" autocomplete="new-password">

          <label class="auth-label">CONFIRM PASSWORD</label>
          <input type="password" id="register-password-confirm" class="auth-input" placeholder="••••••••" autocomplete="new-password">

          <button class="auth-btn auth-btn-primary" onclick="registerWithEmail()">CREATE ACCOUNT</button>

          <div class="auth-divider-line">
            <span>OR</span>
          </div>

          <button class="auth-btn auth-btn-google" onclick="loginWithGoogle()">
            <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign up with Google
          </button>

          <div class="auth-footer-link">
            Already have an account? <a href="#" onclick="showAuthScreen('login')">Login</a>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSWORD RECOVERY SCREEN -->
    <div id="auth-recovery" class="auth-screen" style="display:none">
      <div class="auth-content">
        <div class="auth-logo">
          <span class="auth-kate">勝て KATE</span>
          <span class="auth-divider">|</span>
          <span class="auth-maketa">負けた MAKETA</span>
        </div>
        <div class="auth-subtitle">RESET PASSWORD</div>
        <div class="auth-description">Enter your email address and we'll send you a link to reset your password.</div>

        <div class="auth-form">
          <label class="auth-label">EMAIL</label>
          <input type="email" id="recovery-email" class="auth-input" placeholder="your@email.com" autocomplete="email">

          <button class="auth-btn auth-btn-primary" onclick="sendPasswordReset()">SEND RESET LINK</button>

          <div class="auth-back-link">
            <a href="#" onclick="showAuthScreen('login')">← Back to Login</a>
          </div>
        </div>
      </div>
    </div>

    <!-- PIN SETUP SCREEN -->
    <div id="auth-pin-setup" class="auth-screen" style="display:none">
      <div class="auth-content">
        <div class="auth-logo">
          <span class="auth-kate">勝て KATE</span>
          <span class="auth-divider">|</span>
          <span class="auth-maketa">負けた MAKETA</span>
        </div>
        <div class="auth-subtitle">CREATE QUICK PIN</div>
        <div class="auth-description">Set up a 4-digit PIN for faster access on this device</div>

        <div class="pin-dots" id="pin-setup-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>

        <div class="pin-keypad" id="pin-setup-keypad">
          <button class="pin-key" onclick="enterPinDigit('setup', '1')">1</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '2')">2</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '3')">3</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '4')">4</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '5')">5</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '6')">6</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '7')">7</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '8')">8</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '9')">9</button>
          <button class="pin-key pin-key-skip" onclick="skipPinSetup()">Skip</button>
          <button class="pin-key" onclick="enterPinDigit('setup', '0')">0</button>
          <button class="pin-key pin-key-back" onclick="deletePinDigit('setup')">⌫</button>
        </div>
      </div>
    </div>

    <!-- PIN ENTRY SCREEN -->
    <div id="auth-pin-entry" class="auth-screen" style="display:none">
      <div class="auth-content">
        <div class="pin-avatar" id="pin-avatar">AK</div>
        <div class="pin-welcome" id="pin-welcome">Welcome back, Alex</div>
        <div class="auth-subtitle">ENTER YOUR PIN</div>

        <div class="pin-dots" id="pin-entry-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>

        <div class="pin-error" id="pin-error" style="display:none">Wrong PIN. Try again.</div>

        <div class="pin-keypad" id="pin-entry-keypad">
          <button class="pin-key" onclick="enterPinDigit('entry', '1')">1</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '2')">2</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '3')">3</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '4')">4</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '5')">5</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '6')">6</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '7')">7</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '8')">8</button>
          <button class="pin-key" onclick="enterPinDigit('entry', '9')">9</button>
          <button class="pin-key pin-key-empty"></button>
          <button class="pin-key" onclick="enterPinDigit('entry', '0')">0</button>
          <button class="pin-key pin-key-back" onclick="deletePinDigit('entry')">⌫</button>
        </div>

        <div class="pin-attempts" id="pin-attempts">3 attempts remaining</div>
        <a href="#" class="pin-switch-account" onclick="showAuthScreen('login')">Use different account</a>
      </div>
    </div>

    <!-- AUTH ERROR MESSAGE -->
    <div id="auth-error" class="auth-error" style="display:none"></div>
  </div>

  <style>
    /* ============ AUTH STYLES ============ */
    .auth-container {
      position: fixed;
      inset: 0;
      background: #09090B;
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-screen {
      width: 100%;
      max-width: 420px;
      padding: 40px 24px;
    }
    .auth-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .auth-container .auth-logo {
      width: auto !important;
      height: auto !important;
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 10px !important;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 20px;
      flex-wrap: wrap;
      position: static !important;
      overflow: visible !important;
    }
    .auth-container .auth-logo::before {
      display: none !important;
    }
    .auth-container .auth-kate { color: #22C55E; }
    .auth-container .auth-maketa { color: #EF4444; }
    .auth-container .auth-divider { color: #27272A; font-weight: 300; }
    .auth-subtitle {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #71717A;
      letter-spacing: 4px;
      text-transform: uppercase;
    }
    .auth-description {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #52525B;
      text-align: center;
      line-height: 1.6;
      max-width: 320px;
    }
    .auth-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    .auth-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 500;
      color: #A1A1AA;
      letter-spacing: 2px;
      margin-top: 8px;
    }
    .auth-input {
      width: 100%;
      height: 48px;
      background: #18181B;
      border: 1px solid #27272A;
      border-radius: 0;
      padding: 0 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: #FFFFFF;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-input:focus {
      border-color: #22C55E;
    }
    .auth-input::placeholder {
      color: #52525B;
    }
    .auth-btn {
      width: 100%;
      height: 48px;
      border: none;
      border-radius: 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.2s;
      margin-top: 8px;
    }
    .auth-btn-primary {
      background: #22C55E;
      color: #09090B;
    }
    .auth-btn-primary:hover {
      background: #16A34A;
    }
    .auth-btn-primary:disabled {
      background: #27272A;
      color: #52525B;
      cursor: not-allowed;
    }
    .auth-btn-google {
      background: #18181B;
      border: 1px solid #27272A;
      color: #FFFFFF;
      font-weight: 400;
      letter-spacing: 0;
    }
    .auth-btn-google:hover {
      background: #27272A;
    }
    .auth-link-row {
      display: flex;
      justify-content: flex-end;
    }
    .auth-link {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #22C55E;
      text-decoration: none;
    }
    .auth-link:hover {
      text-decoration: underline;
    }
    .auth-divider-line {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 8px 0;
    }
    .auth-divider-line::before,
    .auth-divider-line::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #27272A;
    }
    .auth-divider-line span {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #52525B;
    }
    .auth-footer-link {
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #71717A;
      margin-top: 16px;
    }
    .auth-footer-link a {
      color: #22C55E;
      font-weight: 600;
      text-decoration: none;
    }
    .auth-footer-link a:hover {
      text-decoration: underline;
    }
    .auth-back-link {
      text-align: center;
      margin-top: 24px;
    }
    .auth-back-link a {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #22C55E;
      text-decoration: none;
    }
    .auth-creator-note {
      margin-top: 32px;
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #3F3F46;
      line-height: 1.6;
    }
    .auth-error {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #7F1D1D;
      border: 1px solid #EF4444;
      color: #FCA5A5;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      z-index: 10000;
      animation: authErrorIn 0.3s ease-out;
    }
    @keyframes authErrorIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* PIN Styles */
    .pin-avatar {
      width: 64px;
      height: 64px;
      background: #22C55E;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      color: #09090B;
    }
    .pin-welcome {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 600;
      color: #FFFFFF;
    }
    .pin-dots {
      display: flex;
      gap: 20px;
      margin: 24px 0;
    }
    .pin-dot {
      width: 56px;
      height: 56px;
      background: #18181B;
      border: 1px solid #27272A;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pin-dot.filled {
      border-color: #22C55E;
    }
    .pin-dot.filled::after {
      content: '•';
      font-size: 32px;
      color: #22C55E;
    }
    .pin-dot.error {
      border-color: #EF4444;
      animation: pinShake 0.4s ease-out;
    }
    @keyframes pinShake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .pin-keypad {
      display: grid;
      grid-template-columns: repeat(3, 64px);
      gap: 12px;
      margin-top: 16px;
    }
    .pin-key {
      width: 64px;
      height: 52px;
      background: #18181B;
      border: none;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px;
      font-weight: 500;
      color: #FFFFFF;
      cursor: pointer;
      transition: background 0.15s;
    }
    .pin-key:hover {
      background: #27272A;
    }
    .pin-key:active {
      background: #3F3F46;
    }
    .pin-key-skip,
    .pin-key-back {
      background: transparent;
      font-size: 12px;
      color: #71717A;
    }
    .pin-key-back {
      font-size: 24px;
    }
    .pin-key-empty {
      background: transparent;
      cursor: default;
    }
    .pin-key-empty:hover {
      background: transparent;
    }
    .pin-error {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #EF4444;
      margin-top: 8px;
    }
    .pin-attempts {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #52525B;
      margin-top: 24px;
    }
    .pin-switch-account {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #22C55E;
      text-decoration: none;
      margin-top: 8px;
    }
    .pin-switch-account:hover {
      text-decoration: underline;
    }

    /* User menu in header */
    .user-menu-btn {
      width: 40px;
      height: 40px;
      background: #22C55E;
      border: none;
      border-radius: 50%;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      color: #09090B;
      cursor: pointer;
      transition: all 0.2s;
    }
    .user-menu-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: #18181B;
      border: 1px solid #27272A;
      border-radius: 12px;
      padding: 8px;
      min-width: 200px;
      display: none;
      z-index: 1000;
    }
    .user-dropdown.show {
      display: block;
    }
    .user-dropdown-header {
      padding: 12px;
      border-bottom: 1px solid #27272A;
      margin-bottom: 8px;
    }
    .user-dropdown-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 600;
      color: #FFFFFF;
    }
    .user-dropdown-email {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #71717A;
      margin-top: 2px;
    }
    .user-dropdown-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 2px 8px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid #22C55E;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      font-weight: 600;
      color: #22C55E;
      letter-spacing: 1px;
    }
    .user-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #A1A1AA;
      cursor: pointer;
      transition: all 0.15s;
    }
    .user-dropdown-item:hover {
      background: #27272A;
      color: #FFFFFF;
    }
    .user-dropdown-item.danger {
      color: #EF4444;
    }
    .user-dropdown-item.danger:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    /* ============ AUTH RESPONSIVE STYLES ============ */

    /* Tablet (768px - 1024px) */
    @media (max-width: 1024px) {
      .auth-screen {
        max-width: 380px;
        padding: 32px 20px;
      }
      .auth-container .auth-logo {
        font-size: 18px !important;
        gap: 8px !important;
      }
      .pin-dots {
        gap: 16px;
      }
      .pin-dot {
        width: 50px;
        height: 50px;
      }
      .pin-keypad {
        grid-template-columns: repeat(3, 60px);
        gap: 10px;
      }
      .pin-key {
        width: 60px;
        height: 48px;
        font-size: 22px;
      }
    }

    /* Mobile (max 768px) */
    @media (max-width: 768px) {
      .auth-container {
        padding: 20px 16px;
        align-items: flex-start;
        padding-top: 60px;
      }
      .auth-screen {
        max-width: 100%;
        padding: 24px 16px;
      }
      .auth-container .auth-logo {
        font-size: 16px !important;
        gap: 6px !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
      }
      .auth-subtitle {
        font-size: 12px;
        letter-spacing: 3px;
      }
      .auth-description {
        font-size: 12px;
      }
      .auth-form {
        gap: 10px;
      }
      .auth-input {
        height: 44px;
        font-size: 16px; /* Prevents iOS zoom on focus */
        -webkit-appearance: none;
        border-radius: 0;
      }
      .auth-btn {
        height: 44px;
        font-size: 13px;
      }
      .auth-label {
        font-size: 10px;
      }
      .pin-avatar {
        width: 56px;
        height: 56px;
        font-size: 20px;
      }
      .pin-welcome {
        font-size: 16px;
      }
      .pin-dots {
        gap: 12px;
        margin: 20px 0;
      }
      .pin-dot {
        width: 48px;
        height: 48px;
        border-radius: 6px;
      }
      .pin-dot.filled::after {
        font-size: 28px;
      }
      .pin-keypad {
        grid-template-columns: repeat(3, 56px);
        gap: 8px;
        margin-top: 12px;
      }
      .pin-key {
        width: 56px;
        height: 44px;
        font-size: 20px;
        border-radius: 6px;
      }
      .pin-error {
        font-size: 12px;
      }
      .pin-attempts {
        font-size: 10px;
      }
      .auth-creator-note {
        margin-top: 24px;
        font-size: 10px;
      }
      .user-menu-btn {
        width: 36px;
        height: 36px;
        font-size: 12px;
      }
      .user-dropdown {
        min-width: 180px;
        right: -10px;
      }
      .user-dropdown-header {
        padding: 10px;
      }
      .user-dropdown-name {
        font-size: 13px;
      }
      .user-dropdown-email {
        font-size: 10px;
      }
      .user-dropdown-item {
        padding: 8px 10px;
        font-size: 12px;
      }
    }

    /* Small Mobile (max 480px) */
    @media (max-width: 480px) {
      .auth-container {
        padding-top: 40px;
      }
      .auth-container .auth-logo {
        font-size: 14px !important;
      }
      .pin-dots {
        gap: 10px;
      }
      .pin-dot {
        width: 44px;
        height: 44px;
      }
      .pin-keypad {
        grid-template-columns: repeat(3, 52px);
        gap: 6px;
      }
      .pin-key {
        width: 52px;
        height: 42px;
        font-size: 18px;
      }
    }

    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      .auth-input {
        font-size: 16px !important; /* Prevent zoom on focus */
      }
      .pin-key {
        -webkit-tap-highlight-color: transparent;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .auth-btn:hover {
        background: #22C55E; /* Remove hover effect on touch */
      }
      .auth-btn-google:hover {
        background: #18181B;
      }
      .pin-key:hover {
        background: #18181B;
      }
      .pin-key:active {
        background: #27272A;
        transform: scale(0.95);
      }
      .auth-input:focus {
        outline: none;
        border-color: #22C55E;
      }
    }

    /* Landscape phone orientation */
    @media (max-height: 500px) and (orientation: landscape) {
      .auth-container {
        padding-top: 20px;
        align-items: flex-start;
        overflow-y: auto;
      }
      .auth-content {
        gap: 12px;
      }
      .pin-dots {
        margin: 12px 0;
      }
      .pin-keypad {
        margin-top: 8px;
      }
      .auth-creator-note {
        margin-top: 16px;
      }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .auth-input,
      .auth-btn,
      .pin-key {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
    }

    /* Dark mode system preference (already dark, but ensure consistency) */
    @media (prefers-color-scheme: dark) {
      .auth-container {
        background: #09090B;
      }
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      .pin-dot.error {
        animation: none;
      }
      .auth-error {
        animation: none;
      }
      * {
        transition-duration: 0.01ms !important;
      }
    }
  </style>

<!-- Toast уведомление о сохранении -->
<div class="save-toast" id="save-toast">
  <button class="save-toast-close" onclick="hideSaveToast()">✕</button>
  <div class="save-toast-header">
    <div class="save-toast-icon">✓</div>
    <div class="save-toast-title">Всё сохранено!</div>
  </div>
  <div class="save-toast-list">
    <div class="save-toast-item">
      <span class="save-toast-item-icon">☁️</span>
      <span class="save-toast-item-text">Firebase (облако)</span>
      <span class="save-toast-item-status" id="toast-firebase-status">✓</span>
    </div>
    <div class="save-toast-item">
      <span class="save-toast-item-icon">💾</span>
      <span class="save-toast-item-text">Браузер (localStorage)</span>
      <span class="save-toast-item-status">✓</span>
    </div>
  </div>
</div>

<!-- Панель истории версий -->
<div class="version-overlay" id="version-overlay" onclick="closeVersionPanel()"></div>
<div class="version-panel" id="version-panel">
  <div class="version-panel-header">
    <div class="version-panel-title">
      <span>📋</span> История версий
    </div>
    <button class="version-panel-close" onclick="closeVersionPanel()">✕</button>
  </div>
  <div class="version-list" id="version-list">
    <div class="version-empty">
      <div class="version-empty-icon">📭</div>
      <div>Нет сохранённых версий</div>
      <div style="margin-top:8px;font-size:12px;">Нажмите "Сохранить" чтобы создать первую версию</div>
    </div>
  </div>
  <div class="version-panel-footer">
    <div style="display:flex;gap:10px;margin-bottom:10px;">
      <button class="version-download-btn" onclick="downloadBackup()">
        <span>⬇️</span> Скачать
      </button>
      <button class="version-import-btn" onclick="document.getElementById('backup-file-input').click()">
        <span>📂</span> Загрузить
      </button>
    </div>
    <input type="file" id="backup-file-input" accept=".json" style="display:none" onchange="handleBackupFileSelect(event)">
  </div>
</div>

<!-- Firebase SDK - loaded dynamically with fallback -->
<script>
// ============ Firebase Config ============
const firebaseConfig = {
  apiKey: "AIzaSyAovnwR3OKsiWzsS2GBleZlCY-INluhgHI",
  authDomain: "trading-system-6d836.firebaseapp.com",
  databaseURL: "https://trading-system-6d836-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "trading-system-6d836",
  storageBucket: "trading-system-6d836.firebasestorage.app",
  messagingSenderId: "63731762156",
  appId: "1:63731762156:web:efed364455df68c72736c9"
};

// Firebase variables (will be set if SDK loads)
let db = null;
let dbRef = null;
let firebaseAvailable = false;
let auth = null;
let currentUser = null;
let userProfile = null;

// Creator UID - первый пользователь системы (Alex Koval)
const CREATOR_EMAIL = 'alex@kate-trading.com'; // Замени на свой email при первой регистрации

// Device ID для PIN-авторизации
function getDeviceId() {
  let deviceId = localStorage.getItem('kate_device_id');
  if (!deviceId) {
    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('kate_device_id', deviceId);
  }
  return deviceId;
}

// SHA-256 хэширование PIN
async function hashPin(pin) {
  const encoder = new TextEncoder();
  const data = encoder.encode(pin + '_kate_secure_salt_2024_' + getDeviceId());
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Load Firebase SDK dynamically with timeout
function loadFirebaseSDK() {
  return new Promise((resolve) => {
    const timeout = setTimeout(() => {
      console.log('⚠️ Firebase SDK не загружен (таймаут)');
      resolve(false);
    }, 6000);

    const script1 = document.createElement('script');
    script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
    script1.onload = () => {
      const script2 = document.createElement('script');
      script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js';
      script2.onload = () => {
        // Загружаем Auth SDK
        const script3 = document.createElement('script');
        script3.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
        script3.onload = () => {
          clearTimeout(timeout);
          try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            // dbRef будет установлен после авторизации пользователя
            firebaseAvailable = true;
            console.log('✅ Firebase SDK + Auth загружен');
            resolve(true);
          } catch (e) {
            console.log('⚠️ Firebase init error:', e);
            resolve(false);
          }
        };
        script3.onerror = () => {
          clearTimeout(timeout);
          console.log('⚠️ Firebase Auth SDK не загружен');
          resolve(false);
        };
        document.head.appendChild(script3);
      };
      script2.onerror = () => {
        clearTimeout(timeout);
        console.log('⚠️ Firebase database SDK не загружен');
        resolve(false);
      };
      document.head.appendChild(script2);
    };
    script1.onerror = () => {
      clearTimeout(timeout);
      console.log('⚠️ Firebase app SDK не загружен');
      resolve(false);
    };
    document.head.appendChild(script1);
  });
}

// ============ Breakout Chart Animation Replay ============
function replayBreakoutAnimation() {
  const chart = document.getElementById('breakout-chart');
  if (!chart) return;

  // Clone and replace to restart all CSS animations
  const clone = chart.cloneNode(true);
  chart.parentNode.replaceChild(clone, chart);
}

// Replay animation every 5 seconds (animation ~3s + short pause)
setInterval(replayBreakoutAnimation, 5000);

// ============ Storage (Firebase + localStorage fallback) ============
let firebaseData = {};
let isFirebaseReady = false;
let userHasInteracted = false; // КРИТИЧНО: запись в Firebase ТОЛЬКО после действия пользователя

// Слушаем реальное взаимодействие пользователя
['click', 'keydown', 'touchstart'].forEach(event => {
  document.addEventListener(event, function enableFirebaseWrites() {
    if (!userHasInteracted) {
      userHasInteracted = true;
      console.log('✅ Пользователь взаимодействовал - запись в Firebase разрешена');
    }
  }, { once: false, passive: true });
});

const storage = {
  get(key, def = null) {
    // ПРИОРИТЕТ: Firebase данные ВСЕГДА главнее localStorage
    if (isFirebaseReady && firebaseData[key] !== undefined) {
      return firebaseData[key];
    }
    // Fallback to localStorage только если Firebase недоступен
    try {
      const data = localStorage.getItem('ts_' + key);
      return data ? JSON.parse(data) : def;
    } catch { return def; }
  },

  set(key, value) {
    // ========== КРИТИЧЕСКАЯ ЗАЩИТА ==========

    // ЗАЩИТА 1: НЕ писать НИЧЕГО пока Firebase не загрузился
    // Это предотвращает перезапись данных при открытии на другом устройстве
    if (!isFirebaseReady) {
      console.log(`🛡️ ЗАЩИТА: блокировка записи ${key} (Firebase ещё не загружен)`);
      return;
    }

    // ЗАЩИТА 2: НЕ писать пока пользователь не сделал реальное действие
    if (!userHasInteracted) {
      console.log(`🛡️ ЗАЩИТА: блокировка записи ${key} (нет взаимодействия пользователя)`);
      return;
    }

    // ЗАЩИТА 3: Не перезаписывать данные пустыми значениями
    const protectedKeys = ['learning_topics', 'setups', 'strategies', 'trades', 'rules_do', 'rules_dont', 'tips', 'profit_levels'];
    if (protectedKeys.includes(key)) {
      const isEmpty = !value || (Array.isArray(value) && value.length === 0) ||
        (typeof value === 'object' && Object.keys(value).length === 0);
      const hasExistingData = firebaseData[key] &&
        (Array.isArray(firebaseData[key]) ? firebaseData[key].length > 0 :
         typeof firebaseData[key] === 'object' ? Object.keys(firebaseData[key]).length > 0 : true);

      if (isEmpty && hasExistingData) {
        console.log(`⚠️ ЗАЩИТА: блокировка перезаписи ${key} пустыми данными`);
        return;
      }
    }

    // Сохраняем в память
    firebaseData[key] = value;

    // Сохраняем в Firebase
    if (firebaseAvailable && dbRef) {
      try {
        dbRef.child(key).set(value);
        console.log(`✅ Сохранено в Firebase: ${key}`);
      } catch (e) {
        console.log('Firebase write error:', e);
      }
    }

    // Бэкап в localStorage
    localStorage.setItem('ts_' + key, JSON.stringify(value));
  }
};

// ============ AUTHENTICATION SYSTEM ============

// PIN state
let currentPinMode = null; // 'setup' or 'entry'
let currentPin = '';
let pinAttempts = 3;
let setupPinStep = 1; // 1 = enter, 2 = confirm
let setupPinFirst = '';

// Show auth screen
function showAuthScreen(screen) {
  const screens = ['login', 'register', 'recovery', 'pin-setup', 'pin-entry'];
  screens.forEach(s => {
    const el = document.getElementById('auth-' + s);
    if (el) el.style.display = s === screen ? 'block' : 'none';
  });

  // Clear inputs when switching
  if (screen === 'login') {
    document.getElementById('login-email').value = '';
    document.getElementById('login-password').value = '';
  } else if (screen === 'register') {
    document.getElementById('register-name').value = '';
    document.getElementById('register-email').value = '';
    document.getElementById('register-password').value = '';
    document.getElementById('register-password-confirm').value = '';
  } else if (screen === 'recovery') {
    document.getElementById('recovery-email').value = '';
  }

  hideAuthError();
}

// Show auth error
function showAuthError(message) {
  const el = document.getElementById('auth-error');
  el.textContent = message;
  el.style.display = 'block';
  setTimeout(() => hideAuthError(), 5000);
}

function hideAuthError() {
  const el = document.getElementById('auth-error');
  if (el) el.style.display = 'none';
}

// Register with email
async function registerWithEmail() {
  const name = document.getElementById('register-name').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const password = document.getElementById('register-password').value;
  const passwordConfirm = document.getElementById('register-password-confirm').value;

  if (!name) {
    showAuthError('Please enter your name');
    return;
  }
  if (!email) {
    showAuthError('Please enter your email');
    return;
  }
  if (password.length < 8) {
    showAuthError('Password must be at least 8 characters');
    return;
  }
  if (password !== passwordConfirm) {
    showAuthError('Passwords do not match');
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    // Update display name
    await user.updateProfile({ displayName: name });

    // Create user profile in database
    const isCreator = email.toLowerCase() === CREATOR_EMAIL.toLowerCase();
    userProfile = {
      name: name,
      email: email,
      role: isCreator ? 'creator' : 'user',
      created_at: new Date().toISOString(),
      pin_hash: null,
      devices: {}
    };

    // Save profile to Firebase
    await db.ref('users/' + user.uid + '/profile').set(userProfile);

    currentUser = user;
    console.log('✅ Регистрация успешна:', email);

    // Offer PIN setup
    showAuthScreen('pin-setup');

  } catch (error) {
    console.error('Registration error:', error);
    if (error.code === 'auth/email-already-in-use') {
      showAuthError('This email is already registered');
    } else if (error.code === 'auth/invalid-email') {
      showAuthError('Invalid email address');
    } else if (error.code === 'auth/weak-password') {
      showAuthError('Password is too weak');
    } else {
      showAuthError(error.message);
    }
  }
}

// Login with email
async function loginWithEmail() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;

  if (!email || !password) {
    showAuthError('Please enter email and password');
    return;
  }

  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;

    // Load user profile
    await loadUserProfile();

    // Check if this device has PIN
    const deviceId = getDeviceId();
    if (userProfile && userProfile.pin_hash && userProfile.devices && userProfile.devices[deviceId]) {
      // Device registered with PIN - proceed to app
      await completeLogin();
    } else if (userProfile && userProfile.pin_hash) {
      // User has PIN but not on this device - offer to add
      showAuthScreen('pin-setup');
    } else {
      // No PIN set - offer to create
      showAuthScreen('pin-setup');
    }

  } catch (error) {
    console.error('Login error:', error);
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      showAuthError('Invalid email or password');
    } else if (error.code === 'auth/invalid-email') {
      showAuthError('Invalid email address');
    } else if (error.code === 'auth/too-many-requests') {
      showAuthError('Too many failed attempts. Try again later.');
    } else {
      showAuthError(error.message);
    }
  }
}

// Login with Google
async function loginWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);
    currentUser = result.user;

    // Check if user profile exists
    const profileSnapshot = await db.ref('users/' + currentUser.uid + '/profile').once('value');

    if (profileSnapshot.val()) {
      userProfile = profileSnapshot.val();
    } else {
      // Create new profile for Google user
      const isCreator = currentUser.email.toLowerCase() === CREATOR_EMAIL.toLowerCase();
      userProfile = {
        name: currentUser.displayName || 'User',
        email: currentUser.email,
        role: isCreator ? 'creator' : 'user',
        created_at: new Date().toISOString(),
        pin_hash: null,
        devices: {}
      };
      await db.ref('users/' + currentUser.uid + '/profile').set(userProfile);
    }

    console.log('✅ Google вход успешен:', currentUser.email);

    // Check for PIN
    const deviceId = getDeviceId();
    if (userProfile.pin_hash && userProfile.devices && userProfile.devices[deviceId]) {
      await completeLogin();
    } else {
      showAuthScreen('pin-setup');
    }

  } catch (error) {
    console.error('Google login error:', error);
    if (error.code === 'auth/popup-closed-by-user') {
      // User closed popup - do nothing
    } else {
      showAuthError(error.message);
    }
  }
}

// Send password reset
async function sendPasswordReset() {
  const email = document.getElementById('recovery-email').value.trim();

  if (!email) {
    showAuthError('Please enter your email');
    return;
  }

  try {
    await auth.sendPasswordResetEmail(email);
    showAuthError('Password reset link sent to ' + email); // Using error display for success too
    setTimeout(() => showAuthScreen('login'), 3000);
  } catch (error) {
    console.error('Password reset error:', error);
    if (error.code === 'auth/user-not-found') {
      showAuthError('No account found with this email');
    } else if (error.code === 'auth/invalid-email') {
      showAuthError('Invalid email address');
    } else {
      showAuthError(error.message);
    }
  }
}

// Load user profile from Firebase
async function loadUserProfile() {
  if (!currentUser) return;

  try {
    const snapshot = await db.ref('users/' + currentUser.uid + '/profile').once('value');
    userProfile = snapshot.val();
    if (!userProfile) {
      // Create default profile if missing
      const isCreator = currentUser.email && currentUser.email.toLowerCase() === CREATOR_EMAIL.toLowerCase();
      userProfile = {
        name: currentUser.displayName || 'User',
        email: currentUser.email,
        role: isCreator ? 'creator' : 'user',
        created_at: new Date().toISOString(),
        pin_hash: null,
        devices: {}
      };
      await db.ref('users/' + currentUser.uid + '/profile').set(userProfile);
    }
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

// PIN entry functions
function enterPinDigit(mode, digit) {
  currentPinMode = mode;
  if (currentPin.length >= 4) return;

  currentPin += digit;
  updatePinDots(mode);

  if (currentPin.length === 4) {
    setTimeout(() => {
      if (mode === 'setup') {
        handlePinSetup();
      } else {
        handlePinEntry();
      }
    }, 200);
  }
}

function deletePinDigit(mode) {
  if (currentPin.length > 0) {
    currentPin = currentPin.slice(0, -1);
    updatePinDots(mode);
  }
}

function updatePinDots(mode) {
  const dotsContainer = document.getElementById('pin-' + mode + '-dots');
  const dots = dotsContainer.querySelectorAll('.pin-dot');
  dots.forEach((dot, i) => {
    dot.classList.toggle('filled', i < currentPin.length);
    dot.classList.remove('error');
  });
}

function showPinError(mode) {
  const dotsContainer = document.getElementById('pin-' + mode + '-dots');
  const dots = dotsContainer.querySelectorAll('.pin-dot');
  dots.forEach(dot => dot.classList.add('error'));

  if (mode === 'entry') {
    document.getElementById('pin-error').style.display = 'block';
  }

  setTimeout(() => {
    currentPin = '';
    updatePinDots(mode);
    if (mode === 'entry') {
      document.getElementById('pin-error').style.display = 'none';
    }
  }, 600);
}

async function handlePinSetup() {
  if (setupPinStep === 1) {
    // First entry - store and ask for confirmation
    setupPinFirst = currentPin;
    currentPin = '';
    setupPinStep = 2;
    updatePinDots('setup');

    // Update subtitle to show confirmation step
    const subtitle = document.querySelector('#auth-pin-setup .auth-subtitle');
    subtitle.textContent = 'CONFIRM YOUR PIN';
  } else {
    // Confirmation step
    if (currentPin === setupPinFirst) {
      // PINs match - save
      try {
        const pinHash = await hashPin(currentPin);
        const deviceId = getDeviceId();

        // Update profile with PIN
        userProfile.pin_hash = pinHash;
        if (!userProfile.devices) userProfile.devices = {};
        userProfile.devices[deviceId] = true;

        await db.ref('users/' + currentUser.uid + '/profile').update({
          pin_hash: pinHash,
          ['devices/' + deviceId]: true
        });

        // Save user ID locally for quick PIN login
        localStorage.setItem('kate_last_uid', currentUser.uid);

        console.log('✅ PIN установлен');
        await completeLogin();

      } catch (error) {
        console.error('PIN save error:', error);
        showAuthError('Failed to save PIN');
        resetPinSetup();
      }
    } else {
      // PINs don't match
      showPinError('setup');
      setupPinStep = 1;
      setupPinFirst = '';
      const subtitle = document.querySelector('#auth-pin-setup .auth-subtitle');
      subtitle.textContent = 'CREATE QUICK PIN';
    }
  }
}

function resetPinSetup() {
  currentPin = '';
  setupPinStep = 1;
  setupPinFirst = '';
  updatePinDots('setup');
  const subtitle = document.querySelector('#auth-pin-setup .auth-subtitle');
  subtitle.textContent = 'CREATE QUICK PIN';
}

function skipPinSetup() {
  completeLogin();
}

async function handlePinEntry() {
  try {
    const pinHash = await hashPin(currentPin);

    if (pinHash === userProfile.pin_hash) {
      // PIN correct
      console.log('✅ PIN верный');
      await completeLogin();
    } else {
      // Wrong PIN
      pinAttempts--;
      document.getElementById('pin-attempts').textContent = pinAttempts + ' attempts remaining';

      if (pinAttempts <= 0) {
        // Too many attempts - require full login
        showAuthScreen('login');
        pinAttempts = 3;
        localStorage.removeItem('kate_last_uid');
      } else {
        showPinError('entry');
      }
    }
  } catch (error) {
    console.error('PIN check error:', error);
    showPinError('entry');
  }

  currentPin = '';
}

// Complete login and show app
async function completeLogin() {
  if (!currentUser) return;

  // Set dbRef to user's data path
  dbRef = db.ref('users/' + currentUser.uid + '/trading_data');

  // Hide auth, show app
  document.getElementById('auth-container').style.display = 'none';
  document.getElementById('main-container').style.display = 'block';

  // Initialize Firebase data loading
  await initFirebaseUserData();

  // Update UI with user info
  updateUserMenu();

  // Load and render all data
  reloadAllData(true);
  renderAll();

  console.log('✅ Вход завершён для:', currentUser.email);
}

// Load user data from Firebase
async function initFirebaseUserData() {
  if (!dbRef) return;

  return new Promise((resolve) => {
    let resolved = false;

    const timeout = setTimeout(() => {
      if (!resolved) {
        resolved = true;
        console.log('⚠️ Firebase данные таймаут');
        isFirebaseReady = true; // Allow writes anyway
        resolve();
      }
    }, 5000);

    dbRef.once('value', (snapshot) => {
      if (resolved) return;
      resolved = true;
      clearTimeout(timeout);

      const data = snapshot.val();
      if (data) {
        firebaseData = data;
        Object.keys(data).forEach(key => {
          localStorage.setItem('ts_' + key, JSON.stringify(data[key]));
        });
        console.log('✅ Данные пользователя загружены');
      } else {
        console.log('📝 Новый пользователь - данные пусты');
      }
      isFirebaseReady = true;
      resolve();
    }, (error) => {
      if (resolved) return;
      resolved = true;
      clearTimeout(timeout);
      console.log('⚠️ Ошибка загрузки данных:', error.message);
      isFirebaseReady = true;
      resolve();
    });

    // Real-time sync
    dbRef.on('value', (snapshot) => {
      if (!isFirebaseReady) return;
      const data = snapshot.val() || {};
      const oldData = JSON.stringify(firebaseData);
      const newData = JSON.stringify(data);

      if (oldData !== newData) {
        firebaseData = data;
        Object.keys(data).forEach(key => {
          localStorage.setItem('ts_' + key, JSON.stringify(data[key]));
        });
        console.log('📡 Данные синхронизированы');
        reloadAllData();
      }
    });
  });
}

// Update user menu in header
function updateUserMenu() {
  // Add user button to header if not exists
  let userBtn = document.getElementById('user-menu-btn');
  if (!userBtn) {
    const headerRight = document.querySelector('.header-right');
    if (headerRight) {
      // Create user menu
      const userWrap = document.createElement('div');
      userWrap.className = 'user-menu-wrap';
      userWrap.style.position = 'relative';
      userWrap.innerHTML = `
        <button id="user-menu-btn" class="user-menu-btn" onclick="toggleUserMenu()">
          ${getInitials(userProfile?.name || currentUser?.displayName || 'U')}
        </button>
        <div id="user-dropdown" class="user-dropdown">
          <div class="user-dropdown-header">
            <div class="user-dropdown-name">${userProfile?.name || currentUser?.displayName || 'User'}</div>
            <div class="user-dropdown-email">${currentUser?.email || ''}</div>
            ${userProfile?.role === 'creator' ? '<span class="user-dropdown-badge">★ CREATOR</span>' : ''}
          </div>
          <div class="user-dropdown-item" onclick="openProfileSettings()">
            <span>⚙️</span> Settings
          </div>
          <div class="user-dropdown-item" onclick="changePinCode()">
            <span>🔐</span> Change PIN
          </div>
          <div class="user-dropdown-item danger" onclick="logoutUser()">
            <span>🚪</span> Logout
          </div>
        </div>
      `;
      headerRight.insertBefore(userWrap, headerRight.firstChild);
    }
  } else {
    // Update existing button
    userBtn.textContent = getInitials(userProfile?.name || currentUser?.displayName || 'U');
  }
}

function getInitials(name) {
  if (!name) return 'U';
  const parts = name.trim().split(' ');
  if (parts.length >= 2) {
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  }
  return name.substring(0, 2).toUpperCase();
}

function toggleUserMenu() {
  const dropdown = document.getElementById('user-dropdown');
  dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  const dropdown = document.getElementById('user-dropdown');
  const btn = document.getElementById('user-menu-btn');
  if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
    dropdown.classList.remove('show');
  }
});

function openProfileSettings() {
  // TODO: Implement profile settings panel
  alert('Profile settings coming soon!');
  toggleUserMenu();
}

function changePinCode() {
  toggleUserMenu();
  resetPinSetup();
  document.getElementById('main-container').style.display = 'none';
  document.getElementById('auth-container').style.display = 'flex';
  showAuthScreen('pin-setup');
}

async function logoutUser() {
  try {
    await auth.signOut();
    currentUser = null;
    userProfile = null;
    dbRef = null;
    isFirebaseReady = false;
    firebaseData = {};

    // Clear local storage except device ID
    const deviceId = localStorage.getItem('kate_device_id');
    localStorage.clear();
    if (deviceId) localStorage.setItem('kate_device_id', deviceId);

    // Show login screen
    document.getElementById('main-container').style.display = 'none';
    document.getElementById('auth-container').style.display = 'flex';
    showAuthScreen('login');

    console.log('✅ Выход выполнен');
  } catch (error) {
    console.error('Logout error:', error);
  }
}

// Check auth state on app start
async function checkAuthState() {
  // First load Firebase SDK
  const sdkLoaded = await loadFirebaseSDK();
  if (!sdkLoaded) {
    console.log('⚠️ Firebase недоступен');
    // Show login anyway - will work offline
    document.getElementById('auth-container').style.display = 'flex';
    showAuthScreen('login');
    return;
  }

  // Check if user already logged in
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      await loadUserProfile();

      // Check for quick PIN login
      const lastUid = localStorage.getItem('kate_last_uid');
      const deviceId = getDeviceId();

      if (lastUid === user.uid && userProfile?.pin_hash && userProfile?.devices?.[deviceId]) {
        // Show PIN entry for quick login
        document.getElementById('pin-avatar').textContent = getInitials(userProfile?.name || 'U');
        document.getElementById('pin-welcome').textContent = 'Welcome back, ' + (userProfile?.name?.split(' ')[0] || 'User');
        document.getElementById('auth-container').style.display = 'flex';
        showAuthScreen('pin-entry');
        pinAttempts = 3;
        currentPin = '';
      } else {
        // Full login already done - proceed to app
        await completeLogin();
      }
    } else {
      // No user - show login
      document.getElementById('auth-container').style.display = 'flex';
      showAuthScreen('login');
    }

    // Hide splash screen
    const splash = document.getElementById('loading-overlay');
    if (splash) {
      splash.style.animation = 'splashFadeOut 0.3s ease-out forwards';
      setTimeout(() => splash.style.display = 'none', 300);
    }
  });
}

// Load data from Firebase and setup real-time sync
// DEPRECATED: Now handled by checkAuthState() -> initFirebaseUserData()
async function initFirebase() {
  console.log('⚠️ initFirebase() is deprecated - use checkAuthState() instead');
  // This function is kept for backwards compatibility but does nothing
  // All Firebase initialization now happens through the auth system
  return Promise.resolve();
}

function reloadAllData(forceRender = false) {
  // Store old data hashes for comparison
  const oldHash = JSON.stringify([setups, trades, learningTopics]);

  // Reload all state from storage
  setups = storage.get('setups', defaultSetups);
  trades = storage.get('trades', []);
  strategies = storage.get('strategies', {});
  rulesDo = storage.get('rules_do', defaultRulesDo);
  rulesDont = storage.get('rules_dont', defaultRulesDont);
  profitLevels = storage.get('profit_levels', defaultProfitLevels);
  tips = storage.get('tips', defaultTips);
  learningTopics = storage.get('learning_topics', []);

  // Only re-render if data changed or forced
  const newHash = JSON.stringify([setups, trades, learningTopics]);
  if (forceRender || oldHash !== newHash) {
    renderAll();
  }
}

// ============ Default Data ============
const defaultSetups = [
  { id: 1, name: 'Слом структуры', description: 'BOS/CHoCH на ключевых уровнях.\nПодтверждение сменой характера движения.', color: '#EF4444', icon: '⚡' },
  { id: 2, name: 'Пробои', description: 'Пробой консоли/уровня с объёмом.\nЖдать перезаход, не с первого раза.', color: '#22C55E', icon: '↗' },
  { id: 3, name: 'Заточки', description: 'Сужение диапазона к уровню.\nНакопление перед импульсом.', color: '#F59E0B', icon: '◣' },
  { id: 4, name: 'Тренды', description: 'Вход по тренду на откатах.\nРазгоняются медленно, но идут хорошо.', color: '#8B5CF6', icon: '〰' }
];

const emptyStrategy = {
  coin_selection: '',
  chart_pattern: '',
  chart_pattern_images: [], // массив картинок для слайдера
  entry_point: '',
  entry_approach: '',
  stop_loss: '',
  take_profit: '',
  trade_behavior: ''
};

// Текущий индекс слайдера для каждого сетапа
let strategySlideIndex = {};

// SVG иконки для сетапов в фирменном стиле
const setupIcons = {
  coin_selection: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="10" cy="10" r="7" stroke="#F59E0B" stroke-width="2"/>
    <path d="M10 6v8M8 8.5h4M8 11.5h4" stroke="#F59E0B" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M15.5 15.5L21 21" stroke="#F59E0B" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  chart_pattern: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="3" y="10" width="4" height="8" rx="1" fill="#22C55E"/>
    <rect x="10" y="6" width="4" height="12" rx="1" fill="#EF4444"/>
    <rect x="17" y="4" width="4" height="14" rx="1" fill="#22C55E"/>
    <path d="M5 8V6M12 4V3M19 2V1" stroke="#71717A" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M5 20v2M12 20v1M19 20v2" stroke="#71717A" stroke-width="1.5" stroke-linecap="round"/>
  </svg>`,
  entry_point: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="9" stroke="#F97316" stroke-width="2"/>
    <circle cx="12" cy="12" r="5" stroke="#F97316" stroke-width="2"/>
    <circle cx="12" cy="12" r="1.5" fill="#F97316"/>
    <path d="M12 2v3M12 19v3M2 12h3M19 12h3" stroke="#F97316" stroke-width="1.5" stroke-linecap="round"/>
  </svg>`,
  entry_approach: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4 12h12" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/>
    <path d="M12 8l4 4-4 4" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <rect x="18" y="6" width="2" height="12" rx="1" fill="#3B82F6"/>
  </svg>`,
  stop_loss: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 3L4 7v6c0 5 3.5 8.5 8 10 4.5-1.5 8-5 8-10V7l-8-4z" stroke="#EF4444" stroke-width="2" fill="none"/>
    <path d="M9 9l6 6M15 9l-6 6" stroke="#EF4444" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  take_profit: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 20V8" stroke="#22C55E" stroke-width="2" stroke-linecap="round"/>
    <path d="M8 12l4-4 4 4" stroke="#22C55E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="12" cy="5" r="2" fill="#22C55E"/>
    <path d="M6 20h12" stroke="#22C55E" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  trade_behavior: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="9" stroke="#8B5CF6" stroke-width="2"/>
    <path d="M12 8v4l3 3" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="12" cy="12" r="2" fill="#8B5CF6"/>
  </svg>`
};

const strategyFields = [
  { key: 'coin_selection', label: 'Отбор монет', icon: 'coin_selection', placeholder: 'Как выбираю монеты? Объём, волатильность, тренд...' },
  { key: 'chart_pattern', label: 'Графическая формация', icon: 'chart_pattern', placeholder: 'Какой паттерн ищу? BOS, пробой, заточка...' },
  { key: 'entry_point', label: 'Точка входа', icon: 'entry_point', placeholder: 'Когда именно вхожу? Ретест, подтверждение...' },
  { key: 'entry_approach', label: 'Подход к точке входа', icon: 'entry_approach', placeholder: 'Как подхожу? Лимитка, маркет, частями...' },
  { key: 'stop_loss', label: 'Стоп-лосс', icon: 'stop_loss', placeholder: 'Где стоп? За структуру, фикс %, ATR...' },
  { key: 'take_profit', label: 'Тейк-профит', icon: 'take_profit', placeholder: 'Где тейк? R:R, уровни, трейлинг...' },
  { key: 'trade_behavior', label: 'Поведение в сделке', icon: 'trade_behavior', placeholder: 'Что делаю после входа? Передвигаю стоп, частичная фиксация, не трогаю...' }
];

const defaultRulesDo = [
  'Вход на 0.5 РО минимум',
  'Жди свои сетапы — это жизнеобразующие ситуации',
  'Ставь алерты, следи за формациями',
  'Думай перед входом, анализируй',
  'В пробое — ФИКС СТОП',
  'Фокус на прибыли, хочу зарабатывать'
];

const defaultRulesDont = [
  'Не переводи внимание после входа',
  'Не подгоняй ножи, не собирай импульсы',
  'Не входи без плана на сделку',
  'Не торгуй тяжёлые: ETH BTC XRP SOL',
  'Если нет сетапов — закрой терминал',
  'Не торгуй если не понимаешь монету'
];

const defaultProfitLevels = [
  { profit: 20, lock: 16 }, { profit: 40, lock: 36 },
  { profit: 60, lock: 50 }, { profit: 80, lock: 70 },
  { profit: 100, lock: 80 }, { profit: 130, lock: 100 },
  { profit: 150, lock: 130 }, { profit: 200, lock: 180 }
];

const defaultTips = [
  'Пробои стали реже, только на хороших трендах',
  'В пробоях тейки меняются — супердвижения требуют хорошего рынка',
  'Пробои часто идут не с первого раза → ждать перезаход',
  'Поднаклонки работают',
  'Листинги лучше не трогать — мало ликвидности',
  'ЖБ точки надо ждать терпеливо, но в них заливаться'
];

const defaultMentalWrong = `«Профит всё равно роли не играет»
→ Расслабленность, похуизм
→ Раздаю профит как фантики
→ Минус с профита`;

const defaultMentalRight = `«Это ТОЖЕ ДЕНЬГИ. Моя задача — сохранить»
→ Собранность, осторожность
→ Пересмотреть сетапы, повторить правила
→ Сохранённый или возросший профит`;

const defaultCorrection = `1. Ментальный фокус на 1 параметре
2. Гигиена пространства и информации
3. Тестирование (сетапы, отработка, подход)
4. Дисциплина

Трейдинг = рефлексия + адаптация + управление рисками`;

const colors = ['#EF4444', '#22C55E', '#F59E0B', '#8B5CF6', '#3B82F6', '#EC4899', '#14B8A6', '#F97316'];
const icons = ['⚡', '↗', '◣', '〰', '◆', '★', '●', '▲', '■', '♦'];

// ============ State ============
let setups = storage.get('setups', defaultSetups);
let trades = storage.get('trades', []);
let strategies = storage.get('strategies', {}); // strategies[setup_id] = { coin_selection, ... }
let currentSetupIdx = 0;
let filterSetupId = null; // null = показать все, иначе ID сетапа
let showAllSetups = false; // показывать ли сетапы с <10 сделок
let rulesDo = storage.get('rules_do', defaultRulesDo);
let rulesDont = storage.get('rules_dont', defaultRulesDont);
let profitLevels = storage.get('profit_levels', defaultProfitLevels);
let tips = storage.get('tips', defaultTips);

// Стандартная строка из 4 блоков для обучения
const defaultFieldRow = [
  { title: 'Точка входа', icon: '🎯', content: '' },
  { title: 'Точка выхода', icon: '🚪', content: '' },
  { title: 'Подтверждение в стакане', icon: '📊', content: '' },
  { title: 'На графике', icon: '📈', content: '' },
  { title: 'Конспект', icon: '📝', content: '' },
  { title: 'Файлы/методички', icon: '📁', content: '' }
];

let learningTopics = storage.get('learning_topics', []);

// Миграция: добавляем недостающие карточки в каждую строку (до 6 полей)
learningTopics.forEach(topic => {
  if (topic.fields && topic.fields.length > 0) {
    const newFields = [];
    const fieldsPerRow = 6;

    // Группируем по строкам (определяем по базовым 4 полям)
    let currentRow = [];
    for (let i = 0; i < topic.fields.length; i++) {
      const field = topic.fields[i];
      const isExtraField = field.title === 'Конспект' || field.title === 'Файлы/методички';

      if (!isExtraField) {
        currentRow.push(field);
        // Каждые 4 базовых поля = 1 строка
        if (currentRow.length === 4) {
          // Добавляем базовые поля
          newFields.push(...currentRow);
          // Проверяем и добавляем Конспект
          const nextField = topic.fields[i + 1];
          if (nextField && nextField.title === 'Конспект') {
            newFields.push(nextField);
            i++; // Пропускаем
          } else {
            newFields.push({ title: 'Конспект', icon: '📝', content: '' });
          }
          // Проверяем и добавляем Файлы/методички
          const nextField2 = topic.fields[i + 1];
          if (nextField2 && nextField2.title === 'Файлы/методички') {
            newFields.push(nextField2);
            i++; // Пропускаем
          } else {
            newFields.push({ title: 'Файлы/методички', icon: '📁', content: '' });
          }
          currentRow = [];
        }
      }
    }
    // Обработка неполной последней строки
    if (currentRow.length > 0) {
      newFields.push(...currentRow);
    }

    topic.fields = newFields;
  }
});
// НЕ сохраняем сразу - данные из Firebase загрузятся позже и перезапишут
// storage.set('learning_topics', learningTopics); // Убрано для защиты данных

let expandedTopicId = null;
let learningSlideIndex = {}; // Для слайдера картинок в обучении

// Получить стратегию для сетапа (создаёт пустую если нет)
function getStrategy(setupId) {
  if (!strategies[setupId]) {
    // Deep copy чтобы массивы были независимыми для каждой стратегии
    strategies[setupId] = {
      ...emptyStrategy,
      chart_pattern_images: [],
      videos: [],
      checklists: {}
    };
  }
  return strategies[setupId];
}

// ============ Auth ============
const CORRECT_PIN = '0000';
let isGuest = false;
let isAuthenticated = false;

// Guard function - blocks editing for guests
function guardEdit() {
  if (isGuest) {
    showGuestWarning();
    return false;
  }
  return true;
}

function showGuestWarning() {
  // Show a brief warning
  const badge = document.getElementById('guest-badge');
  if (badge) {
    badge.style.animation = 'shake 0.4s ease';
    setTimeout(() => badge.style.animation = '', 400);
  }
}

function answerYes() {
  // DEPRECATED: Redirect to new Firebase Auth system
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('auth-container').style.display = 'flex';
  showAuthScreen('login');
}

function answerNo() {
  // DEPRECATED: Redirect to new Firebase Auth - guest mode removed
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('auth-container').style.display = 'flex';
  showAuthScreen('register');
}

function goBackToQuestion() {
  // Go back to question
  document.getElementById('auth-step-pin').style.display = 'none';
  document.getElementById('auth-step-question').style.display = 'block';
  // Clear PIN inputs
  document.querySelectorAll('.pin-input').forEach(i => i.value = '');
  clearPinError();
}

function setupPinInputs() {
  const inputs = document.querySelectorAll('.pin-input');

  inputs.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value.slice(0, 1);

      // Move to next input
      if (value && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }

      // Check if all filled
      checkPinComplete();
      clearPinError();
    });

    input.addEventListener('keydown', (e) => {
      // Backspace - move to previous
      if (e.key === 'Backspace' && !e.target.value && idx > 0) {
        inputs[idx - 1].focus();
      }
      // Enter - submit
      if (e.key === 'Enter') {
        submitPin();
      }
    });

    // Paste support
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      const digits = paste.replace(/\D/g, '').slice(0, 4);

      digits.split('').forEach((digit, i) => {
        if (inputs[i]) inputs[i].value = digit;
      });

      if (digits.length === 4) {
        inputs[3].focus();
        checkPinComplete();
      }
    });
  });
}

function checkPinComplete() {
  const inputs = document.querySelectorAll('.pin-input');
  const pin = Array.from(inputs).map(i => i.value).join('');
  const submitBtn = document.getElementById('auth-submit');
  submitBtn.disabled = pin.length !== 4;
}

function getEnteredPin() {
  const inputs = document.querySelectorAll('.pin-input');
  return Array.from(inputs).map(i => i.value).join('');
}

function clearPinError() {
  document.getElementById('auth-error').textContent = '';
  document.querySelectorAll('.pin-input').forEach(i => i.classList.remove('error'));
}

function showPinError(msg) {
  document.getElementById('auth-error').textContent = msg;
  document.querySelectorAll('.pin-input').forEach(i => {
    i.classList.add('error');
    i.value = '';
  });
  document.querySelector('.pin-input').focus();
  document.getElementById('auth-submit').disabled = true;
}

function submitPin() {
  // DEPRECATED: Redirect to new Firebase Auth system
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('auth-container').style.display = 'flex';
  showAuthScreen('login');
  return;

  // Old code below (kept for reference, never executes)
  const pin = getEnteredPin();
  if (pin.length !== 4) return;

  if (pin === CORRECT_PIN) {
    // Success! Save to localStorage for persistent login
    isAuthenticated = true;
    isGuest = false;
    localStorage.setItem('ts_auth', 'owner');
    hideAuthModal();
    showLogoutButton();
  } else {
    showPinError('Неверный PIN-код');
  }
}

function showLogoutButton() {
  const btn = document.getElementById('logout-btn');
  if (btn) btn.style.display = 'flex';
}

function hideLogoutButton() {
  const btn = document.getElementById('logout-btn');
  if (btn) btn.style.display = 'none';
}

function enterAsGuest() {
  isGuest = true;
  isAuthenticated = true;
  sessionStorage.setItem('ts_auth', 'guest');
  document.body.classList.add('guest-mode');
  document.getElementById('guest-badge').style.display = 'flex';
  hideAuthModal();

  // Disable copy
  document.addEventListener('copy', preventCopy);
  document.addEventListener('contextmenu', preventContextMenu);
}

function preventCopy(e) {
  if (isGuest) {
    e.preventDefault();
    return false;
  }
}

function preventContextMenu(e) {
  if (isGuest) {
    e.preventDefault();
    return false;
  }
}

function exitGuestMode() {
  // Clear guest session
  sessionStorage.removeItem('ts_auth');
  document.body.classList.remove('guest-mode');
  document.getElementById('guest-badge').style.display = 'none';
  isGuest = false;
  isAuthenticated = false;

  // Re-enable copy
  document.removeEventListener('copy', preventCopy);
  document.removeEventListener('contextmenu', preventContextMenu);

  // Show new auth container
  document.getElementById('auth-container').style.display = 'flex';
  showAuthScreen('login');
}

// Play KATE voice on logo click
function playKateVoice() {
  const audio = document.getElementById('kate-audio');
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(e => console.log('Audio play failed:', e));
  }
}

// Play MAKETA voice on logo click
function playMaketaVoice() {
  const audio = document.getElementById('maketa-audio');
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(e => console.log('Audio play failed:', e));
  }
}

// Function to logout owner
function logout() {
  localStorage.removeItem('ts_auth');
  sessionStorage.removeItem('ts_auth');
  hideLogoutButton();
  location.reload();
}

function hideAuthModal() {
  document.getElementById('auth-overlay').style.display = 'none';
}

function hideLandingPage() {
  document.getElementById('landing-page').classList.add('hidden');
}

function showLandingPage() {
  document.getElementById('landing-page').classList.remove('hidden');
}

// Start login flow: hide landing -> show splash -> show auth
function startLogin() {
  // Hide landing page
  hideLandingPage();

  // Show splash screen
  const splash = document.getElementById('loading-overlay');
  splash.style.display = 'flex';
  splash.style.animation = 'none';
  // Force reflow
  splash.offsetHeight;
  splash.style.animation = 'splashFadeOut 0.4s ease-out 2.8s forwards';

  // Reset splash animations
  const splashKate = splash.querySelector('.splash-kate');
  const splashMaketa = splash.querySelector('.splash-maketa');
  const splashTagline = splash.querySelector('.splash-tagline');
  const splashKateEx = splash.querySelector('.splash-kate .splash-exclaim');
  const splashMaketaEx = splash.querySelector('.splash-maketa .splash-exclaim');

  if (splashKate) {
    splashKate.style.animation = 'none';
    splashKate.offsetHeight;
    splashKate.style.animation = 'splashKate 3s ease-in-out forwards';
  }
  if (splashMaketa) {
    splashMaketa.style.animation = 'none';
    splashMaketa.offsetHeight;
    splashMaketa.style.animation = 'splashMaketa 3s ease-in-out forwards';
  }
  if (splashTagline) {
    splashTagline.style.animation = 'none';
    splashTagline.offsetHeight;
    splashTagline.style.animation = 'splashFadeIn 0.4s ease-out 2.2s forwards';
  }
  if (splashKateEx) {
    splashKateEx.style.animation = 'none';
    splashKateEx.offsetHeight;
    splashKateEx.style.animation = 'splashKateEx 3s ease-in-out forwards';
  }
  if (splashMaketaEx) {
    splashMaketaEx.style.animation = 'none';
    splashMaketaEx.offsetHeight;
    splashMaketaEx.style.animation = 'splashMaketaEx 3s ease-in-out forwards';
  }

  // After splash animation (3s), show NEW auth container (Firebase Auth)
  setTimeout(() => {
    splash.style.display = 'none';
    // Show new Firebase auth container instead of old auth-overlay
    document.getElementById('auth-container').style.display = 'flex';
    showAuthScreen('login');
  }, 3200);
}

function checkSavedAuth() {
  // DEPRECATED: Now using Firebase Authentication
  // This function is kept for backwards compatibility
  // Real auth check happens in checkAuthState()

  // Hide old auth systems
  const oldOverlay = document.getElementById('auth-overlay');
  if (oldOverlay) oldOverlay.style.display = 'none';

  // If Firebase user exists, they're authenticated
  if (currentUser) {
    hideLandingPage();
    return true;
  }

  // Check for legacy auth (will migrate to Firebase)
  const ownerAuth = localStorage.getItem('ts_auth');
  const guestAuth = sessionStorage.getItem('ts_auth');

  if (ownerAuth === 'owner' || guestAuth === 'guest') {
    // Clear legacy auth - require new Firebase login
    localStorage.removeItem('ts_auth');
    sessionStorage.removeItem('ts_auth');
  }

  return false;
}

// ============ Init ============
document.addEventListener('DOMContentLoaded', async () => {
  // Show splash screen
  document.getElementById('loading-overlay').style.display = 'flex';

  // Setup events (will be used after login)
  setupEvents();

  // Check authentication state - this handles everything
  await checkAuthState();

  // Update sync status after auth completes
  setTimeout(() => {
    if (isFirebaseReady && currentUser) {
      showSyncStatus('synced');
      console.log('✅ Trading System загружена с Firebase Auth');
    } else if (!currentUser) {
      console.log('⏳ Ожидание авторизации...');
    } else {
      showSyncStatus('offline');
      console.log('✅ Trading System загружена в офлайн режиме');
    }
  }, 1000);
});

function renderAll() {
  // Critical renders first (visible on screen)
  renderSetups();
  renderLearning();

  // Defer less critical renders
  requestAnimationFrame(() => {
    renderStrategy();
    renderTrades();
    requestAnimationFrame(() => {
      renderStats();
      renderRules();
      renderProfitLevels();
      renderTips();
      renderMental();
    });
  });
}

function save() {
  // Show syncing status only if Firebase is connected
  if (isFirebaseReady) {
    showSyncStatus('syncing');
  }

  storage.set('setups', setups);
  storage.set('trades', trades);
  storage.set('strategies', strategies);
  storage.set('rules_do', rulesDo);
  storage.set('rules_dont', rulesDont);
  storage.set('profit_levels', profitLevels);
  storage.set('tips', tips);
  storage.set('learning_topics', learningTopics);

  // Show synced status after a short delay (or keep offline status)
  setTimeout(() => showSyncStatus(isFirebaseReady ? 'synced' : 'offline'), 500);
}

// ============ ПОЛНОЕ СОХРАНЕНИЕ С БЭКАПОМ ============
function saveEverything() {
  // Разрешаем запись (пользователь явно нажал кнопку)
  userHasInteracted = true;

  // 1. Собираем все данные
  const allData = {
    setups: setups,
    trades: trades,
    strategies: strategies,
    rules_do: rulesDo,
    rules_dont: rulesDont,
    profit_levels: profitLevels,
    tips: tips,
    learning_topics: learningTopics,
    current_deposit: storage.get('current_deposit', 0),
    mental_wrong: storage.get('mental_wrong', ''),
    mental_right: storage.get('mental_right', ''),
    correction: storage.get('correction', ''),
    logo_text: storage.get('logo_text', 'ТС'),
    system_title: storage.get('system_title', 'Торговая Система'),
    backup_date: new Date().toISOString()
  };

  // 2. Сохраняем в localStorage
  Object.keys(allData).forEach(key => {
    if (key !== 'backup_date') {
      localStorage.setItem('ts_' + key, JSON.stringify(allData[key]));
    }
  });

  // 3. Сохраняем в Firebase (принудительно)
  let firebaseSaved = false;
  if (firebaseAvailable && dbRef) {
    try {
      Object.keys(allData).forEach(key => {
        if (key !== 'backup_date') {
          dbRef.child(key).set(allData[key]);
          firebaseData[key] = allData[key];
        }
      });
      // Сохраняем версию в историю
      const versionId = Date.now().toString();
      const versionData = {
        ...allData,
        id: versionId,
        date: new Date().toISOString(),
        learning_count: (learningTopics || []).length,
        trades_count: (trades || []).length
      };
      dbRef.child('versions').child(versionId).set(versionData);

      firebaseSaved = true;
      console.log('✅ Все данные сохранены в Firebase + версия создана');
    } catch (e) {
      console.log('Firebase save error:', e);
    }
  }

  // 4. Показываем уведомление
  showSaveToast(firebaseSaved);
}

// Скачивание бэкапа вручную
function downloadBackup() {
  const allData = {
    setups: setups,
    trades: trades,
    strategies: strategies,
    rules_do: rulesDo,
    rules_dont: rulesDont,
    profit_levels: profitLevels,
    tips: tips,
    learning_topics: learningTopics,
    current_deposit: storage.get('current_deposit', 0),
    mental_wrong: storage.get('mental_wrong', ''),
    mental_right: storage.get('mental_right', ''),
    correction: storage.get('correction', ''),
    backup_date: new Date().toISOString()
  };

  const fileName = `kate-backup-${new Date().toISOString().slice(0,10)}.json`;
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function showSaveToast(firebaseSaved) {
  const toast = document.getElementById('save-toast');
  const firebaseStatus = document.getElementById('toast-firebase-status');

  firebaseStatus.textContent = firebaseSaved ? '✓' : '⚠️ офлайн';
  firebaseStatus.style.color = firebaseSaved ? '#22C55E' : '#F59E0B';

  toast.classList.add('show');

  // Автоматически скрыть через 5 секунд
  setTimeout(() => {
    hideSaveToast();
  }, 5000);
}

function hideSaveToast() {
  document.getElementById('save-toast').classList.remove('show');
}

// Загрузка бэкапа из файла
function loadBackup(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);

      // Восстанавливаем данные
      if (data.setups) { setups = data.setups; storage.set('setups', setups); }
      if (data.trades) { trades = data.trades; storage.set('trades', trades); }
      if (data.strategies) { strategies = data.strategies; storage.set('strategies', strategies); }
      if (data.rules_do) { rulesDo = data.rules_do; storage.set('rules_do', rulesDo); }
      if (data.rules_dont) { rulesDont = data.rules_dont; storage.set('rules_dont', rulesDont); }
      if (data.profit_levels) { profitLevels = data.profit_levels; storage.set('profit_levels', profitLevels); }
      if (data.tips) { tips = data.tips; storage.set('tips', tips); }
      if (data.learning_topics) { learningTopics = data.learning_topics; storage.set('learning_topics', learningTopics); }

      // Перерисовываем интерфейс
      renderAll();
      alert('✅ Бэкап успешно восстановлен!');
    } catch (err) {
      alert('❌ Ошибка чтения файла: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// Обработчик выбора файла бэкапа
function handleBackupFileSelect(event) {
  const file = event.target.files[0];
  if (file) {
    loadBackup(file);
    closeVersionPanel();
  }
  // Сбрасываем input чтобы можно было выбрать тот же файл снова
  event.target.value = '';
}

// ============ ИСТОРИЯ ВЕРСИЙ ============
function openVersionPanel() {
  document.getElementById('version-overlay').classList.add('show');
  document.getElementById('version-panel').classList.add('open');
  loadVersions();
}

function closeVersionPanel() {
  document.getElementById('version-overlay').classList.remove('show');
  document.getElementById('version-panel').classList.remove('open');
}

function loadVersions() {
  const listEl = document.getElementById('version-list');

  if (!firebaseAvailable || !dbRef) {
    listEl.innerHTML = `
      <div class="version-empty">
        <div class="version-empty-icon">⚠️</div>
        <div>Firebase недоступен</div>
      </div>
    `;
    return;
  }

  listEl.innerHTML = '<div style="text-align:center;padding:40px;color:#71717A;">Загрузка...</div>';

  dbRef.child('versions').orderByChild('date').limitToLast(20).once('value', (snapshot) => {
    const versions = [];
    snapshot.forEach(child => {
      versions.push({ id: child.key, ...child.val() });
    });

    // Сортируем по дате (новые первые)
    versions.sort((a, b) => new Date(b.date) - new Date(a.date));

    if (versions.length === 0) {
      listEl.innerHTML = `
        <div class="version-empty">
          <div class="version-empty-icon">📭</div>
          <div>Нет сохранённых версий</div>
          <div style="margin-top:8px;font-size:12px;">Нажмите "Сохранить" чтобы создать первую версию</div>
        </div>
      `;
      return;
    }

    listEl.innerHTML = versions.map(v => {
      const date = new Date(v.date);
      const dateStr = date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="version-item" onclick="restoreVersion('${v.id}')">
          <div class="version-item-date">${dateStr}</div>
          <div class="version-item-info">
            <span class="version-item-stat">📚 ${v.learning_count || 0} тем</span>
            <span class="version-item-stat">📊 ${v.trades_count || 0} сделок</span>
          </div>
        </div>
      `;
    }).join('');
  }, (error) => {
    listEl.innerHTML = `
      <div class="version-empty">
        <div class="version-empty-icon">❌</div>
        <div>Ошибка загрузки: ${error.message}</div>
      </div>
    `;
  });
}

function restoreVersion(versionId) {
  if (!confirm('Восстановить эту версию? Текущие данные будут заменены.')) {
    return;
  }

  dbRef.child('versions').child(versionId).once('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      alert('❌ Версия не найдена');
      return;
    }

    // Разрешаем запись
    userHasInteracted = true;

    // Восстанавливаем данные
    if (data.setups) { setups = data.setups; storage.set('setups', setups); }
    if (data.trades) { trades = data.trades; storage.set('trades', trades); }
    if (data.strategies) { strategies = data.strategies; storage.set('strategies', strategies); }
    if (data.rules_do) { rulesDo = data.rules_do; storage.set('rules_do', rulesDo); }
    if (data.rules_dont) { rulesDont = data.rules_dont; storage.set('rules_dont', rulesDont); }
    if (data.profit_levels) { profitLevels = data.profit_levels; storage.set('profit_levels', profitLevels); }
    if (data.tips) { tips = data.tips; storage.set('tips', tips); }
    if (data.learning_topics) { learningTopics = data.learning_topics; storage.set('learning_topics', learningTopics); }

    // Сохраняем в основную базу
    Object.keys(data).forEach(key => {
      if (!['id', 'date', 'learning_count', 'trades_count', 'backup_date'].includes(key)) {
        if (firebaseAvailable && dbRef) {
          dbRef.child(key).set(data[key]);
          firebaseData[key] = data[key];
        }
        localStorage.setItem('ts_' + key, JSON.stringify(data[key]));
      }
    });

    // Перерисовываем
    renderAll();
    closeVersionPanel();
    alert('✅ Версия восстановлена!');
  });
}

function showSyncStatus(status) {
  const el = document.getElementById('sync-status');
  if (!el) return;

  if (status === 'syncing') {
    el.innerHTML = `
      <span style="width:8px;height:8px;background:var(--accent-warning);border-radius:50%;animation:pulse 0.5s infinite;"></span>
      <span style="color:var(--accent-warning);">Сохранение...</span>
    `;
  } else if (status === 'offline') {
    el.innerHTML = `
      <span style="width:8px;height:8px;background:#71717A;border-radius:50%;"></span>
      <span style="color:#71717A;">Офлайн режим</span>
    `;
  } else {
    el.innerHTML = `
      <span style="width:8px;height:8px;background:var(--accent-success);border-radius:50%;animation:pulse 2s infinite;"></span>
      <span style="color:var(--accent-success);">Синхронизировано</span>
    `;
  }
}

// ============ Setups ============
function renderSetups() {
  // Считаем статистику для каждого сетапа
  const setupsWithStats = setups.map((s, i) => {
    const setupTrades = trades.filter(t => t.setup_id == s.id);
    const totalTrades = setupTrades.length;
    const wins = setupTrades.filter(t => t.pnl > 0).length;
    const pnl = setupTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    const winRate = totalTrades > 0 ? Math.round((wins / totalTrades) * 100) : 0;
    return { ...s, index: i, totalTrades, wins, pnl, winRate };
  });

  // Находим максимальный P&L для нормализации
  const maxProfit = Math.max(...setupsWithStats.map(s => s.pnl > 0 ? s.pnl : 0), 1);
  const maxLoss = Math.max(...setupsWithStats.map(s => s.pnl < 0 ? Math.abs(s.pnl) : 0), 1);

  // Разделяем на основные (>=10) и скрытые (<10)
  const mainSetups = setupsWithStats.filter(s => s.totalTrades >= 10);
  const hiddenSetups = setupsWithStats.filter(s => s.totalTrades < 10);

  const renderSetupCard = (s) => {
    const pnlClass = s.pnl > 0 ? 'positive' : s.pnl < 0 ? 'negative' : 'neutral';
    const pnlStr = s.pnl >= 0 ? `+${s.pnl.toFixed(0)}$` : `${s.pnl.toFixed(0)}$`;
    const indicatorClass = s.pnl > 0 ? 'profit' : s.pnl < 0 ? 'loss' : 'neutral';

    // Вычисляем уровень (0-1) для высоты баров
    let level = 0;
    if (s.pnl > 0) {
      level = s.pnl / maxProfit;
    } else if (s.pnl < 0) {
      level = Math.abs(s.pnl) / maxLoss;
    }

    // Минимальная и максимальная высота баров
    const minH = 6, maxH = 24;

    // Для profit: бары растут слева направо (bar1 < bar2 < bar3)
    // Для loss: бары падают слева направо (bar1 > bar2 > bar3)
    // Для neutral: все одинаковые маленькие
    let bar1, bar2, bar3;
    if (s.pnl > 0) {
      // Profit: растущий график, чем больше profit - тем выше все бары
      const baseH = minH + (maxH - minH) * level * 0.4;
      bar1 = Math.round(baseH);
      bar2 = Math.round(baseH + (maxH - minH) * level * 0.3);
      bar3 = Math.round(baseH + (maxH - minH) * level * 0.6);
    } else if (s.pnl < 0) {
      // Loss: падающий график, чем больше loss - тем выше первый бар и ниже последний
      const baseH = minH + (maxH - minH) * level * 0.6;
      bar1 = Math.round(baseH);
      bar2 = Math.round(baseH - (maxH - minH) * level * 0.2);
      bar3 = Math.round(minH + (maxH - minH) * level * 0.15);
    } else {
      // Neutral: маленькие равные бары
      bar1 = bar2 = bar3 = 10;
    }

    // KATE/MAKETA badge for setups
    const setupBadge = s.totalTrades > 0
      ? (s.pnl >= 0
        ? `<span class="trade-badge kate-badge" style="font-size:10px;padding:2px 6px;">勝て KATE!</span>`
        : `<span class="trade-badge maketa-badge" style="font-size:10px;padding:2px 6px;">負け MAKETA!</span>`)
      : '';

    return `
    <div class="setup-card" data-index="${s.index}">
      <span class="setup-delete" onclick="deleteSetup(${s.index})">✕</span>
      <div class="setup-header">
        <div class="setup-icon ${indicatorClass}">
          <div class="setup-icon-bar" style="height: ${bar1}px"></div>
          <div class="setup-icon-bar" style="height: ${bar2}px"></div>
          <div class="setup-icon-bar" style="height: ${bar3}px"></div>
        </div>
        <input type="text" class="setup-name" value="${s.name}" onchange="updateSetup(${s.index}, 'name', this.value)" onclick="this.select()">
        ${setupBadge}
      </div>
      <textarea class="setup-desc" onchange="updateSetup(${s.index}, 'description', this.value)" onclick="this.select()">${s.description}</textarea>
      <div class="setup-stats">
        <div class="setup-stat">
          <span class="setup-stat-value ${pnlClass}">${s.totalTrades > 0 ? pnlStr : '—'}</span>
          <span class="setup-stat-label">P&L</span>
        </div>
        <div class="setup-stat">
          <span class="setup-stat-value ${s.winRate >= 50 ? 'positive' : s.winRate > 0 ? 'negative' : 'neutral'}">${s.totalTrades > 0 ? s.winRate + '%' : '—'}</span>
          <span class="setup-stat-label">Win Rate</span>
        </div>
        <div class="setup-stat">
          <div class="setup-wins-losses">
            <span class="wins-count">${s.wins}</span>
            <span class="wins-losses-sep">/</span>
            <span class="losses-count">${s.totalTrades - s.wins}</span>
          </div>
          <span class="setup-stat-label">W / L</span>
        </div>
      </div>
      <div class="color-picker" id="color-picker-${s.index}">
        ${colors.map(c => `<div class="color-option" style="background: ${c}" onclick="setSetupColor(${s.index}, '${c}')"></div>`).join('')}
        <div style="width: 100%; border-top: 1px solid var(--border); padding-top: 8px; margin-top: 4px; display: flex; gap: 6px; flex-wrap: wrap;">
          ${icons.map(ic => `<div class="color-option" style="background: var(--bg-input); font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="setSetupIcon(${s.index}, '${ic}')">${ic}</div>`).join('')}
        </div>
      </div>
    </div>
  `};

  let html = mainSetups.map(renderSetupCard).join('');

  // Кнопка показать скрытые
  if (hiddenSetups.length > 0) {
    if (showAllSetups) {
      html += hiddenSetups.map(renderSetupCard).join('');
      html += `<div class="setup-toggle-card" onclick="toggleShowAllSetups()">▲ Скрыть (${hiddenSetups.length})</div>`;
    } else {
      html += `<div class="setup-toggle-card" onclick="toggleShowAllSetups()">▼ Ещё ${hiddenSetups.length} сетапов</div>`;
    }
  }

  html += `<div class="add-setup-card" onclick="addSetup()">+ Добавить сетап</div>`;

  document.getElementById('setups-grid').innerHTML = html;
}

function updateSetup(idx, field, value) {
  if (!guardEdit()) return;
  setups[idx][field] = value;
  save();
}

async function deleteSetup(idx) {
  if (!guardEdit()) return;
  const confirmed = await showConfirm({
    icon: '🗑️',
    title: 'Удалить сетап?',
    message: 'Сделки с этим сетапом останутся, но сетап будет сброшен.',
    confirmText: 'Удалить'
  });
  if (confirmed) {
    const deletedSetupId = setups[idx].id;

    // Сбрасываем setup_id у всех сделок с этим сетапом
    trades.forEach(t => {
      if (t.setup_id == deletedSetupId) {
        t.setup_id = null;
      }
    });

    // Удаляем стратегию для этого сетапа
    delete strategies[deletedSetupId];

    // Сбрасываем фильтр если был по этому сетапу
    if (filterSetupId == deletedSetupId) {
      filterSetupId = null;
    }

    // Удаляем сетап
    setups.splice(idx, 1);

    // Корректируем индекс слайдера стратегий
    if (currentSetupIdx >= setups.length) {
      currentSetupIdx = Math.max(0, setups.length - 1);
    }

    save();
    renderSetups();
    renderStrategy();
    renderTrades();
    renderStats();
  }
}

function addSetup() {
  if (!guardEdit()) return;
  const newId = Math.max(...setups.map(s => s.id), 0) + 1;
  setups.push({
    id: newId,
    name: 'Новый сетап',
    description: 'Описание сетапа...',
    color: colors[setups.length % colors.length],
    icon: icons[setups.length % icons.length]
  });
  save();
  renderSetups();
}

function showColorPicker(idx, event) {
  event.stopPropagation();
  document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active'));
  document.getElementById(`color-picker-${idx}`).classList.toggle('active');
}

function setSetupColor(idx, color) {
  if (!guardEdit()) return;
  setups[idx].color = color;
  save();
  renderSetups();
}

function setSetupIcon(idx, icon) {
  if (!guardEdit()) return;
  setups[idx].icon = icon;
  save();
  renderSetups();
}

// Close color picker on outside click
document.addEventListener('click', () => {
  document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active'));
});

// ============ Learning ============
const defaultFieldIcons = ['🎯', '🚪', '📊', '📈', '💡', '⚡', '🔍', '📝', '✅', '⚠️'];

function renderLearning() {
  const grid = document.getElementById('learning-grid');

  let html = learningTopics.map((topic, idx) => {
    const isExpanded = expandedTopicId === topic.id;
    const fields = topic.fields || [];

    // Формируем описание из заполненных полей
    const filledFields = fields.filter(f => f.content).map(f => f.title);
    const descText = filledFields.length > 0 ? filledFields.slice(0, 3).join(' • ') : 'Нажмите чтобы открыть...';

    // Группируем поля в строки по 6
    const rowSize = 6;
    const rows = [];
    for (let i = 0; i < fields.length; i += rowSize) {
      rows.push(fields.slice(i, i + rowSize));
    }

    const fieldsHtml = rows.map((row, rowIdx) => {
      const rowFieldsHtml = row.map((field, localIdx) => {
        const fieldIdx = rowIdx * rowSize + localIdx;
        const isImageField = field.title === 'На графике';
        const isFilesField = field.title === 'Файлы/методички';
        const images = field.images || [];
        const files = field.files || [];
        const currentSlide = learningSlideIndex[`${topic.id}_${fieldIdx}`] || 0;

        // Файлы/методички field
        if (isFilesField) {
          const filesListHtml = files.length > 0 ? `
            <div class="learning-files-list">
              ${files.map((file, fileIdx) => `
                <div class="learning-file-item">
                  <span class="learning-file-icon">${getFileIcon(file.type)}</span>
                  <span class="learning-file-name" onclick="downloadLearningFile(${idx}, ${fieldIdx}, ${fileIdx}); event.stopPropagation();">${file.name}</span>
                  <span class="learning-file-size">${formatFileSize(file.size)}</span>
                  <button class="learning-file-delete" onclick="deleteLearningFile(${idx}, ${fieldIdx}, ${fileIdx}); event.stopPropagation();">✕</button>
                </div>
              `).join('')}
            </div>
          ` : '';

          return `
            <div class="learning-field learning-field-files">
              <div class="learning-field-header">
                <div class="learning-field-num">${fieldIdx + 1}</div>
                <span class="learning-field-icon">${field.icon}</span>
                <input type="text" class="learning-field-title-input"
                       value="${field.title}"
                       onchange="updateFieldTitle(${idx}, ${fieldIdx}, this.value)"
                       onclick="event.stopPropagation()">
                <span class="learning-field-delete" onclick="deleteField(${idx}, ${fieldIdx}); event.stopPropagation();">✕</span>
              </div>
              ${filesListHtml}
              <div class="learning-file-upload"
                   onclick="triggerLearningFileUpload(${idx}, ${fieldIdx}); event.stopPropagation();"
                   ondragover="handleFileDragOver(event)"
                   ondragleave="handleFileDragLeave(event)"
                   ondrop="handleFileDrop(event, ${idx}, ${fieldIdx})">
                <span class="learning-file-upload-icon">📁</span>
                <span class="learning-file-upload-text">${files.length > 0 ? 'Добавить ещё файл' : 'Загрузить файл или перетащите сюда'}</span>
                <span class="learning-file-upload-hint">PDF, Word, Excel, изображения</span>
              </div>
              <input type="file" id="learning-file-input-${idx}-${fieldIdx}" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif,.webp" style="display:none" onchange="handleLearningFileUpload(event, ${idx}, ${fieldIdx})">
            </div>
          `;
        }

        if (isImageField) {
          let imageContent = '';
          if (images.length > 0) {
            imageContent = `
              <div class="learning-image-slider">
                <div class="learning-image-preview">
                  <img src="${images[currentSlide]}" alt="Chart ${currentSlide + 1}" onclick="openImageModal(this.src); event.stopPropagation();">
                  <button class="learning-image-delete" onclick="deleteLearningImage(${idx}, ${fieldIdx}, ${currentSlide}); event.stopPropagation();">✕</button>
                  ${images.length > 1 ? `<div class="learning-image-counter">${currentSlide + 1} / ${images.length}</div>` : ''}
                </div>
                ${images.length > 1 ? `
                  <button class="learning-image-nav prev" onclick="prevLearningSlide(${idx}, ${fieldIdx}); event.stopPropagation();">‹</button>
                  <button class="learning-image-nav next" onclick="nextLearningSlide(${idx}, ${fieldIdx}); event.stopPropagation();">›</button>
                ` : ''}
              </div>
              ${images.length > 1 ? `
                <div class="learning-image-dots">
                  ${images.map((_, i) => `
                    <div class="learning-image-dot ${i === currentSlide ? 'active' : ''}" onclick="goToLearningSlide(${idx}, ${fieldIdx}, ${i}); event.stopPropagation();"></div>
                  `).join('')}
                </div>
              ` : ''}
            `;
          }

          return `
            <div class="learning-field learning-field-image">
              <div class="learning-field-header">
                <div class="learning-field-num">${fieldIdx + 1}</div>
                <span class="learning-field-icon">${field.icon}</span>
                <input type="text" class="learning-field-title-input"
                       value="${field.title}"
                       onchange="updateFieldTitle(${idx}, ${fieldIdx}, this.value)"
                       onclick="event.stopPropagation()">
                <span class="learning-field-delete" onclick="deleteField(${idx}, ${fieldIdx}); event.stopPropagation();">✕</span>
              </div>
              ${imageContent}
              <div class="learning-image-upload"
                   onclick="triggerLearningImageUpload(${idx}, ${fieldIdx}); event.stopPropagation();"
                   ondragover="handleImageDragOver(event)"
                   ondragleave="handleImageDragLeave(event)"
                   ondrop="handleImageDrop(event, ${idx}, ${fieldIdx})">
                <span class="learning-image-upload-icon">📷</span>
                <span class="learning-image-upload-text">${images.length > 0 ? 'Добавить ещё' : 'Загрузить скриншот или перетащите сюда'}</span>
              </div>
              <input type="file" id="learning-image-input-${idx}-${fieldIdx}" accept="image/*" style="display:none" onchange="handleLearningImageUpload(event, ${idx}, ${fieldIdx})">
            </div>
          `;
        }

        return `
          <div class="learning-field">
            <div class="learning-field-header">
              <div class="learning-field-num">${fieldIdx + 1}</div>
              <span class="learning-field-icon">${field.icon}</span>
              <input type="text" class="learning-field-title-input"
                     value="${field.title}"
                     onchange="updateFieldTitle(${idx}, ${fieldIdx}, this.value)"
                     onclick="event.stopPropagation()">
              <span class="learning-field-delete" onclick="deleteField(${idx}, ${fieldIdx}); event.stopPropagation();">✕</span>
            </div>
            <textarea class="learning-field-textarea"
                      placeholder="Описание..."
                      onchange="updateFieldContent(${idx}, ${fieldIdx}, this.value)"
                      oninput="autoResizeTextarea(this)"
                      onclick="event.stopPropagation()">${field.content || ''}</textarea>
          </div>
        `;
      }).join('');

      return `
        <div class="learning-row" data-row="${rowIdx}">
          <div class="learning-row-header">
            <span class="learning-row-num">Строка ${rowIdx + 1}</span>
            <button class="learning-row-delete" onclick="deleteFieldRow(${idx}, ${rowIdx}); event.stopPropagation();">Удалить строку</button>
          </div>
          <div class="learning-row-fields">
            ${rowFieldsHtml}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="learning-card ${isExpanded ? 'expanded' : ''}"
           onclick="${isExpanded ? '' : `expandTopic(${idx}); event.stopPropagation();`}"
           data-id="${topic.id}"
           data-idx="${idx}"
           draggable="${!isExpanded}"
           ondragstart="handleDragStart(event, ${idx})"
           ondragend="handleDragEnd(event)"
           ondragover="handleDragOver(event)"
           ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event, ${idx})">
        <span class="learning-delete" onclick="deleteTopic(${idx}); event.stopPropagation();">✕</span>
        <div class="learning-header">
          <div class="learning-num ${(topic.progress || 0) >= 100 ? 'max-progress' : (topic.progress || 0) >= 70 ? 'high-progress' : ''}"
               style="--progress: ${topic.progress || 0}">${idx + 1}</div>
          <input type="text" class="learning-title"
                 value="${topic.title}"
                 onchange="updateTopic(${idx}, 'title', this.value)"
                 onclick="event.stopPropagation()">
        </div>
        <div class="learning-desc">${descText}</div>
        <div class="learning-progress-mini">
          <div class="learning-progress-mini-bar">
            <div class="learning-progress-mini-fill" style="width: ${topic.progress || 0}%"></div>
          </div>
          <span class="learning-progress-mini-value">${topic.progress || 0}%</span>
        </div>
        <div class="learning-content">
          <div class="learning-fields">
            ${fieldsHtml}
            <div class="learning-add-field" onclick="addField(${idx}); event.stopPropagation();">
              <span>+</span>
              <span>Добавить строку</span>
            </div>
          </div>

          <div class="learning-progress-section">
            <div class="learning-progress-header">
              <span class="learning-progress-label">Уровень понимания</span>
              <span class="learning-progress-value">${topic.progress || 0}%</span>
            </div>
            <div class="learning-progress-bar">
              <div class="learning-progress-fill" style="width: ${topic.progress || 0}%"></div>
            </div>
            <input type="range" class="learning-progress-slider"
                   min="0" max="100" value="${topic.progress || 0}"
                   onchange="updateTopicProgress(${idx}, this.value)"
                   oninput="this.previousElementSibling.querySelector('.learning-progress-fill').style.width = this.value + '%'; this.parentElement.querySelector('.learning-progress-value').textContent = this.value + '%'"
                   onclick="event.stopPropagation()">
          </div>

          <div class="learning-collapse">
            <button class="learning-collapse-btn" onclick="collapseTopic(); event.stopPropagation();">▲ Свернуть</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  html += `<div class="add-learning-card" onclick="addTopic()">+ Добавить тему</div>`;

  grid.innerHTML = html;

  // Auto-resize textareas after render (with delay for DOM to settle)
  requestAnimationFrame(() => {
    setTimeout(() => {
      grid.querySelectorAll('.learning-field-textarea').forEach(textarea => {
        autoResizeTextarea(textarea);
      });
    }, 50);
  });
}

function addTopic() {
  if (!guardEdit()) return;
  const newTopic = {
    id: Date.now(),
    title: 'Новая тема',
    fields: defaultFieldRow.map(f => ({ ...f })),
    progress: 0
  };
  learningTopics.push(newTopic);
  expandedTopicId = newTopic.id;
  save();
  renderLearning();
}

function updateTopic(idx, field, value) {
  if (!guardEdit()) return;
  learningTopics[idx][field] = value;
  save();
}

function updateTopicProgress(idx, value) {
  if (!guardEdit()) return;
  const progress = parseInt(value);
  learningTopics[idx].progress = progress;
  save();

  const card = document.querySelector(`.learning-card[data-idx="${idx}"]`);
  if (card) {
    // Обновляем мини-бар
    const miniFill = card.querySelector('.learning-progress-mini-fill');
    const miniValue = card.querySelector('.learning-progress-mini-value');
    if (miniFill) miniFill.style.width = progress + '%';
    if (miniValue) miniValue.textContent = progress + '%';

    // Обновляем номер с анимацией
    const numBadge = card.querySelector('.learning-num');
    if (numBadge) {
      numBadge.style.setProperty('--progress', progress);
      numBadge.classList.remove('high-progress', 'max-progress');
      if (progress >= 100) {
        numBadge.classList.add('max-progress');
      } else if (progress >= 70) {
        numBadge.classList.add('high-progress');
      }
    }
  }
}

function addField(topicIdx) {
  if (!guardEdit()) return;
  if (!learningTopics[topicIdx].fields) {
    learningTopics[topicIdx].fields = [];
  }
  // Добавляем сразу 6 блоков (строку с конспектом и файлами)
  const newRow = defaultFieldRow.map(f => ({ ...f }));
  learningTopics[topicIdx].fields.push(...newRow);
  save();
  renderLearning();
}

function updateFieldTitle(topicIdx, fieldIdx, value) {
  if (!guardEdit()) return;
  learningTopics[topicIdx].fields[fieldIdx].title = value;
  save();
}

function updateFieldContent(topicIdx, fieldIdx, value) {
  if (!guardEdit()) return;
  learningTopics[topicIdx].fields[fieldIdx].content = value;
  save();
}

// Auto-resize textarea to fit content
function autoResizeTextarea(el) {
  if (!el) return;
  // Сбрасываем высоту чтобы получить реальный scrollHeight
  el.style.height = '0';
  // Устанавливаем новую высоту (минимум min-height из CSS)
  const minHeight = parseInt(getComputedStyle(el).minHeight) || 44;
  el.style.height = Math.max(el.scrollHeight, minHeight) + 'px';
}

// Initialize all textareas to auto-resize
function initAutoResizeTextareas() {
  document.querySelectorAll('.learning-field-textarea, .strategy-input').forEach(textarea => {
    autoResizeTextarea(textarea);
    textarea.addEventListener('input', function() {
      autoResizeTextarea(this);
    });
  });
}

function deleteField(topicIdx, fieldIdx) {
  if (!guardEdit()) return;
  learningTopics[topicIdx].fields.splice(fieldIdx, 1);
  save();
  renderLearning();
}

function deleteFieldRow(topicIdx, rowIdx) {
  if (!guardEdit()) return;
  const rowSize = 6;
  const startIdx = rowIdx * rowSize;
  learningTopics[topicIdx].fields.splice(startIdx, rowSize);
  save();
  renderLearning();
}

// ============ Learning Image Functions ============
function triggerLearningImageUpload(topicIdx, fieldIdx) {
  if (!guardEdit()) return;
  document.getElementById(`learning-image-input-${topicIdx}-${fieldIdx}`).click();
}

function handleLearningImageUpload(event, topicIdx, fieldIdx) {
  if (!guardEdit()) return;
  const file = event.target.files[0];
  if (!file) return;

  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Файл слишком большой (макс 5MB)');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    compressLearningImage(e.target.result, compressedData => {
      const field = learningTopics[topicIdx].fields[fieldIdx];
      if (!field.images) field.images = [];
      field.images.push(compressedData);
      learningSlideIndex[`${learningTopics[topicIdx].id}_${fieldIdx}`] = field.images.length - 1;
      save();
      renderLearning();
    });
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function compressLearningImage(dataUrl, callback) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const maxWidth = 1200;
    const maxHeight = 800;
    let { width, height } = img;

    if (width > maxWidth || height > maxHeight) {
      const ratio = Math.min(maxWidth / width, maxHeight / height);
      width *= ratio;
      height *= ratio;
    }

    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);
    callback(canvas.toDataURL('image/jpeg', 0.7));
  };
  img.src = dataUrl;
}

function deleteLearningImage(topicIdx, fieldIdx, imgIdx) {
  if (!guardEdit()) return;
  const field = learningTopics[topicIdx].fields[fieldIdx];
  if (field.images) {
    field.images.splice(imgIdx, 1);
    const key = `${learningTopics[topicIdx].id}_${fieldIdx}`;
    if (learningSlideIndex[key] >= field.images.length) {
      learningSlideIndex[key] = Math.max(0, field.images.length - 1);
    }
    save();
    renderLearning();
  }
}

function prevLearningSlide(topicIdx, fieldIdx) {
  const key = `${learningTopics[topicIdx].id}_${fieldIdx}`;
  const images = learningTopics[topicIdx].fields[fieldIdx].images || [];
  if ((learningSlideIndex[key] || 0) > 0) {
    learningSlideIndex[key]--;
    renderLearning();
  }
}

function nextLearningSlide(topicIdx, fieldIdx) {
  const key = `${learningTopics[topicIdx].id}_${fieldIdx}`;
  const images = learningTopics[topicIdx].fields[fieldIdx].images || [];
  if ((learningSlideIndex[key] || 0) < images.length - 1) {
    learningSlideIndex[key] = (learningSlideIndex[key] || 0) + 1;
    renderLearning();
  }
}

function goToLearningSlide(topicIdx, fieldIdx, slideIdx) {
  const key = `${learningTopics[topicIdx].id}_${fieldIdx}`;
  learningSlideIndex[key] = slideIdx;
  renderLearning();
}

// Drag and Drop for images
function handleImageDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleImageDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleImageDrop(event, topicIdx, fieldIdx) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  if (!guardEdit()) return;

  const files = event.dataTransfer.files;
  if (!files || files.length === 0) return;

  const file = files[0];
  if (!file.type.startsWith('image/')) {
    alert('Можно загружать только изображения');
    return;
  }

  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Файл слишком большой (макс 5MB)');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    compressLearningImage(e.target.result, compressedData => {
      const field = learningTopics[topicIdx].fields[fieldIdx];
      if (!field.images) field.images = [];
      field.images.push(compressedData);
      learningSlideIndex[`${learningTopics[topicIdx].id}_${fieldIdx}`] = field.images.length - 1;
      save();
      renderLearning();
    });
  };
  reader.readAsDataURL(file);
}

// ============ Learning File Functions (Файлы/методички) ============
function getFileIcon(mimeType) {
  if (mimeType.includes('pdf')) return '📄';
  if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
  if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return '📊';
  if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return '📽️';
  if (mimeType.includes('image')) return '🖼️';
  if (mimeType.includes('text')) return '📃';
  return '📎';
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function triggerLearningFileUpload(topicIdx, fieldIdx) {
  if (!guardEdit()) return;
  document.getElementById(`learning-file-input-${topicIdx}-${fieldIdx}`).click();
}

function handleLearningFileUpload(event, topicIdx, fieldIdx) {
  if (!guardEdit()) return;
  const file = event.target.files[0];
  if (!file) return;
  processLearningFile(file, topicIdx, fieldIdx);
  event.target.value = '';
}

function processLearningFile(file, topicIdx, fieldIdx) {
  const maxSize = 10 * 1024 * 1024; // 10MB max
  if (file.size > maxSize) {
    alert('Файл слишком большой (макс 10MB)');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const field = learningTopics[topicIdx].fields[fieldIdx];
    if (!field.files) field.files = [];
    field.files.push({
      name: file.name,
      type: file.type,
      size: file.size,
      data: e.target.result
    });
    save();
    renderLearning();
  };
  reader.readAsDataURL(file);
}

function downloadLearningFile(topicIdx, fieldIdx, fileIdx) {
  const field = learningTopics[topicIdx].fields[fieldIdx];
  const file = field.files[fileIdx];
  if (!file) return;

  const link = document.createElement('a');
  link.href = file.data;
  link.download = file.name;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function deleteLearningFile(topicIdx, fieldIdx, fileIdx) {
  if (!guardEdit()) return;
  const field = learningTopics[topicIdx].fields[fieldIdx];
  if (field.files) {
    field.files.splice(fileIdx, 1);
    save();
    renderLearning();
  }
}

// Drag and Drop for files
function handleFileDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleFileDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleFileDrop(event, topicIdx, fieldIdx) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  if (!guardEdit()) return;

  const files = event.dataTransfer.files;
  if (!files || files.length === 0) return;

  // Process each file
  Array.from(files).forEach(file => {
    processLearningFile(file, topicIdx, fieldIdx);
  });
}

// Drag and Drop for topics
let draggedTopicIdx = null;

function handleDragStart(event, idx) {
  draggedTopicIdx = idx;
  event.target.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(event) {
  event.target.classList.remove('dragging');
  document.querySelectorAll('.learning-card').forEach(card => {
    card.classList.remove('drag-over');
  });
  draggedTopicIdx = null;
}

function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  const card = event.target.closest('.learning-card');
  if (card && !card.classList.contains('dragging')) {
    card.classList.add('drag-over');
  }
}

function handleDragLeave(event) {
  const card = event.target.closest('.learning-card');
  if (card) {
    card.classList.remove('drag-over');
  }
}

function handleDrop(event, targetIdx) {
  event.preventDefault();
  const card = event.target.closest('.learning-card');
  if (card) {
    card.classList.remove('drag-over');
  }

  if (draggedTopicIdx === null || draggedTopicIdx === targetIdx) return;

  // Перемещаем элемент
  const [movedTopic] = learningTopics.splice(draggedTopicIdx, 1);
  learningTopics.splice(targetIdx, 0, movedTopic);

  save();
  renderLearning();
}

async function deleteTopic(idx) {
  if (!guardEdit()) return;
  const confirmed = await showConfirm({
    icon: '🗑️',
    title: 'Удалить тему?',
    message: `Тема "${learningTopics[idx].title}" будет удалена.`,
    confirmText: 'Удалить'
  });
  if (confirmed) {
    learningTopics.splice(idx, 1);
    if (expandedTopicId === learningTopics[idx]?.id) {
      expandedTopicId = null;
    }
    save();
    renderLearning();
  }
}

function expandTopic(idx) {
  expandedTopicId = learningTopics[idx].id;
  renderLearning();
}

function collapseTopic() {
  expandedTopicId = null;
  renderLearning();
}

// Сворачивание при клике вне блока
document.addEventListener('click', (e) => {
  if (expandedTopicId === null) return;
  const expandedCard = document.querySelector('.learning-card.expanded');
  if (expandedCard && !expandedCard.contains(e.target)) {
    collapseTopic();
  }
});

function triggerLearningImageUpload(topicIdx) {
  document.getElementById(`learning-image-input-${topicIdx}`).click();
}

function handleLearningImageSelect(topicIdx, input) {
  const file = input.files[0];
  if (!file) return;

  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    alert('Файл слишком большой. Максимум 5MB');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    compressLearningImage(e.target.result, compressedData => {
      learningTopics[topicIdx].chart_image = compressedData;
      save();
      renderLearning();
    });
  };
  reader.readAsDataURL(file);
  input.value = ''; // Reset input
}

function compressLearningImage(dataUrl, callback) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Max dimensions
    const maxWidth = 800;
    const maxHeight = 600;

    let { width, height } = img;

    if (width > maxWidth) {
      height = (height * maxWidth) / width;
      width = maxWidth;
    }
    if (height > maxHeight) {
      width = (width * maxHeight) / height;
      height = maxHeight;
    }

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);

    callback(canvas.toDataURL('image/jpeg', 0.7));
  };
  img.src = dataUrl;
}

async function deleteLearningImage(topicIdx) {
  const confirmed = await showConfirm({
    icon: '🖼️',
    title: 'Удалить изображение?',
    message: 'Скриншот графика будет удалён.',
    confirmText: 'Удалить'
  });
  if (confirmed) {
    learningTopics[topicIdx].chart_image = null;
    save();
    renderLearning();
  }
}

// ============ Strategy ============

// Получить общий P&L для сетапа
function getSetupPnl(setupId) {
  const setupTrades = trades.filter(t => t.setup_id == setupId);
  return setupTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
}

function renderStrategy() {
  if (setups.length === 0) {
    document.getElementById('strategy-tabs').innerHTML = '<span style="color: var(--text-tertiary)">Сначала создай сетапы</span>';
    document.getElementById('strategy-current').innerHTML = '';
    document.getElementById('strategy-flow').innerHTML = '';
    return;
  }

  // Табы с номерами и цветом по профиту
  document.getElementById('strategy-tabs').innerHTML = setups.map((s, i) => {
    const setupPnl = getSetupPnl(s.id);
    const profitClass = setupPnl < 0 ? 'profit-negative' : setupPnl > 50 ? 'profit-positive' : 'profit-neutral';
    return `
      <div class="strategy-tab ${i === currentSetupIdx ? 'active' : ''}" onclick="switchStrategy(${i})">
        <div class="strategy-tab-icon ${profitClass}">${i + 1}</div>
        <span class="strategy-tab-name">${s.name}</span>
      </div>
    `;
  }).join('');

  // Текущий сетап
  const setup = setups[currentSetupIdx];
  const currentPnl = getSetupPnl(setup.id);
  const currentProfitClass = currentPnl < 0 ? 'profit-negative' : currentPnl > 50 ? 'profit-positive' : 'profit-neutral';
  document.getElementById('strategy-current').innerHTML = `
    <div class="strategy-current-icon strategy-tab-icon ${currentProfitClass}" style="width: 44px; height: 44px; font-size: 20px;">
      ${currentSetupIdx + 1}
    </div>
    <div class="strategy-current-info">
      <h4>${setup.name}</h4>
      <span>Опиши алгоритм торговли по этому сетапу</span>
    </div>
  `;

  // Кнопки навигации
  document.getElementById('strategy-prev').disabled = currentSetupIdx === 0;
  document.getElementById('strategy-next').disabled = currentSetupIdx === setups.length - 1;

  // Поля стратегии
  const strat = getStrategy(setup.id);

  // Инициализируем чек-листы если их нет
  if (!strat.checklists) {
    strat.checklists = {};
  }

  const fieldsHtml = strategyFields.map((field, idx) => {
    const items = strat.checklists[field.key] || [];
    const checklistHtml = items.length > 0 ? `
      <div class="strategy-checklist">
        ${items.map((item, itemIdx) => `
          <div class="strategy-checklist-item">
            <span class="check-icon">☑</span>
            <input type="text" value="${item}"
              onchange="updateChecklistItem('${field.key}', ${itemIdx}, this.value)"
              placeholder="Пункт чек-листа...">
            <span class="delete-item" onclick="deleteChecklistItem('${field.key}', ${itemIdx})">✕</span>
          </div>
        `).join('')}
      </div>
    ` : '';

    return `
      <div class="strategy-step">
        <div class="strategy-num">${idx + 1}</div>
        <div class="strategy-step-content">
          <div class="strategy-step-header">
            <span class="strategy-step-icon">${setupIcons[field.icon] || field.icon}</span>
            <span class="strategy-step-title">${field.label}</span>
          </div>
          <textarea class="strategy-input"
            placeholder="${field.placeholder}"
            onchange="updateStrategy('${field.key}', this.value)"
            oninput="autoResizeTextarea(this)"
            onfocus="this.parentElement.parentElement.style.background='rgba(245,158,11,0.03)'"
            onblur="this.parentElement.parentElement.style.background=''"
          >${strat[field.key] || ''}</textarea>
          ${checklistHtml}
          <button class="strategy-add-checklist" onclick="addChecklistItem('${field.key}')">
            + Добавить пункт чек-листа
          </button>
        </div>
      </div>
    `;
  }).join('');

  // Миграция: конвертируем старый формат в массив
  if (strat.chart_pattern_image && !strat.chart_pattern_images) {
    strat.chart_pattern_images = [strat.chart_pattern_image];
    delete strat.chart_pattern_image;
    save();
  }
  if (!strat.chart_pattern_images) {
    strat.chart_pattern_images = [];
  }

  const images = strat.chart_pattern_images;
  const setupId = setup.id;
  if (strategySlideIndex[setupId] === undefined) strategySlideIndex[setupId] = 0;
  const currentSlide = Math.min(strategySlideIndex[setupId], Math.max(0, images.length - 1));
  strategySlideIndex[setupId] = currentSlide;

  let imageHtml = `
    <div class="strategy-image-panel">
      <div class="strategy-image-title">📷 Графическая формация ${images.length > 0 ? `(${images.length})` : ''}</div>
  `;

  // Подготовка HTML для видео записей
  const strat2 = getStrategy(setup.id);
  if (!strat2.videos) strat2.videos = [];

  let videosHtml = `
    <div class="strategy-videos-inline">
      <div class="strategy-videos-header">
        <span class="strategy-videos-title">🎬 ЗАПИСИ СДЕЛОК</span>
        <button class="strategy-videos-add" onclick="addStrategyVideo()">+ Добавить</button>
      </div>
  `;

  if (strat2.videos.length === 0) {
    videosHtml += `<div class="strategy-videos-empty">Добавь записи сделок</div>`;
  } else {
    videosHtml += `<div class="strategy-videos-list">`;
    videosHtml += strat2.videos.map((video, i) => {
      const embedUrl = getYouTubeEmbedUrl(video.url);
      if (embedUrl) {
        // YouTube видео - показываем iframe
        return `
          <div class="strategy-video-card">
            <div class="strategy-video-card-header">
              <span class="strategy-video-name">${video.name || 'Запись ' + (i + 1)}</span>
              <button class="strategy-video-btn delete" onclick="deleteStrategyVideo(${i})">✕</button>
            </div>
            <div class="strategy-video-embed">
              <iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
          </div>
        `;
      } else {
        // Обычная ссылка
        return `
          <div class="strategy-video-item">
            <span class="strategy-video-icon">▶</span>
            <div class="strategy-video-info">
              <div class="strategy-video-name">${video.name || 'Запись ' + (i + 1)}</div>
              <div class="strategy-video-url">${video.url}</div>
            </div>
            <div class="strategy-video-actions">
              <a href="${video.url}" target="_blank" class="strategy-video-btn">Смотреть</a>
              <button class="strategy-video-btn delete" onclick="deleteStrategyVideo(${i})">✕</button>
            </div>
          </div>
        `;
      }
    }).join('');
    videosHtml += `</div>`;
  }
  videosHtml += `</div>`;

  if (images.length > 0) {
    imageHtml += `
      <div class="strategy-image-slider">
        <div class="strategy-image-preview">
          <img src="${images[currentSlide]}" alt="Chart pattern ${currentSlide + 1}" onclick="openImageModal(this.src)">
          <button class="strategy-image-delete" onclick="deleteStrategyImage(${currentSlide})">✕</button>
          ${images.length > 1 ? `<div class="strategy-image-slider-counter">${currentSlide + 1} / ${images.length}</div>` : ''}
        </div>
        ${images.length > 1 ? `
          <button class="strategy-image-slider-nav prev" onclick="prevStrategySlide()">‹</button>
          <button class="strategy-image-slider-nav next" onclick="nextStrategySlide()">›</button>
        ` : ''}
      </div>
      ${images.length > 1 ? `
        <div class="strategy-image-slider-dots">
          ${images.map((_, i) => `
            <div class="strategy-image-slider-dot ${i === currentSlide ? 'active' : ''}" onclick="goToStrategySlide(${i})"></div>
          `).join('')}
        </div>
      ` : ''}
      <div class="strategy-add-more" id="strategy-add-more">
        + Добавить ещё фото (или перетащи сюда)
        <input type="file" id="strategy-image-input" accept="image/*" hidden multiple>
      </div>
      ${videosHtml}
    `;
  } else {
    imageHtml += `
      <div class="strategy-image-upload" id="strategy-image-upload">
        <span class="strategy-image-upload-icon">📷</span>
        <span class="strategy-image-upload-text">Добавить скриншот формации</span>
        <input type="file" id="strategy-image-input" accept="image/*" hidden multiple>
      </div>
      ${videosHtml}
    `;
  }

  imageHtml += `</div>`;

  document.getElementById('strategy-flow').innerHTML = `
    <div class="strategy-layout">
      <div class="strategy-fields">${fieldsHtml}</div>
      <div class="strategy-right-column">
        ${imageHtml}
      </div>
    </div>
  `;

  // Настройка загрузки изображения
  setupStrategyImageUpload();

  // Auto-resize textareas after render
  setTimeout(() => {
    document.querySelectorAll('.strategy-input').forEach(textarea => {
      autoResizeTextarea(textarea);
    });
  }, 0);
}

function switchStrategy(idx) {
  currentSetupIdx = idx;
  renderStrategy();
}

function prevStrategy() {
  if (currentSetupIdx > 0) {
    currentSetupIdx--;
    renderStrategy();
  }
}

function nextStrategy() {
  if (currentSetupIdx < setups.length - 1) {
    currentSetupIdx++;
    renderStrategy();
  }
}

function updateStrategy(key, value) {
  if (!guardEdit()) return;
  const setup = setups[currentSetupIdx];
  if (setup) {
    const strat = getStrategy(setup.id);
    strat[key] = value;
    save();
  }
}

// ============ Strategy Videos ============
// Функция для получения YouTube embed URL
function getYouTubeEmbedUrl(url) {
  if (!url) return null;

  // Паттерны для разных форматов YouTube ссылок
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/
  ];

  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return `https://www.youtube.com/embed/${match[1]}`;
    }
  }

  return null; // Не YouTube ссылка
}

// Проверка, является ли ссылка видео-хостингом
function isVideoUrl(url) {
  if (!url) return false;
  return url.includes('youtube.com') || url.includes('youtu.be') ||
         url.includes('vimeo.com') || url.includes('rutube.ru');
}

async function addStrategyVideo() {
  if (!guardEdit()) return;
  const setup = setups[currentSetupIdx];
  if (!setup) return;

  const url = await showInputModal({
    icon: '🎬',
    title: 'Добавить запись сделки',
    message: 'Ссылка на видео',
    placeholder: 'https://youtube.com/watch?v=...',
    buttonText: 'Добавить'
  });

  if (!url || !url.trim()) return;

  const name = await showInputModal({
    icon: '📝',
    title: 'Название записи',
    message: 'Краткое описание (опционально)',
    placeholder: 'Например: Пробой BTC 15.01',
    buttonText: 'Сохранить'
  });

  const strat = getStrategy(setup.id);
  if (!strat.videos) strat.videos = [];

  strat.videos.push({
    url: url.trim(),
    name: name ? name.trim() : '',
    date: new Date().toISOString().slice(0, 10)
  });

  save();
  renderStrategy();
}

async function deleteStrategyVideo(idx) {
  if (!guardEdit()) return;

  const confirmed = await showConfirm({
    icon: '🗑️',
    title: 'Удалить запись?',
    message: 'Ссылка на видео будет удалена'
  });

  if (!confirmed) return;

  const setup = setups[currentSetupIdx];
  if (!setup) return;

  const strat = getStrategy(setup.id);
  if (strat.videos) {
    strat.videos.splice(idx, 1);
    save();
    renderStrategy();
  }
}

// Функции управления чек-листом стратегии
async function addChecklistItem(fieldKey) {
  if (!guardEdit()) return;
  const setup = setups[currentSetupIdx];
  if (!setup) return;

  const field = strategyFields.find(f => f.key === fieldKey);
  const fieldLabel = field ? field.label : 'пункт';

  const newItem = await showInputModal({
    icon: '☑️',
    title: `Новый пункт чек-листа`,
    message: `${field?.icon || ''} ${fieldLabel}`,
    placeholder: 'Например: Объём > 50M',
    buttonText: 'Добавить'
  });

  if (newItem && newItem.trim()) {
    const strat = getStrategy(setup.id);
    if (!strat.checklists) strat.checklists = {};
    if (!strat.checklists[fieldKey]) strat.checklists[fieldKey] = [];

    strat.checklists[fieldKey].push(newItem.trim());
    save();
    renderStrategy();
  }
}

function updateChecklistItem(fieldKey, itemIdx, value) {
  if (!guardEdit()) return;
  const setup = setups[currentSetupIdx];
  if (!setup) return;

  const strat = getStrategy(setup.id);
  if (strat.checklists && strat.checklists[fieldKey]) {
    strat.checklists[fieldKey][itemIdx] = value;
    save();
  }
}

function deleteChecklistItem(fieldKey, itemIdx) {
  if (!guardEdit()) return;
  const setup = setups[currentSetupIdx];
  if (!setup) return;

  const strat = getStrategy(setup.id);
  if (strat.checklists && strat.checklists[fieldKey]) {
    strat.checklists[fieldKey].splice(itemIdx, 1);
    save();
    renderStrategy();
  }
}

// Получить все пункты чек-листа для сетапа
function getSetupChecklistItems(setupId) {
  const strat = getStrategy(setupId);
  const allItems = [];

  strategyFields.forEach(field => {
    const items = (strat.checklists && strat.checklists[field.key]) || [];
    items.forEach((item, idx) => {
      allItems.push({
        fieldKey: field.key,
        fieldLabel: field.label,
        fieldIcon: field.icon,
        itemIdx: idx,
        text: item
      });
    });
  });

  return allItems;
}

function setupStrategyImageUpload() {
  const uploadZone = document.getElementById('strategy-image-upload');
  const addMoreZone = document.getElementById('strategy-add-more');
  const imageInput = document.getElementById('strategy-image-input');

  if (!imageInput) return;

  // Настройка для пустой зоны загрузки
  if (uploadZone) {
    uploadZone.onclick = () => imageInput.click();
    setupDropZone(uploadZone);
  }

  // Настройка для кнопки "Добавить ещё"
  if (addMoreZone) {
    addMoreZone.onclick = () => imageInput.click();
    setupDropZone(addMoreZone);
  }

  imageInput.onchange = e => {
    const files = e.target.files;
    for (let file of files) {
      if (file) handleStrategyImage(file);
    }
    imageInput.value = '';
  };
}

function setupDropZone(element) {
  element.ondragover = e => {
    e.preventDefault();
    element.classList.add('dragover');
  };

  element.ondragleave = () => {
    element.classList.remove('dragover');
  };

  element.ondrop = e => {
    e.preventDefault();
    element.classList.remove('dragover');
    const files = e.dataTransfer.files;
    for (let file of files) {
      if (file.type.startsWith('image/')) {
        handleStrategyImage(file);
      }
    }
  };
}

function handleStrategyImage(file) {
  if (!guardEdit()) return;
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Файл слишком большой (макс 5MB)');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    compressStrategyImage(e.target.result, compressedData => {
      const setup = setups[currentSetupIdx];
      if (!setup) return;
      const strat = getStrategy(setup.id);
      if (!strat.chart_pattern_images) strat.chart_pattern_images = [];
      strat.chart_pattern_images.push(compressedData);
      strategySlideIndex[setup.id] = strat.chart_pattern_images.length - 1;
      save();
      renderStrategy();
    });
  };
  reader.readAsDataURL(file);
}

// Навигация по слайдеру
function prevStrategySlide() {
  const setup = setups[currentSetupIdx];
  if (!setup) return;
  const images = getStrategy(setup.id).chart_pattern_images || [];
  if (strategySlideIndex[setup.id] > 0) {
    strategySlideIndex[setup.id]--;
    renderStrategy();
  }
}

function nextStrategySlide() {
  const setup = setups[currentSetupIdx];
  if (!setup) return;
  const images = getStrategy(setup.id).chart_pattern_images || [];
  if (strategySlideIndex[setup.id] < images.length - 1) {
    strategySlideIndex[setup.id]++;
    renderStrategy();
  }
}

function goToStrategySlide(idx) {
  const setup = setups[currentSetupIdx];
  if (!setup) return;
  strategySlideIndex[setup.id] = idx;
  renderStrategy();
}

function compressStrategyImage(dataUrl, callback) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const maxWidth = 800;
    const maxHeight = 600;
    let { width, height } = img;

    if (width > maxWidth) {
      height = (height * maxWidth) / width;
      width = maxWidth;
    }
    if (height > maxHeight) {
      width = (width * maxHeight) / height;
      height = maxHeight;
    }

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);
    callback(canvas.toDataURL('image/jpeg', 0.8));
  };
  img.src = dataUrl;
}

async function deleteStrategyImage(idx) {
  if (!guardEdit()) return;
  const confirmed = await showConfirm({
    icon: '🖼️',
    title: 'Удалить изображение?',
    message: 'Скриншот формации будет удалён.',
    confirmText: 'Удалить'
  });
  if (!confirmed) return;

  const setup = setups[currentSetupIdx];
  if (!setup) return;
  const strat = getStrategy(setup.id);
  if (strat.chart_pattern_images && strat.chart_pattern_images.length > idx) {
    strat.chart_pattern_images.splice(idx, 1);
    // Корректируем индекс слайдера
    if (strategySlideIndex[setup.id] >= strat.chart_pattern_images.length) {
      strategySlideIndex[setup.id] = Math.max(0, strat.chart_pattern_images.length - 1);
    }
  }
  save();
  renderStrategy();
}

function openImageModal(imageSrc) {
  const modal = document.getElementById('image-modal');
  const modalImg = document.getElementById('modal-image');
  modalImg.src = imageSrc;
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeImageModal() {
  const modal = document.getElementById('image-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

// Close modal on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeImageModal();
    closeConfirm(false);
    closeInputModal(null);
  }
});

// ============ Custom Confirm Modal ============
let confirmCallback = null;

function showConfirm(options) {
  return new Promise(resolve => {
    const modal = document.getElementById('confirm-modal');
    const icon = document.getElementById('modal-icon');
    const title = document.getElementById('modal-title');
    const message = document.getElementById('modal-message');
    const confirmBtn = document.getElementById('modal-confirm-btn');

    icon.textContent = options.icon || '⚠️';
    title.textContent = options.title || 'Подтверждение';
    message.textContent = options.message || 'Вы уверены?';
    confirmBtn.textContent = options.confirmText || 'OK';

    confirmBtn.className = 'modal-btn modal-btn-confirm';
    if (options.type === 'success') confirmBtn.classList.add('success');

    // Сбрасываем класс закрытия если был
    modal.classList.remove('closing');

    confirmCallback = resolve;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  });
}

function closeConfirm(result) {
  const modal = document.getElementById('confirm-modal');
  // Добавляем анимацию закрытия
  modal.classList.add('closing');
  setTimeout(() => {
    modal.classList.remove('active', 'closing');
    document.body.style.overflow = '';
    if (confirmCallback) {
      confirmCallback(result);
      confirmCallback = null;
    }
  }, 200);
}

// ============ Custom Input Modal ============
let inputCallback = null;

function showInputModal(options) {
  return new Promise(resolve => {
    const modal = document.getElementById('input-modal');
    const icon = document.getElementById('input-modal-icon');
    const title = document.getElementById('input-modal-title');
    const message = document.getElementById('input-modal-message');
    const input = document.getElementById('input-modal-field');
    const btn = document.getElementById('input-modal-btn');

    icon.textContent = options.icon || '☑️';
    title.textContent = options.title || 'Введите значение';
    message.textContent = options.message || 'Введите текст:';
    btn.textContent = options.buttonText || 'Добавить';
    input.value = options.defaultValue || '';
    input.placeholder = options.placeholder || 'Введите текст...';

    // Сбрасываем класс закрытия если был
    modal.classList.remove('closing');

    inputCallback = resolve;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Фокус на поле ввода с задержкой для анимации
    setTimeout(() => input.focus(), 300);
  });
}

function closeInputModal(result) {
  const modal = document.getElementById('input-modal');
  // Добавляем анимацию закрытия
  modal.classList.add('closing');
  setTimeout(() => {
    modal.classList.remove('active', 'closing');
    document.body.style.overflow = '';
    if (inputCallback) {
      inputCallback(result);
      inputCallback = null;
    }
  }, 200);
}

function submitInputModal() {
  const input = document.getElementById('input-modal-field');
  const value = input.value.trim();
  closeInputModal(value || null);
}

// Клавиши для модального окна (Enter - отправить, Escape - закрыть)
document.addEventListener('keydown', e => {
  const inputModal = document.getElementById('input-modal');
  if (inputModal.classList.contains('active') && !inputModal.classList.contains('closing')) {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitInputModal();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      closeInputModal(null);
    }
  }
});

// ============ Trades ============
function renderTrades() {
  const list = document.getElementById('trades-list');
  if (!trades.length) {
    list.innerHTML = `
      <div class="empty-trades">
        <div class="empty-trades-icon">📊</div>
        <div class="empty-trades-text">Загрузи CSV файл чтобы увидеть сделки</div>
      </div>
    `;
    return;
  }

  // Фильтруем сделки, сохраняя оригинальные индексы
  const tradesWithIndex = trades.map((t, i) => ({ ...t, originalIndex: i }));
  const filteredTrades = filterSetupId
    ? tradesWithIndex.filter(t => t.setup_id == filterSetupId)
    : tradesWithIndex;

  if (filteredTrades.length === 0) {
    list.innerHTML = `
      <div class="empty-trades">
        <div class="empty-trades-icon">🔍</div>
        <div class="empty-trades-text">Нет сделок по этому сетапу</div>
      </div>
    `;
    return;
  }

  list.innerHTML = filteredTrades.map(t => {
    const i = t.originalIndex;
    const isLoss = t.pnl < 0;
    const pnlClass = t.pnl >= 0 ? 'positive' : 'negative';
    const pnlStr = t.pnl >= 0 ? `+${t.pnl.toFixed(2)}$` : `${t.pnl.toFixed(2)}$`;
    const tradeBadge = isLoss
      ? `<span class="trade-badge maketa-badge">負け MAKETA!</span>`
      : `<span class="trade-badge kate-badge">勝て KATE!</span>`;
    return `
      <div class="trade-card ${isLoss ? 'loss' : ''}">
        <div class="trade-header">
          <span class="trade-pair">${t.pair}</span>
          ${tradeBadge}
          <span class="trade-date">${t.date || '—'}</span>
          <span class="trade-pnl ${pnlClass}">${pnlStr}</span>
        </div>
        <div class="trade-setup-row">
          <span class="trade-setup-label">Сетап:</span>
          <select class="trade-setup-select" onchange="updateTrade(${i}, 'setup_id', this.value)">
            <option value="">Выбери сетап...</option>
            ${setups.map(s => `<option value="${s.id}" ${t.setup_id == s.id ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('')}
          </select>
          <button class="trade-setup-reset" onclick="resetTradeSetup(${i})" title="Сбросить сетап">✕</button>
        </div>
        <div class="trade-notes">
          <div class="trade-note-field">
            <label class="trade-note-label"><span>🎯</span> Установка на сделку</label>
            <textarea class="trade-note-input"
              placeholder="Почему вошёл? Что видел на графике? Какой был план?"
              onchange="updateTrade(${i}, 'setup_note', this.value)"
            >${t.setup_note || ''}</textarea>
          </div>
          <div class="trade-note-field">
            <label class="trade-note-label"><span>🧠</span> Ментальное состояние</label>
            <textarea class="trade-note-input"
              placeholder="Что чувствовал? Была ли спешка? FOMO? Жадность? Страх?"
              onchange="updateTrade(${i}, 'mental_note', this.value)"
            >${t.mental_note || ''}</textarea>
          </div>
        </div>
        ${renderTradeChecklist(t, i)}
        <div class="trade-video-field">
          <div class="trade-video-row">
            <span class="trade-video-icon">🎬</span>
            <input type="text" class="trade-video-input"
              placeholder="Ссылка на запись сделки..."
              value="${t.video_link || ''}"
              onchange="updateTrade(${i}, 'video_link', this.value)">
            <a href="${t.video_link || '#'}" target="_blank"
               class="trade-video-btn ${!t.video_link ? 'disabled' : ''}"
               onclick="if(!trades[${i}].video_link) event.preventDefault();">
              ▶ Смотреть
            </a>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Чек-лист для сделки - использует динамические пункты из стратегии
function renderTradeChecklist(trade, idx) {
  // Если у сделки нет сетапа - не показываем чек-лист
  if (!trade.setup_id) {
    return `
      <div class="trade-checklist">
        <div class="trade-checklist-header">
          <span class="trade-checklist-label" style="color: var(--text-tertiary)">
            Выбери сетап чтобы появился чек-лист
          </span>
        </div>
      </div>
    `;
  }

  // Получаем пункты чек-листа из стратегии
  const items = getSetupChecklistItems(trade.setup_id);

  if (items.length === 0) {
    return `
      <div class="trade-checklist">
        <div class="trade-checklist-header">
          <span class="trade-checklist-label" style="color: var(--text-tertiary)">
            Добавь пункты чек-листа в стратегию "${setups.find(s => s.id == trade.setup_id)?.name || ''}"
          </span>
        </div>
      </div>
    `;
  }

  // Инициализируем checklist если его нет
  if (!trade.checklist) {
    trade.checklist = {};
  }

  const checked = items.filter(item => trade.checklist[`${item.fieldKey}_${item.itemIdx}`]).length;
  const total = items.length;

  // Группируем по полям
  const grouped = {};
  items.forEach(item => {
    if (!grouped[item.fieldKey]) {
      grouped[item.fieldKey] = {
        label: item.fieldLabel,
        icon: item.fieldIcon,
        items: []
      };
    }
    grouped[item.fieldKey].items.push(item);
  });

  // Рендерим сгруппированный компактный чек-лист
  const groupsHtml = Object.entries(grouped).map(([fieldKey, group]) => {
    const chipsHtml = group.items.map(item => {
      const key = `${item.fieldKey}_${item.itemIdx}`;
      const isChecked = trade.checklist[key];
      return `
        <button class="checklist-chip ${isChecked ? '' : 'unchecked'}"
                onclick="toggleChecklistItem(${idx}, '${key}')">
          <span class="chip-icon">${isChecked ? '✓' : '○'}</span>
          <span>${item.text}</span>
        </button>
      `;
    }).join('');

    return `
      <div class="checklist-group" data-field="${fieldKey}">
        <div class="checklist-group-header">
          <span class="checklist-group-icon">${setupIcons[group.icon] || group.icon}</span>
          <span class="checklist-group-title">${group.label}</span>
        </div>
        <div class="checklist-group-chips">${chipsHtml}</div>
      </div>
    `;
  }).join('');

  return `
    <div class="trade-checklist">
      <div class="trade-checklist-header">
        <span class="trade-checklist-label">Чек-лист:</span>
        <span class="trade-checklist-score">${checked}/${total}</span>
      </div>
      <div class="trade-checklist-groups">${groupsHtml}</div>
    </div>
  `;
}

function toggleChecklistItem(idx, key) {
  if (!guardEdit()) return;

  // Инициализируем checklist если его нет
  if (!trades[idx].checklist) {
    trades[idx].checklist = {};
  }

  trades[idx].checklist[key] = !trades[idx].checklist[key];
  save();
  renderTrades();
  renderChecklistStats();
}

function renderChecklistStats() {
  const container = document.getElementById('checklist-stats');

  // Показываем статистику только при фильтре по стратегии
  if (!filterSetupId) {
    container.innerHTML = '';
    return;
  }

  const filteredTrades = trades.filter(t => t.setup_id == filterSetupId);
  if (filteredTrades.length === 0) {
    container.innerHTML = '';
    return;
  }

  const setup = setups.find(s => s.id == filterSetupId);
  const setupName = setup ? setup.name : 'Стратегия';

  // Получаем динамические пункты чек-листа из стратегии
  const items = getSetupChecklistItems(filterSetupId);

  if (items.length === 0) {
    container.innerHTML = `
      <div class="checklist-stats-panel">
        <div class="checklist-stats-header">
          <span class="checklist-stats-title">${setupName} — ${filteredTrades.length} сделок</span>
        </div>
        <div style="color: var(--text-tertiary); font-size: 12px; padding: 12px 0;">
          Добавь пункты чек-листа в стратегию чтобы увидеть статистику
        </div>
      </div>
    `;
    return;
  }

  // Считаем статистику по каждому пункту чек-листа
  const stats = items.map(item => {
    const key = `${item.fieldKey}_${item.itemIdx}`;
    const checked = filteredTrades.filter(t => t.checklist && t.checklist[key]).length;
    const pct = Math.round((checked / filteredTrades.length) * 100);
    return { ...item, key, checked, total: filteredTrades.length, pct };
  });

  // Средний процент выполнения
  const avgPct = Math.round(stats.reduce((sum, s) => sum + s.pct, 0) / stats.length);

  // Находим самый слабый пункт
  const weakest = stats.reduce((min, s) => s.pct < min.pct ? s : min, stats[0]);

  const getPctClass = (pct) => {
    if (pct >= 80) return 'high';
    if (pct >= 60) return 'medium';
    return 'low';
  };

  container.innerHTML = `
    <div class="checklist-stats-panel">
      <div class="checklist-stats-header">
        <span class="checklist-stats-title">${setupName} — ${filteredTrades.length} сделок</span>
        <span class="checklist-stats-avg">Средний: ${avgPct}%</span>
      </div>
      <div class="checklist-stats-list">
        ${stats.map(s => `
          <div class="checklist-stat-item">
            <div class="checklist-stat-head">
              <span class="checklist-stat-name">${setupIcons[s.fieldIcon] || s.fieldIcon} ${s.text}</span>
              <span class="checklist-stat-pct ${getPctClass(s.pct)}">${s.pct}%</span>
            </div>
            <div class="checklist-stat-bar">
              <div class="checklist-stat-fill ${getPctClass(s.pct)}" style="width: ${s.pct}%"></div>
            </div>
          </div>
        `).join('')}
      </div>
      ${weakest.pct < 70 ? `
        <div class="checklist-insight">
          <div class="checklist-insight-head">
            <span>⚠️</span>
            <span class="checklist-insight-title">Требует внимания</span>
          </div>
          <div class="checklist-insight-text">
            «${weakest.text}» выполняется только в ${weakest.pct}% случаев.
            Рекомендуется уделить больше внимания этому пункту при торговле по стратегии «${setupName}».
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function updateTrade(idx, field, value) {
  if (!guardEdit()) return;
  trades[idx][field] = value;
  save();
  if (field === 'setup_id') {
    renderTrades(); // Пере-рендерим для обновления чек-листа
    renderStats();
    renderSetups(); // Обновляем статистику в карточках
    renderChecklistStats();
  }
}

function resetTradeSetup(idx) {
  if (!guardEdit()) return;
  trades[idx].setup_id = null;
  save();
  renderTrades();
  renderStats();
  renderSetups(); // Обновляем статистику в карточках
}

async function clearTrades() {
  if (!guardEdit()) return;
  const confirmed = await showConfirm({
    icon: '🗑️',
    title: 'Удалить все сделки?',
    message: 'Это действие нельзя отменить. Все данные о сделках будут удалены.',
    confirmText: 'Удалить всё'
  });
  if (confirmed) {
    trades = [];
    save();
    renderTrades();
    renderStats();
    renderSetups(); // Обновляем статистику в карточках
  }
}

function renderStats() {
  // Фильтруем сделки по выбранному сетапу
  const filteredTrades = filterSetupId
    ? trades.filter(t => t.setup_id == filterSetupId)
    : trades;

  const total = filteredTrades.length;
  const wins = filteredTrades.filter(t => t.pnl > 0).length;
  const totalPnl = filteredTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
  const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;

  document.getElementById('stat-total').textContent = total || '—';
  document.getElementById('stat-winrate').textContent = total > 0 ? `${winRate}%` : '—%';

  const pnlEl = document.getElementById('stat-pnl');
  pnlEl.textContent = total > 0 ? `${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)}$` : '—$';
  pnlEl.className = `stat-value ${totalPnl >= 0 ? 'success' : 'danger'}`;

  // Статистика по сетапам (всегда по всем сделкам для отображения счётчиков)
  const bySetup = setups.map(s => {
    const setupTrades = trades.filter(t => t.setup_id == s.id);
    return { ...s, count: setupTrades.length, pnl: setupTrades.reduce((sum, t) => sum + (t.pnl || 0), 0) };
  });

  // Лучшая стратегия (по фильтру или по всем)
  const best = filterSetupId
    ? setups.find(s => s.id == filterSetupId)
    : bySetup.reduce((b, c) => c.pnl > (b?.pnl || -Infinity) ? c : b, null);
  document.getElementById('stat-best').textContent = best?.count > 0 || filterSetupId ? best?.name || '—' : '—';

  // Разделяем сетапы на основные (>=10 сделок) и скрытые (<10)
  const mainSetups = bySetup.filter(s => s.count >= 10);
  const hiddenSetups = bySetup.filter(s => s.count < 10 && s.count > 0);
  const emptySetups = bySetup.filter(s => s.count === 0);

  // Бейджи основных сетапов
  let badgesHtml = mainSetups.map(s => `
    <div class="strat-badge ${filterSetupId == s.id ? 'active' : ''}"
         style="background: ${s.color}15; ${filterSetupId == s.id ? 'border-color: ' + s.color : ''}"
         onclick="filterBySetup(${s.id})">
      <span class="strat-dot" style="background: ${s.color}"></span>
      <span>${s.name}: ${s.count}</span>
    </div>
  `).join('');

  // Скрытые сетапы (показываем если включено)
  if (showAllSetups && hiddenSetups.length > 0) {
    badgesHtml += hiddenSetups.map(s => `
      <div class="strat-badge ${filterSetupId == s.id ? 'active' : ''}"
           style="background: ${s.color}15; ${filterSetupId == s.id ? 'border-color: ' + s.color : ''}; opacity: 0.7;"
           onclick="filterBySetup(${s.id})">
        <span class="strat-dot" style="background: ${s.color}"></span>
        <span>${s.name}: ${s.count}</span>
      </div>
    `).join('');
  }

  // Кнопка показать/скрыть остальные
  if (hiddenSetups.length > 0) {
    const hiddenCount = hiddenSetups.length + emptySetups.length;
    if (showAllSetups) {
      badgesHtml += `<button class="strat-toggle" onclick="toggleShowAllSetups()">▲ Скрыть (${hiddenCount})</button>`;
    } else {
      badgesHtml += `<button class="strat-toggle" onclick="toggleShowAllSetups()">▼ Ещё ${hiddenCount}</button>`;
    }
  }

  // Кнопка сброса фильтра
  if (filterSetupId) {
    badgesHtml += `<button class="strat-clear" onclick="clearFilter()">✕ Сбросить</button>`;
  }

  document.getElementById('strat-badges').innerHTML = badgesHtml;
}

function filterBySetup(setupId) {
  // Если кликнули на уже активный — сбрасываем
  if (filterSetupId == setupId) {
    filterSetupId = null;
  } else {
    filterSetupId = setupId;
  }
  renderStats();
  renderTrades();
  renderChecklistStats();
}

function clearFilter() {
  filterSetupId = null;
  renderStats();
  renderTrades();
  renderChecklistStats();
}

function toggleShowAllSetups() {
  showAllSetups = !showAllSetups;
  renderSetups();
  renderStats();
}

// ============ Rules ============
function renderRules() {
  document.getElementById('rules-do').innerHTML = rulesDo.map((r, i) => `
    <li class="rule-item"><span>•</span><input type="text" value="${r}" onchange="updateRule('do', ${i}, this.value)" onclick="this.select()"><span class="rule-delete" onclick="deleteRule('do', ${i})">✕</span></li>
  `).join('');
  document.getElementById('rules-dont').innerHTML = rulesDont.map((r, i) => `
    <li class="rule-item"><span>•</span><input type="text" value="${r}" onchange="updateRule('dont', ${i}, this.value)" onclick="this.select()"><span class="rule-delete" onclick="deleteRule('dont', ${i})">✕</span></li>
  `).join('');
}

function updateRule(type, idx, value) {
  if (!guardEdit()) return;
  if (type === 'do') rulesDo[idx] = value;
  else rulesDont[idx] = value;
  save();
}

function addRule(type) {
  if (!guardEdit()) return;
  const text = prompt('Новое правило:');
  if (text) {
    if (type === 'do') rulesDo.push(text);
    else rulesDont.push(text);
    save();
    renderRules();
  }
}

function deleteRule(type, idx) {
  if (!guardEdit()) return;
  if (type === 'do') rulesDo.splice(idx, 1);
  else rulesDont.splice(idx, 1);
  save();
  renderRules();
}

// ============ Profit Levels ============
let currentDeposit = storage.get('current_deposit', 0);

function renderProfitLevels() {
  // Сортируем уровни по возрастанию
  const sortedLevels = [...profitLevels].sort((a, b) => a.profit - b.profit);
  const maxProfit = sortedLevels.length > 0 ? sortedLevels[sortedLevels.length - 1].profit : 200;

  document.getElementById('current-deposit').value = currentDeposit || '';

  document.getElementById('profit-levels').innerHTML = sortedLevels.map((l, i) => {
    const idx = profitLevels.indexOf(l);
    const progress = Math.min((currentDeposit / l.profit) * 100, 100);
    const isReached = currentDeposit >= l.profit;
    const isLocked = currentDeposit < l.lock && currentDeposit > 0 && i > 0 && currentDeposit >= sortedLevels[i-1]?.profit;
    const barWidth = (l.profit / maxProfit) * 100;

    return `
      <div class="profit-bar-row ${isReached ? 'reached' : ''} ${isLocked ? 'locked' : ''}" data-idx="${idx}">
        <span class="profit-bar-label" onclick="editProfitLevel(${idx})" title="Клик для редактирования">$${l.profit}</span>
        <div class="profit-bar-track">
          <div class="profit-bar-fill ${isReached ? 'reached' : ''}" style="width: ${isReached ? 100 : progress}%"></div>
        </div>
        <span class="profit-bar-lock" onclick="editProfitLevel(${idx})" title="Клик для редактирования">→ $${l.lock}</span>
        ${isReached ? '<span class="profit-bar-check">✓</span>' : '<span class="profit-bar-delete" onclick="deleteProfitLevel(' + idx + ')">✕</span>'}
      </div>
    `;
  }).join('');

  updateDepositStatus();
}

function updateProfitBars() {
  if (!guardEdit()) return;
  currentDeposit = parseFloat(document.getElementById('current-deposit').value) || 0;
  storage.set('current_deposit', currentDeposit);
  renderProfitLevels();
}

function updateDepositStatus() {
  const statusEl = document.getElementById('deposit-status');
  const sortedLevels = [...profitLevels].sort((a, b) => a.profit - b.profit);

  // Найти текущую активную планку
  let currentLock = 0;
  let statusText = 'Торгуй';
  let statusClass = 'safe';

  for (let i = sortedLevels.length - 1; i >= 0; i--) {
    if (currentDeposit >= sortedLevels[i].profit) {
      currentLock = sortedLevels[i].lock;
      break;
    }
  }

  if (currentDeposit <= 0) {
    statusText = 'Торгуй';
    statusClass = 'safe';
  } else if (currentLock > 0 && currentDeposit <= currentLock) {
    statusText = '⛔ СТОП';
    statusClass = 'danger';
  } else if (currentLock > 0 && currentDeposit <= currentLock * 1.1) {
    statusText = '⚠️ Осторожно';
    statusClass = 'warning';
  } else if (currentDeposit > 0) {
    // Найти следующую цель
    const nextTarget = sortedLevels.find(l => l.profit > currentDeposit);
    if (nextTarget) {
      statusText = `Цель: $${nextTarget.profit}`;
    } else {
      statusText = '🏆 Максимум!';
    }
    statusClass = 'safe';
  }

  statusEl.textContent = statusText;
  statusEl.className = `deposit-status ${statusClass}`;
}

function updateProfitLevel(idx, field, value) {
  if (!guardEdit()) return;
  profitLevels[idx][field] = parseFloat(value) || 0;
  save();
  renderProfitLevels();
}

function addProfitLevel() {
  if (!guardEdit()) return;
  const last = profitLevels[profitLevels.length - 1] || { profit: 0, lock: 0 };
  profitLevels.push({ profit: last.profit + 50, lock: Math.round((last.profit + 50) * 0.8) });
  save();
  renderProfitLevels();
}

async function deleteProfitLevel(idx) {
  if (!guardEdit()) return;
  const confirmed = await showConfirm({
    icon: '📊',
    title: 'Удалить планку?',
    message: 'Этот уровень профита будет удалён.',
    confirmText: 'Удалить'
  });
  if (confirmed) {
    profitLevels.splice(idx, 1);
    save();
    renderProfitLevels();
  }
}

function editProfitLevel(idx) {
  if (!guardEdit()) return;
  const level = profitLevels[idx];
  const newProfit = prompt('Профит ($):', level.profit);
  if (newProfit !== null) {
    const profit = parseFloat(newProfit) || level.profit;
    const newLock = prompt('Планка ($):', level.lock);
    if (newLock !== null) {
      profitLevels[idx].profit = profit;
      profitLevels[idx].lock = parseFloat(newLock) || level.lock;
      save();
      renderProfitLevels();
    }
  }
}

// ============ Tips ============
function renderTips() {
  document.getElementById('market-tips').innerHTML = tips.map((t, i) => `
    <li class="tip-item"><input type="text" value="${t}" onchange="updateTip(${i}, this.value)" onclick="this.select()"><span class="tip-delete" onclick="deleteTip(${i})">✕</span></li>
  `).join('');
}

function updateTip(idx, value) {
  if (!guardEdit()) return;
  tips[idx] = value;
  save();
}

function addTip() {
  if (!guardEdit()) return;
  const t = prompt('Новая фишка:');
  if (t) {
    tips.push(t);
    save();
    renderTips();
  }
}

function deleteTip(idx) {
  if (!guardEdit()) return;
  tips.splice(idx, 1);
  save();
  renderTips();
}

// ============ Mental ============
function renderMental() {
  document.getElementById('mental-wrong').value = storage.get('mental_wrong', defaultMentalWrong);
  document.getElementById('mental-right').value = storage.get('mental_right', defaultMentalRight);
  document.getElementById('correction-text').value = storage.get('correction', defaultCorrection);

  // Загружаем заголовок (KATE logo - статичный)
  const logoEl = document.getElementById('logo-text');
  const titleEl = document.getElementById('system-title');
  if (logoEl) logoEl.textContent = storage.get('logo_text', 'ТС');
  if (titleEl) titleEl.textContent = storage.get('system_title', 'Торговая Система');
}

function saveLogo() {
  if (!guardEdit()) return;
  const el = document.getElementById('logo-text');
  if (el) storage.set('logo_text', el.textContent.trim() || 'ТС');
}

function saveTitle() {
  if (!guardEdit()) return;
  const el = document.getElementById('system-title');
  if (el) storage.set('system_title', el.textContent.trim() || 'Торговая Система');
}



// ============ Events ============
function setupEvents() {
  // CSV Upload
  const dropZone = document.getElementById('drop-zone');
  const csvInput = document.getElementById('csv-input');

  dropZone.onclick = () => csvInput.click();
  dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
  dropZone.ondragleave = () => dropZone.classList.remove('dragover');
  dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files[0]) parseCSV(e.dataTransfer.files[0]); };
  csvInput.onchange = e => { if (e.target.files[0]) parseCSV(e.target.files[0]); };

  // Mental texts
  document.getElementById('mental-wrong').onchange = function() { if (guardEdit()) storage.set('mental_wrong', this.value); };
  document.getElementById('mental-right').onchange = function() { if (guardEdit()) storage.set('mental_right', this.value); };
  document.getElementById('correction-text').onchange = function() { if (guardEdit()) storage.set('correction', this.value); };
}

// ============ CSV Parser ============
function parseCSV(file) {
  if (!guardEdit()) return;
  const reader = new FileReader();
  reader.onload = e => {
    // Убираем BOM и нормализуем переносы строк
    let text = e.target.result.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return alert('Пустой CSV');

    // Автодетект разделителя (запятая, точка с запятой, табуляция)
    const firstLine = lines[0];
    let delimiter = ',';
    if (firstLine.split(';').length > firstLine.split(',').length) delimiter = ';';
    if (firstLine.split('\t').length > firstLine.split(delimiter).length) delimiter = '\t';

    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
    console.log('CSV Headers:', headers);
    console.log('Delimiter:', delimiter === '\t' ? 'TAB' : delimiter);

    // Расширенный поиск колонок
    const dateIdx = headers.findIndex(h =>
      h.includes('date') || h.includes('время') || h.includes('time') || h.includes('дата') || h === 'dt'
    );
    const pairIdx = headers.findIndex(h =>
      h.includes('pair') || h.includes('symbol') || h.includes('пара') || h.includes('актив') ||
      h.includes('ticker') || h.includes('instrument') || h.includes('coin') || h.includes('contract')
    );
    const pnlIdx = headers.findIndex(h =>
      h.includes('pnl') || h.includes('profit') || h.includes('прибыль') || h.includes('realized') ||
      h.includes('p&l') || h.includes('результат') || h.includes('доход') || h.includes('closed')
    );
    // Колонка с сетапами
    const setupIdx = headers.findIndex(h =>
      h.includes('entry reason') || h.includes('setup') || h.includes('strategy') ||
      h.includes('сетап') || h.includes('стратегия') || h.includes('pattern') || h.includes('reason')
    );

    console.log('Found columns - Date:', dateIdx, 'Pair:', pairIdx, 'PNL:', pnlIdx, 'Setup:', setupIdx);

    if (pnlIdx === -1) {
      alert('Не найдена колонка PNL/Profit.\n\nНайденные колонки:\n' + headers.join(', '));
      return;
    }

    // Для создания новых сетапов
    const newSetupColors = ['#EF4444', '#22C55E', '#F59E0B', '#8B5CF6', '#3B82F6', '#EC4899', '#14B8A6', '#F97316'];
    const newSetupIcons = ['⚡', '↗', '◣', '〰', '◆', '★', '●', '▲'];
    let createdSetups = 0;

    let imported = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(delimiter).map(c => c.trim().replace(/"/g, ''));

      // Парсим PNL с поддержкой разных форматов чисел
      let pnlStr = cols[pnlIdx] || '0';
      // Убираем пробелы, знаки валют, заменяем запятую на точку если нужно
      pnlStr = pnlStr.replace(/[\s$€₽USDT]/gi, '');
      // Если формат "1.234,56" (европейский) - конвертируем
      if (pnlStr.match(/\d+\.\d{3},\d+/)) {
        pnlStr = pnlStr.replace(/\./g, '').replace(',', '.');
      } else {
        pnlStr = pnlStr.replace(',', '.');
      }
      const pnl = parseFloat(pnlStr) || 0;

      const pair = pairIdx >= 0 ? cols[pairIdx] : 'Unknown';
      const date = dateIdx >= 0 ? cols[dateIdx].slice(0, 10) : '';

      // Обработка сетапа из CSV
      let setup_id = null;
      if (setupIdx >= 0) {
        const setupName = cols[setupIdx]?.trim();
        if (setupName) {
          // Ищем существующий сетап по имени (без учёта регистра)
          let existingSetup = setups.find(s => s.name.toLowerCase() === setupName.toLowerCase());

          if (!existingSetup) {
            // Создаём новый сетап
            const newId = Math.max(...setups.map(s => s.id), 0) + 1;
            const colorIdx = setups.length % newSetupColors.length;
            const iconIdx = setups.length % newSetupIcons.length;
            existingSetup = {
              id: newId,
              name: setupName,
              description: 'Импортирован из CSV',
              color: newSetupColors[colorIdx],
              icon: newSetupIcons[iconIdx]
            };
            setups.push(existingSetup);
            createdSetups++;
            console.log('Created new setup:', setupName);
          }
          setup_id = existingSetup.id;
        }
      }

      if (pair || pnl !== 0) {
        trades.push({ date, pair, pnl, setup_id, setup_note: '', mental_note: '' });
        imported++;
      }
    }

    console.log('Imported trades:', imported);
    console.log('Sample trade:', trades[trades.length - 1]);

    save();
    renderTrades();
    renderStats();
    renderSetups(); // Обновляем статистику в карточках
    renderStrategy(); // Обновляем слайдер стратегий

    let msg = `Импортировано ${imported} сделок!`;
    if (createdSetups > 0) {
      msg += `\nСоздано новых сетапов: ${createdSetups}`;
    }
    if (setupIdx === -1) {
      msg += `\n\n⚠️ Колонка с сетапами не найдена. Ищу: entry reasons, setup, strategy...`;
    }
    alert(msg);
  };
  reader.readAsText(file);
}

// Load Google Fonts asynchronously after page renders
setTimeout(function() {
  var link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@300;500;700&display=swap';
  document.head.appendChild(link);
}, 100);
</script>
</body>
</html>
